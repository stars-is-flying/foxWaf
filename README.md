# WAF åå‘ä»£ç†å®‰å…¨ç½‘å…³

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å¼€å‘çš„é«˜æ€§èƒ½ Web åº”ç”¨é˜²ç«å¢™ï¼ˆWAFï¼‰å’Œåå‘ä»£ç†ç³»ç»Ÿï¼Œé›†æˆäº†å®‰å…¨é˜²æŠ¤ã€è®¿é—®æ§åˆ¶ã€ç¼“å­˜åŠ é€Ÿå’Œç«™ç‚¹ç®¡ç†ç­‰åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ”’ å®‰å…¨é˜²æŠ¤
- **æ™ºèƒ½ WAF é˜²æŠ¤**ï¼šåŸºäºè§„åˆ™å¼•æ“çš„ Web æ”»å‡»æ£€æµ‹å’Œæ‹¦æˆª
- **å¤šç»´åº¦æ£€æµ‹**ï¼šæ”¯æŒ URIã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ã€å‚æ•°å€¼ã€è¡¨å•å€¼ç­‰å¤šä½ç½®æ£€æµ‹
- **ç¼–ç è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«å’Œè§£ç  Base64ã€URL ç¼–ç çš„æ”»å‡»è½½è·
- **å®æ—¶æ‹¦æˆª**ï¼šå¯¹ SQL æ³¨å…¥ã€XSSã€è·¯å¾„éå†ç­‰æ”»å‡»è¿›è¡Œå®æ—¶é˜»æ–­

### ğŸŒ åå‘ä»£ç†
- **å¤šç«™ç‚¹æ”¯æŒ**ï¼šæ”¯æŒåŸºäºåŸŸåçš„å¤šç«™ç‚¹åå‘ä»£ç†
- **HTTPS æ”¯æŒ**ï¼šè‡ªåŠ¨ç”Ÿæˆå’Œç®¡ç† SSL/TLS è¯ä¹¦
- **è´Ÿè½½å‡è¡¡**ï¼šå†…ç½®è¿æ¥æ± å’Œè¶…æ—¶æ§åˆ¶
- **åè®®è½¬æ¢**ï¼šæ”¯æŒ HTTP/HTTPS åè®®è½¬æ¢

### ğŸ›¡ï¸ è®¿é—®æ§åˆ¶ (ACL)
- **çµæ´»è§„åˆ™**ï¼šæ”¯æŒå…¨å±€å’ŒåŸºäºåŸŸåçš„è®¿é—®æ§åˆ¶è§„åˆ™
- **å¤šç§åŒ¹é…**ï¼šIP åœ°å€ã€ç”¨æˆ·ä»£ç†ã€Refererã€è·¯å¾„ç­‰å¤šç§åŒ¹é…æ¡ä»¶
- **å®æ—¶ç”Ÿæ•ˆ**ï¼šè§„åˆ™æ·»åŠ åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡

### âš¡ æ€§èƒ½ä¼˜åŒ–
- **é™æ€ç¼“å­˜**ï¼šæ™ºèƒ½é™æ€æ–‡ä»¶ç¼“å­˜ï¼Œå¤§å¹…æå‡è®¿é—®é€Ÿåº¦
- **å†…å­˜ä¼˜åŒ–**ï¼šé«˜æ•ˆçš„å†…å­˜ç®¡ç†å’Œå¹¶å‘æ§åˆ¶
- **è¿æ¥å¤ç”¨**ï¼šHTTP è¿æ¥æ± å’Œ Keep-Alive æ”¯æŒ

### ğŸ› ï¸ ç®¡ç†åŠŸèƒ½
- **Web ç®¡ç†ç•Œé¢**ï¼šåŸºäº Gin æ¡†æ¶çš„ç°ä»£åŒ–ç®¡ç†ç•Œé¢
- **JWT è®¤è¯**ï¼šå®‰å…¨çš„ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†
- **å®æ—¶ç»Ÿè®¡**ï¼šè¯·æ±‚é‡ã€æ‹¦æˆªç‡ã€ç¼“å­˜å‘½ä¸­ç‡ç­‰å®æ—¶ç›‘æ§
- **ç«™ç‚¹ç®¡ç†**ï¼šåŠ¨æ€æ·»åŠ å’Œç®¡ç†åå‘ä»£ç†ç«™ç‚¹

## ç³»ç»Ÿæ¶æ„

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
ACL è®¿é—®æ§åˆ¶æ£€æŸ¥
    â†“
WAF å®‰å…¨æ£€æµ‹
    â†“
é™æ€ç¼“å­˜æ£€æŸ¥
    â†“
åå‘ä»£ç†è½¬å‘
    â†“
ç›®æ ‡æœåŠ¡å™¨
```

## å¿«é€Ÿå¼€å§‹

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone git@github.com:stars-is-flying/wafMax.git
cd wafMax
```

2. **é…ç½®æ•°æ®åº“**
```sql
CREATE DATABASE waf_proxy;
```

3. **ä¿®æ”¹é…ç½®æ–‡ä»¶**
åˆ›å»º `conf.json` æ–‡ä»¶ï¼š
```json
{
  "server": {
    "addr": "0.0.0.0",
    "port": 8080
  },
  "database": {
    "host": "localhost",
    "port": 3306,
    "user": "root",
    "password": "your_password",
    "dbname": "waf_proxy"
  },
  "isWriteDbAuto": true,
  "secureentry": "admin"
}
```

4. **å‡†å¤‡è§„åˆ™æ–‡ä»¶**
åœ¨ `rule_updated/` ç›®å½•ä¸‹æ”¾ç½® WAF è§„åˆ™æ–‡ä»¶ï¼ˆJSON æ ¼å¼ï¼‰ã€‚

5. **å‡†å¤‡é™æ€æ–‡ä»¶**
åœ¨ `static/` ç›®å½•ä¸‹æ”¾ç½®ç®¡ç†ç•Œé¢æ‰€éœ€çš„ HTML æ–‡ä»¶ï¼š
- `login.html` - ç™»å½•é¡µé¢
- `loginError.html` - ç™»å½•é”™è¯¯é¡µé¢  
- `panle.html` - ç®¡ç†é¢æ¿
- `404.html` - 404 é¡µé¢
- `waf/` - WAF æ‹¦æˆªé¡µé¢

6. **è¿è¡Œé¡¹ç›®**
```bash
go mod tidy
go run main.go
```

### é»˜è®¤è´¦æˆ·

å¯åŠ¨åæ§åˆ¶å°ä¼šæ˜¾ç¤ºé»˜è®¤çš„ç®¡ç†å‘˜è´¦æˆ·å’Œå¯†ç ï¼š
```
------------------------è´¦æˆ·ä¿¡æ¯---------------------------
è´¦æˆ·å¯†ç ä¸º: fox:éšæœºå¯†ç 
-----------------------------------------------------------
```

è®¿é—® `http://your-server:8080/admin` ä½¿ç”¨é»˜è®¤è´¦æˆ·ç™»å½•ç®¡ç†ç•Œé¢ã€‚

## é…ç½®è¯´æ˜

### ä¸»é…ç½®æ–‡ä»¶ (conf.json)

```json
{
  "server": {
    "addr": "ç›‘å¬åœ°å€",
    "port": ç›‘å¬ç«¯å£
  },
  "database": {
    "host": "æ•°æ®åº“ä¸»æœº",
    "port": æ•°æ®åº“ç«¯å£,
    "user": "æ•°æ®åº“ç”¨æˆ·", 
    "password": "æ•°æ®åº“å¯†ç ",
    "dbname": "æ•°æ®åº“å"
  },
  "isWriteDbAuto": "æ˜¯å¦è‡ªåŠ¨å†™å…¥æ”»å‡»æ—¥å¿—",
  "secureentry": "ç®¡ç†ç•Œé¢å…¥å£è·¯å¾„"
}
```

### WAF è§„åˆ™é…ç½®

è§„åˆ™æ–‡ä»¶æ”¾ç½®åœ¨ `rule_updated/` ç›®å½•ä¸‹ï¼Œæ”¯æŒ JSON æ ¼å¼ï¼š

```json
{
  "name": "SQLæ³¨å…¥æ£€æµ‹",
  "description": "æ£€æµ‹SQLæ³¨å…¥æ”»å‡»",
  "id": "sql-injection-001",
  "method": "any",
  "relation": "or",
  "judge": [
    {
      "position": "uri",
      "content": "union select",
      "rix": "(?i)union\\\\s+select"
    }
  ]
}
```

### ACL è§„åˆ™ç±»å‹

- **type**: `global`ï¼ˆå…¨å±€ï¼‰æˆ– `host`ï¼ˆåŸŸåç‰¹å®šï¼‰
- **rule_type**: `ip`, `user_agent`, `referer`, `path`, `country`
- **action**: `allow`ï¼ˆå…è®¸ï¼‰æˆ– `block`ï¼ˆé˜»æ­¢ï¼‰



## éƒ¨ç½²è¯´æ˜

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **ç¼–è¯‘é¡¹ç›®**
```bash
go build -o wafMax waf.go
```

2. **ä½¿ç”¨ systemd ç®¡ç†æœåŠ¡**
åˆ›å»º `/etc/systemd/system/waf-proxy.service`ï¼š
```ini
[Unit]
Description=WAF Reverse Proxy
After=network.target

[Service]
Type=simple
User=www
WorkingDirectory=/path/to/waf-proxy
ExecStart=/path/to/waf-proxy/waf-proxy
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

3. **å¯åŠ¨æœåŠ¡**
```bash
systemctl daemon-reload
systemctl enable waf-proxy
systemctl start waf-proxy
```

### Docker éƒ¨ç½²

```dockerfile
FROM golang:1.19-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o waf-proxy main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/waf-proxy .
COPY static ./static
COPY rule_updated ./rule_updated
COPY conf.json .
EXPOSE 80 443 8080
CMD ["./waf-proxy"]
```

## æ€§èƒ½è°ƒä¼˜

### ç¼“å­˜é…ç½®
```go
staticCacheConfig = StaticCacheConfig{
    Enable:          true,
    CacheDir:        "./static_cache", 
    MaxCacheSize:    100 * 1024 * 1024, // 100MB
    DefaultExpire:   24 * time.Hour,
    CleanupInterval: 1 * time.Hour,
}
```

### æ•°æ®åº“è¿æ¥æ± 
```go
db.SetMaxOpenConns(20)
db.SetMaxIdleConns(10)
db.SetConnMaxLifetime(time.Minute * 5)
```

## ç›‘æ§å’Œç»´æŠ¤


### æ€§èƒ½ç›‘æ§
è®¿é—®ç®¡ç†ç•Œé¢çš„ç»Ÿè®¡é¡µé¢æŸ¥çœ‹ï¼š
- æ€»è¯·æ±‚æ•°
- æ‹¦æˆªè¯·æ±‚æ•°  
- ç¼“å­˜å‘½ä¸­ç‡
- è§„åˆ™æ•°é‡
- ç«™ç‚¹æ•°é‡

### æ•°æ®åº“ç»´æŠ¤
å®šæœŸæ¸…ç†æ”»å‡»æ—¥å¿—ï¼š
```sql
DELETE FROM attacks WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¯ä¹¦åŠ è½½å¤±è´¥**
   - æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ ¼å¼
   - éªŒè¯ç§é’¥åŒ¹é…
   - æ£€æŸ¥æ–‡ä»¶æƒé™

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - éªŒè¯æ•°æ®åº“é…ç½®
   - æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
   - ç¡®è®¤ç”¨æˆ·æƒé™

3. **è§„åˆ™ä¸ç”Ÿæ•ˆ**
   - æ£€æŸ¥è§„åˆ™æ–‡ä»¶æ ¼å¼
   - éªŒè¯æ­£åˆ™è¡¨è¾¾å¼
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—



## å®‰å…¨å»ºè®®

1. **å®šæœŸæ›´æ–°è§„åˆ™**ï¼šåŠæ—¶æ›´æ–° WAF è§„åˆ™ä»¥åº”å¯¹æ–°å¨èƒ
2. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥æ”»å‡»æ—¥å¿—å’Œå®‰å…¨äº‹ä»¶
3. **æƒé™æ§åˆ¶**ï¼šä¸¥æ ¼ç®¡ç†ç®¡ç†å‘˜è´¦æˆ·æƒé™
4. **ç½‘ç»œéš”ç¦»**ï¼šå°† WAF éƒ¨ç½²åœ¨ DMZ åŒºåŸŸ
5. **è¯ä¹¦ç®¡ç†**ï¼šå®šæœŸæ›´æ–° SSL/TLS è¯ä¹¦

## è®¸å¯è¯

[åœ¨æ­¤æ·»åŠ é¡¹ç›®è®¸å¯è¯ä¿¡æ¯]

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## è”ç³»æ–¹å¼

- é‚®ç®±ï¼š[211310412@mail.dhu.edu.cn]

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªç”¨äºå­¦ä¹ å’Œç ”ç©¶ç›®çš„çš„é¡¹ç›®ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å‰è¯·è¿›è¡Œå……åˆ†æµ‹è¯•å’Œå®‰å…¨è¯„ä¼°
