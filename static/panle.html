<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞èÁãêÁã∏ÊéßÂà∂Âè∞</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶ä</text></svg>">
    
    <!-- Prism.js ËØ≠Ê≥ïÈ´ò‰∫ÆÂ∫ì -->
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script> -->

    <link href="prism-tomorrow.min.css" rel="stylesheet" />
    <link href="prism-line-numbers.min.css" rel="stylesheet" />
    <script src="prism-core.min.js"></script>
    <script src="prism-autoloader.min.js"></script>
    <script src="prism-line-numbers.min.js"></script>
    <script src="prism-copy-to-clipboard.min.js"></script>
    <script>
        // Âú®È°µÈù¢Âä†ËΩΩÂâçÁ´ãÂç≥Â∫îÁî®‰∏ªÈ¢òÔºåÈÅøÂÖçÈó™ÁÉÅ
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-theme');
                document.body.classList.add('dark-theme');
            }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #c8f5f5 0%, #a8e6e6 25%, #88d7d7 50%, #68c8c8 75%, #48b9b9 100%);
            font-family: "Comic Sans MS", "Microsoft YaHei", sans-serif;
            color: #444;
            min-height: 100vh;
            display: flex;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ‰æßËæπÊ†èÊ†∑Âºè */
        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, #dceafe, #c8e0fa);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-header .fox {
            font-size: 60px;
            margin-bottom: 10px;
            animation: bounce 0.8s infinite alternate;
        }

        .sidebar-header h1 {
            color: #5210ed;
            font-size: 20px;
            background: linear-gradient(45deg, #5210ed, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            padding: 15px 25px;
            margin: 5px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #666;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateX(5px);
            color: #5210ed;
        }

        .nav-item.active {
            background: linear-gradient(45deg, #110d77, #5210ed);
            color: white;
            box-shadow: 0 4px 15px rgba(82, 16, 237, 0.3);
        }

        .nav-item .icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .nav-item .text {
            font-size: 16px;
            font-weight: 500;
        }

        /* ‰∏ªÂÜÖÂÆπÂå∫Ê†∑Âºè */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            min-height: 100vh;
        }

        .content-header {
            background: linear-gradient(145deg, #dceafe, #c8e0fa);
            padding: 25px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .content-header h2 {
            color: #5210ed;
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #5210ed, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .content-body {
            background: linear-gradient(145deg, #dceafe, #c8e0fa);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            min-height: 500px;
        }

        /* Âä®ÁîªÊïàÊûú */
        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-5px);
            }
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar-header h1,
            .nav-item .text {
                display: none;
            }

            .main-content {
                margin-left: 70px;
            }
        }

        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .metric-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
        }

        .metric-card.small {
            padding: 20px;
            text-align: center;
            justify-content: center;
        }
        
        /* Á´ôÁÇπË°åËÉåÊôØÈ¢úËâ≤ */
        .row-alive {
            background-color: rgba(76, 175, 80, 0.15);
            transition: background-color 0.5s ease;
        }
        .row-alive:hover {
            background-color: rgba(76, 175, 80, 0.25);
        }
        .row-dead {
            background-color: rgba(244, 67, 54, 0.15);
            transition: background-color 0.5s ease;
        }
        .row-dead:hover {
            background-color: rgba(244, 67, 54, 0.25);
        }
        
        /* Êìç‰ΩúÊåâÈíÆÂÆπÂô® */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .metric-icon {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            border-radius: 12px;
            color: white;
        }

        .metric-content {
            flex: 1;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #5210ed;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .refresh-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(82, 16, 237, 0.3);
        }

        .refresh-icon {
            font-size: 16px;
        }

        .last-update {
            font-size: 14px;
            color: #666;
        }

        /* Ë°®Ê†ºÊ†∑Âºè */
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        th {
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: rgba(82, 16, 237, 0.05);
        }

        /* Ë°®ÂçïÊ†∑Âºè */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #5210ed;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(82, 16, 237, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        /* ‰øÆÂ§çÊªëÂä®Êù°Âú®EdgeÂíåChrome‰∏≠ÁöÑËæπÁïåÈóÆÈ¢ò - ÂèØ‰ª•ÊªëÂä®Âà∞ÊúÄÂ∑¶ÂíåÊúÄÂè≥ */
        input[type="range"].range-slider,
        input[type="range"].form-control {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(82, 16, 237, 0.1);
            outline: none;
            padding: 0;
            margin: 10px 0;
            cursor: pointer;
        }
        
        /* Webkit (Chrome, Safari, Edge) ÊªëÂä®Êù°ËΩ®ÈÅì - Âç†Êª°Êï¥‰∏™ÂÆΩÂ∫¶ */
        input[type="range"].range-slider::-webkit-slider-runnable-track,
        input[type="range"].form-control::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(82, 16, 237, 0.2);
        }
        
        /* Webkit ÊªëÂä®Êù°ÊªëÂùó - ÂèØ‰ª•ÊªëÂä®Âà∞ËΩ®ÈÅìÁöÑÊúÄËæπÁºò */
        input[type="range"].range-slider::-webkit-slider-thumb,
        input[type="range"].form-control::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(82, 16, 237, 0.3);
            margin-top: -6px;
        }
        
        input[type="range"].range-slider::-webkit-slider-thumb:hover,
        input[type="range"].form-control::-webkit-slider-thumb:hover {
            background: linear-gradient(135deg, #6d28d9, #9d71f6);
            box-shadow: 0 4px 12px rgba(82, 16, 237, 0.5);
            transform: scale(1.1);
        }
        
        /* Firefox ÊªëÂä®Êù°ËΩ®ÈÅì - Âç†Êª°Êï¥‰∏™ÂÆΩÂ∫¶ */
        input[type="range"].range-slider::-moz-range-track,
        input[type="range"].form-control::-moz-range-track {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(82, 16, 237, 0.2);
            border: none;
        }
        
        /* Firefox ÊªëÂä®Êù°ÊªëÂùó - ÂèØ‰ª•ÊªëÂä®Âà∞ËΩ®ÈÅìÁöÑÊúÄËæπÁºò */
        input[type="range"].range-slider::-moz-range-thumb,
        input[type="range"].form-control::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(82, 16, 237, 0.3);
        }
        
        input[type="range"].range-slider::-moz-range-thumb:hover,
        input[type="range"].form-control::-moz-range-thumb:hover {
            background: linear-gradient(135deg, #6d28d9, #9d71f6);
            box-shadow: 0 4px 12px rgba(82, 16, 237, 0.5);
            transform: scale(1.1);
        }
        
        /* Firefox ÁßªÈô§ÁÑ¶ÁÇπËΩÆÂªì */
        input[type="range"].range-slider::-moz-focus-outer,
        input[type="range"].form-control::-moz-focus-outer {
            border: 0;
        }
        
        /* Á°Æ‰øùÊôÆÈÄöËæìÂÖ•Ê°Ü‰∏çÂèóÂΩ±Âìç */
        input[type="text"].form-control,
        input[type="number"].form-control,
        input[type="email"].form-control,
        input[type="password"].form-control,
        textarea.form-control,
        select.form-control {
            padding: 12px 15px;
        }

        .form-control:focus {
            outline: none;
            border-color: #5210ed;
            box-shadow: 0 0 0 3px rgba(82, 16, 237, 0.1);
        }
        
        /* ÊªëÂä®Êù°ÁÑ¶ÁÇπÊ†∑Âºè */
        input[type="range"].range-slider:focus,
        input[type="range"].form-control:focus {
            outline: none;
        }
        
        input[type="range"].range-slider:focus::-webkit-slider-thumb,
        input[type="range"].form-control:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 4px rgba(82, 16, 237, 0.2), 0 2px 8px rgba(82, 16, 237, 0.3);
        }
        
        input[type="range"].range-slider:focus::-moz-range-thumb,
        input[type="range"].form-control:focus::-moz-range-thumb {
            box-shadow: 0 0 0 4px rgba(82, 16, 237, 0.2), 0 2px 8px rgba(82, 16, 237, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(82, 16, 237, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ed573, #7bed9f);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a4b0be, #747d8c);
        }

        /* Âç°ÁâáÊ†∑Âºè */
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #5210ed;
        }

        /* Ê†áÁ≠æÈ°µÊ†∑Âºè */
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom-color: #5210ed;
            color: #5210ed;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Áä∂ÊÄÅÊåáÁ§∫Âô® */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        .status-inactive {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .metric-row {
                grid-template-columns: 1fr;
            }
            
            .refresh-section {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .table-container {
                overflow-x: auto;
            }
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ê∂àÊÅØÊèêÁ§∫ */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
            border: 1px solid rgba(46, 213, 115, 0.3);
        }

        .alert-error {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        /* ToastÈÄöÁü•ÂÆπÂô® - Â∑¶‰∏ãËßí */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        /* ToastÈÄöÁü•È°π */
        .toast {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto;
            animation: slideInLeft 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .toast:hover {
            transform: translateX(5px);
        }

        .toast-success {
            background: linear-gradient(135deg, #2ed573 0%, #26d07c 100%);
            color: white;
            border-left: 4px solid #1fb85a;
        }

        .toast-error {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: white;
            border-left: 4px solid #ee2d3d;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            word-break: break-word;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-20px);
            }
        }

        /* ÊöóÈªë‰∏ªÈ¢ò‰∏ãÁöÑtoastÊ†∑Âºè */
        body.dark-theme .toast-success {
            background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
            color: white;
            border-left: 4px solid #56d364;
        }

        body.dark-theme .toast-error {
            background: linear-gradient(135deg, #da3633 0%, #f85149 100%);
            color: white;
            border-left: 4px solid #ff6b6b;
        }

        /* ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ */
        .theme-toggle-btn {
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(82, 16, 237, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0;
        }

        .theme-toggle-btn:hover {
            background: rgba(82, 16, 237, 0.1);
            border-color: rgba(82, 16, 237, 0.5);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(82, 16, 237, 0.2);
        }

        .theme-toggle-btn:active {
            transform: scale(0.95);
        }

        /* ÊöóÈªë‰∏ªÈ¢òÊ†∑Âºè */
        body.dark-theme {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 25%, #1c2128 50%, #22272e 75%, #2d333b 100%);
            color: #adbac7;
        }

        body.dark-theme .sidebar {
            background: linear-gradient(145deg, #161b22, #1c2128);
            border-right: 1px solid rgba(108, 117, 125, 0.2);
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.5);
        }

        body.dark-theme .sidebar-header {
            background: linear-gradient(145deg, #1c2128, #22272e);
            border-bottom: 1px solid rgba(108, 117, 125, 0.15);
        }

        body.dark-theme .sidebar-header h1 {
            color: #58a6ff;
            background: linear-gradient(45deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.dark-theme .nav-item {
            color: #adbac7;
        }

        body.dark-theme .nav-item:hover {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            transform: translateX(5px);
        }

        body.dark-theme .nav-item.active {
            background: linear-gradient(145deg, #1f6feb, #58a6ff);
            color: #fff;
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.3);
        }

        body.dark-theme .main-content {
            background: transparent;
        }

        body.dark-theme .content-header {
            background: linear-gradient(145deg, #1c2128, #22272e);
            border: 1px solid rgba(108, 117, 125, 0.2);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        body.dark-theme .content-header h2 {
            color: #58a6ff;
            background: linear-gradient(45deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.dark-theme .content-header p {
            color: #768390;
        }

        body.dark-theme .content-body {
            background: linear-gradient(145deg, #161b22, #1c2128);
            border: 1px solid rgba(108, 117, 125, 0.2);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        body.dark-theme .card {
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid rgba(108, 117, 125, 0.25);
            color: #adbac7;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        body.dark-theme .card-header {
            background: rgba(28, 33, 40, 0.95);
            border-bottom: 1px solid rgba(108, 117, 125, 0.25);
        }

        body.dark-theme .card-title {
            color: #58a6ff;
        }

        body.dark-theme .btn {
            background: linear-gradient(145deg, #1f6feb, #58a6ff);
            color: #fff;
            border: 1px solid rgba(88, 166, 255, 0.3);
            box-shadow: 0 2px 8px rgba(88, 166, 255, 0.2);
        }

        body.dark-theme .btn:hover {
            background: linear-gradient(145deg, #388bfd, #79c0ff);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
            transform: translateY(-1px);
        }

        body.dark-theme .btn-secondary {
            background: rgba(48, 54, 61, 0.8);
            color: #adbac7;
            border: 1px solid rgba(108, 117, 125, 0.3);
        }

        body.dark-theme .btn-secondary:hover {
            background: rgba(55, 62, 70, 0.9);
            border-color: rgba(108, 117, 125, 0.5);
        }

        body.dark-theme .btn-danger {
            background: linear-gradient(145deg, #da3633, #f85149);
            color: #fff;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        body.dark-theme .btn-danger:hover {
            background: linear-gradient(145deg, #f85149, #ff6b6b);
            box-shadow: 0 4px 12px rgba(248, 81, 73, 0.3);
        }

        body.dark-theme .btn-success {
            background: linear-gradient(145deg, #238636, #2ea043);
            color: #fff;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }

        body.dark-theme .btn-success:hover {
            background: linear-gradient(145deg, #2ea043, #3fb950);
            box-shadow: 0 4px 12px rgba(46, 160, 67, 0.3);
        }

        body.dark-theme .metric-card {
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid rgba(108, 117, 125, 0.25);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        body.dark-theme .metric-card:hover {
            border-color: rgba(88, 166, 255, 0.4);
            box-shadow: 0 6px 16px rgba(88, 166, 255, 0.2);
        }

        body.dark-theme .metric-value {
            color: #58a6ff;
        }

        body.dark-theme .metric-label {
            color: #768390;
        }

        body.dark-theme .form-control,
        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid rgba(108, 117, 125, 0.3);
            color: #adbac7;
        }

        body.dark-theme .form-control:focus,
        body.dark-theme input:focus,
        body.dark-theme select:focus,
        body.dark-theme textarea:focus {
            border-color: #58a6ff;
            background: rgba(28, 33, 40, 0.95);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
            outline: none;
        }

        body.dark-theme .modal {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
        }

        body.dark-theme .modal-content {
            background: linear-gradient(145deg, #1c2128, #22272e);
            border: 1px solid rgba(108, 117, 125, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        body.dark-theme .modal-header {
            background: rgba(28, 33, 40, 0.95);
            border-bottom: 1px solid rgba(108, 117, 125, 0.25);
        }

        body.dark-theme .modal-title {
            color: #58a6ff;
        }

        body.dark-theme .close-modal {
            color: #adbac7;
        }

        body.dark-theme .close-modal:hover {
            color: #58a6ff;
        }

        body.dark-theme .code-container {
            background: rgba(13, 17, 23, 0.95);
            border: 1px solid rgba(108, 117, 125, 0.25);
        }

        body.dark-theme .alert-success {
            background: rgba(33, 134, 54, 0.2);
            color: #56d364;
            border: 1px solid rgba(46, 160, 67, 0.4);
        }

        body.dark-theme .alert-error {
            background: rgba(218, 54, 51, 0.2);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.4);
        }

        body.dark-theme .theme-toggle-btn {
            background: rgba(48, 54, 61, 0.8);
            border-color: rgba(108, 117, 125, 0.4);
        }

        body.dark-theme .theme-toggle-btn:hover {
            background: rgba(55, 62, 70, 0.9);
            border-color: rgba(88, 166, 255, 0.5);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.2);
        }

        body.dark-theme table {
            background: rgba(22, 27, 34, 0.95);
            color: #adbac7;
            border: 1px solid rgba(108, 117, 125, 0.25);
        }

        body.dark-theme table th {
            background: rgba(28, 33, 40, 0.95);
            color: #58a6ff;
            border-bottom: 1px solid rgba(108, 117, 125, 0.3);
        }

        body.dark-theme table td {
            border-bottom: 1px solid rgba(108, 117, 125, 0.15);
        }

        body.dark-theme table tr:hover {
            background: rgba(88, 166, 255, 0.08);
        }

        body.dark-theme .table-container {
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid rgba(108, 117, 125, 0.25);
        }

        body.dark-theme .loading {
            color: #768390;
        }

        body.dark-theme h3,
        body.dark-theme h4,
        body.dark-theme h5 {
            color: #58a6ff;
        }

        body.dark-theme p {
            color: #768390;
        }

        body.dark-theme .status-indicator {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        body.dark-theme .status-active {
            background: rgba(33, 134, 54, 0.2);
            color: #56d364;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }

        body.dark-theme .status-inactive {
            background: rgba(218, 54, 51, 0.2);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        body.dark-theme .chart-container {
            background: rgba(13, 17, 23, 0.95);
            border: 1px solid rgba(108, 117, 125, 0.25);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            color: #adbac7;
        }

        body.dark-theme .chart-title {
            color: #58a6ff;
        }

        body.dark-theme .dashboard-charts {
            color: #adbac7;
        }

        /* Ê®°ÊÄÅÊ°Ü */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #5210ed;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* ÂàÜÈ°µÊ†∑Âºè */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid rgba(82, 16, 237, 0.2);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn.active {
            background: #5210ed;
            color: white;
        }

        .page-btn:hover:not(.active) {
            background: rgba(82, 16, 237, 0.1);
        }
        /* Âú®Áé∞ÊúâÁöÑCSS‰∏≠Ê∑ªÂä†‰ª•‰∏ãÊ†∑Âºè */
        .status-indicator.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .status-indicator.clickable:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .status-indicator.clickable:active {
            transform: scale(0.95);
        }

        /* Âú®Áé∞ÊúâÁöÑCSS‰∏≠Ê∑ªÂä† */
.code-block {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    border: 1px solid #e9ecef;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-section h4 {
    color: #5210ed;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid #5210ed;
}
/* Âú®Áé∞ÊúâÁöÑCSS‰∏≠Ê∑ªÂä†‰ª•‰∏ãÊ†∑Âºè */
.http-request {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.4;
    font-size: 13px;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 10px;
}

.http-request-line {
    color: #d63384;
    font-weight: bold;
}

.http-header {
    color: #0d6efd;
}

.http-body {
    color: #198754;
    margin-top: 10px;
}

.copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    padding: 5px 10px;
    font-size: 12px;
    background: rgba(82, 16, 237, 0.1);
    border: 1px solid rgba(82, 16, 237, 0.2);
}

.copy-btn:hover {
    background: rgba(82, 16, 237, 0.2);
}

/* Âú®Áé∞ÊúâÁöÑCSS‰∏≠Ê∑ªÂä†‰ª•‰∏ãÊ†∑Âºè */
.http-request {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.4;
    font-size: 13px;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 10px;
}

.http-request-line {
    color: #d63384;
    font-weight: bold;
}

.http-header {
    color: #0d6efd;
}

.http-body {
    color: #198754;
    margin-top: 10px;
}

.copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    padding: 5px 10px;
    font-size: 12px;
    background: rgba(82, 16, 237, 0.1);
    border: 1px solid rgba(82, 16, 237, 0.2);
}

.copy-btn:hover {
    background: rgba(82, 16, 237, 0.2);
}

/* ‰ª™Ë°®ÁõòÊ†∑Âºè */
.dashboard-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.chart-container {
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.3);
    text-align: center;
}

.chart-title {
    font-size: 16px;
    font-weight: 600;
    color: #5210ed;
    margin-bottom: 15px;
}


.gauge-background {
    width: 100%;
    height: 60px;
    background: linear-gradient(90deg, 
        #ff4757 0%, 
        #ffa502 25%, 
        #2ed573 50%, 
        #1e90ff 75%, 
        #5352ed 100%);
    border-radius: 100px 100px 0 0;
    position: relative;
    overflow: hidden;
}

.gauge-fill {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.3);
    transform-origin: bottom center;
    transform: rotate(0deg);
    transition: transform 1s ease-in-out;
}

.gauge-needle {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 4px;
    height: 90px;
    background: #5210ed;
    transform-origin: bottom center;
    transform: translateX(-50%) rotate(0deg);
    transition: transform 1s ease-in-out;
    border-radius: 2px 2px 0 0;
}

.gauge-needle::after {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    background: #5210ed;
    border-radius: 50%;
}

.gauge-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 12px;
    color: #666;
}

.gauge-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    font-weight: bold;
    color: #5210ed;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}


.sites-gauge-circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        #2ed573 0% var(--alive-percent), 
        #ff4757 var(--alive-percent) 100%
    );
    position: relative;
}

.sites-gauge-inner {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    bottom: 20px;
    background: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.sites-gauge-value {
    font-size: 24px;
    font-weight: bold;
    color: #5210ed;
}

.sites-gauge-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.sites-gauge-legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: #666;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.legend-alive {
    background: #2ed573;
}

.legend-dead {
    background: #ff4757;
}



.value-changing {
    animation: valueChange 0.5s ease-in-out;
}

/* ‰ª™Ë°®ÁõòÊ†∑Âºè */
.dashboard-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.chart-container {
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.3);
    text-align: center;
}

.chart-title {
    font-size: 16px;
    font-weight: 600;
    color: #5210ed;
    margin-bottom: 15px;
}

.gauge-chart {
    width: 200px;
    height: 120px;
    margin: 0 auto;
    position: relative;
}







.gauge-needle::after {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    background: #5210ed;
    border-radius: 50%;
}

.gauge-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 12px;
    color: #666;
}

.gauge-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    font-weight: bold;
    color: #5210ed;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Á´ôÁÇπÁä∂ÊÄÅ‰ª™Ë°®Áõò */
.sites-gauge {
    width: 200px;
    height: 200px;
    margin: 0 auto;
    position: relative;
}

.sites-gauge-circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        #2ed573 0% var(--alive-percent), 
        #ff4757 var(--alive-percent) 100%
    );
    position: relative;
}

.sites-gauge-inner {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    bottom: 20px;
    background: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.sites-gauge-value {
    font-size: 24px;
    font-weight: bold;
    color: #5210ed;
}

.sites-gauge-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.sites-gauge-legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: #666;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.legend-alive {
    background: #2ed573;
}

.legend-dead {
    background: #ff4757;
}

/* Ë°®Ê†ºÊªöÂä®ÂÆπÂô®Ê†∑Âºè */
.table-scroll-container {
    max-height: 500px;
    overflow-y: auto;
    margin-bottom: 15px;
    border-radius: 12px;
    border: 1px solid rgba(82, 16, 237, 0.1);
}

/* ÁæéÂåñÊªöÂä®Êù° */
.table-scroll-container::-webkit-scrollbar {
    width: 8px;
}

.table-scroll-container::-webkit-scrollbar-track {
    background: rgba(82, 16, 237, 0.05);
    border-radius: 4px;
}

.table-scroll-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    border-radius: 4px;
}

.table-scroll-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #4510c5, #7a52e0);
}

/* Ë°®Ê†ºÂ§¥ÈÉ®Âõ∫ÂÆö */
.table-scroll-container table thead {
    position: sticky;
    top: 0;
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    z-index: 10;
}

/* Ë°®Ê†ºÊ†∑ÂºèË∞ÉÊï¥ */
.table-scroll-container table {
    margin-bottom: 0;
}

.table-scroll-container table th {
    position: relative;
}

/* ÂàÜÈ°µ‰ø°ÊÅØÊ†∑Âºè */
.pagination-info {
    text-align: center;
    margin: 10px 0;
    color: #666;
    font-size: 14px;
}

/* Á≥ªÁªüÁõëÊéßÂç°ÁâáÊ†∑Âºè */
.system-monitor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.monitor-card {
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.3);
    text-align: center;
}

.monitor-value {
    font-size: 28px;
    font-weight: bold;
    color: #5210ed;
    margin-bottom: 5px;
}

.monitor-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
}

.monitor-details {
    font-size: 12px;
    color: #888;
    margin-top: 10px;
}

/* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
@media (max-width: 768px) {
    .system-monitor-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard-charts {
        grid-template-columns: 1fr;
    }
}

/* ‰ª£Á†ÅÈ´ò‰∫ÆÂíåÊó•ÂøóÊòæÁ§∫Ê†∑Âºè */
.code-container {
    background: #2d3748;
    border-radius: 8px;
    padding: 0;
    margin: 15px 0;
    overflow: hidden;
    border: 1px solid #4a5568;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.code-header {
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    color: white;
    padding: 10px 15px;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.code-content {
    max-height: 400px;
    overflow-y: auto;
    background: #2d3748;
}

.code-content pre {
    margin: 0 !important;
    background: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    padding: 15px !important;
    font-size: 13px;
    line-height: 1.5;
}

.code-content code {
    background: transparent !important;
    color: #e2e8f0 !important;
    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace !important;
}

/* Êó•ÂøóËØ¶ÊÉÖÊ†∑Âºè */
.log-detail-container {
    background: #f8f9fa;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e9ecef;
    margin: 15px 0;
}

.log-detail-header {
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    color: white;
    padding: 15px 20px;
    font-weight: 600;
}

.log-detail-content {
    padding: 20px;
}

.log-field {
    display: flex;
    margin-bottom: 12px;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 8px;
}

.log-field-label {
    font-weight: 600;
    color: #495057;
    min-width: 120px;
    margin-right: 15px;
}

.log-field-value {
    flex: 1;
    color: #6c757d;
    word-break: break-all;
    font-family: 'Monaco', 'Consolas', monospace;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

.log-field-value.highlight {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

/* ÊîªÂáªÊó•ÂøóË°®Ê†ºÁæéÂåñ */
.attack-logs-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.attack-logs-table th {
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 15px 10px;
    border: none;
}

.attack-logs-table td {
    padding: 12px 10px;
    border-bottom: 1px solid #f1f3f4;
    vertical-align: middle;
}

.attack-logs-table tr:hover {
    background: rgba(82, 16, 237, 0.05);
}

.log-method-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.log-method-get { background: #d4edda; color: #155724; }
.log-method-post { background: #cce5ff; color: #004085; }
.log-method-put { background: #fff3cd; color: #856404; }
.log-method-delete { background: #f8d7da; color: #721c24; }
.log-method-default { background: #e2e3e5; color: #383d41; }

.log-rule-name {
    font-weight: 600;
    color: #5210ed;
}

.log-matched-content {
    font-family: 'Monaco', 'Consolas', monospace;
    background: #f8f9fa;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 12px;
    border: 1px solid #e9ecef;
}

/* ÁºìÂ≠òÊñá‰ª∂ÂÜÖÂÆπÊ†∑Âºè */
.cache-file-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
}

.cache-file-info table {
    width: 100%;
    border-collapse: collapse;
}

.cache-file-info td {
    padding: 8px;
    border-bottom: 1px solid #e9ecef;
}

.cache-file-info td:first-child {
    font-weight: 600;
    color: #495057;
    width: 120px;
}

/* Prism.js ‰∏ªÈ¢òË¶ÜÁõñ */
pre[class*="language-"] {
    background: #2d3748 !important;
    border: none !important;
    border-radius: 0 !important;
}

code[class*="language-"] {
    color: #e2e8f0 !important;
    background: transparent !important;
}

.token.comment { color: #718096 !important; }
.token.string { color: #68d391 !important; }
.token.number { color: #f6ad55 !important; }
.token.keyword { color: #9f7aea !important; }
.token.operator { color: #4fd1c7 !important; }
.token.punctuation { color: #a0aec0 !important; }




    </style>
</head>

<body>
    <!-- ‰æßËæπÂØºËà™Ê†è -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="fox">ü¶ä</div>
            <h1>Â∞èÁãêÁã∏ÊéßÂà∂Âè∞</h1>
        </div>

        <div class="nav-menu">
            <a href="javascript:void(0)" class="nav-item active" data-page="dashboard">
                <span class="icon">üìä</span>
                <span class="text">Êï∞ÊçÆÊ¶ÇËßà</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="acl">
                <span class="icon">üõ°Ô∏è</span>
                <span class="text">ACLËßÑÂàô</span>
            </a>
            <!-- Âú®Áé∞ÊúâÁöÑÂØºËà™ËèúÂçï‰∏≠Ê∑ªÂä† -->
            <a href="javascript:void(0)" class="nav-item" data-page="cc">
                <span class="icon">üö´</span>
                <span class="text">CCÊã¶Êà™</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="cache">
                <span class="icon">‚ö°</span>
                <span class="text">ÁºìÂ≠òÁÆ°ÁêÜ</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="sites">
                <span class="icon">üåê</span>
                <span class="text">Á´ôÁÇπÁÆ°ÁêÜ</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="logs">
                <span class="icon">üìù</span>
                <span class="text">ÊîªÂáªÊó•Âøó</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="blocked_rules">
        <span class="icon">üö´</span>
        <span class="text">Ë¢´Á¶ÅÁî®ÁöÑËßÑÂàô</span>
            </a>
            <!-- Âú®Áé∞ÊúâÁöÑÂØºËà™ËèúÂçï‰∏≠Ê∑ªÂä† -->
<a href="javascript:void(0)" class="nav-item" data-page="custom_rules">
    <span class="icon">üìù</span>
    <span class="text">ËßÑÂàôÁÆ°ÁêÜ</span>
</a>
            <a href="javascript:void(0)" class="nav-item" data-page="settings">
                <span class="icon">‚öôÔ∏è</span>
                <span class="text">Á≥ªÁªüËÆæÁΩÆ</span>
            </a>
        </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="main-content">
        <div class="content-header">
            <div>
                <h2 id="page-title">Êï∞ÊçÆÊ¶ÇËßà</h2>
                <p id="page-description">Ê¨¢ËøéÊù•Âà∞Â∞èÁãêÁã∏WAFÊéßÂà∂Âè∞</p>
            </div>
            <button id="theme-toggle" class="theme-toggle-btn" onclick="toggleTheme()" title="ÂàáÊç¢‰∏ªÈ¢ò">
                <span id="theme-icon">üåô</span>
            </button>
        </div>

        <div class="content-body" id="content-container">
            <!-- ÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
    </div>

    <!-- Ê®°ÊÄÅÊ°Ü -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Ê®°ÊÄÅÊ°ÜÊ†áÈ¢ò</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπ -->
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentPage = 'dashboard';
        let currentLogsPage = 1;
        let currentLogsPageSize = 20;
        let currentLogsTotal = 0;

        // È°µÈù¢ÂÜÖÂÆπÂÆö‰πâ
        const pageContents = {
            dashboard: {
    title: "Êï∞ÊçÆÊ¶ÇËßà",
    description: "Á≥ªÁªüËøêË°åÁä∂ÊÄÅÂíåÁªüËÆ°‰ø°ÊÅØ",
    content: `
        <div class="dashboard-grid">
            <div class="metric-row">
                <div class="metric-card">
                    <div class="metric-icon">üåê</div>
                    <div class="metric-content">
                        <div class="metric-value" id="total-requests">0</div>
                        <div class="metric-label">ÊÄªËØ∑Ê±ÇÊï∞</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">üõ°Ô∏è</div>
                    <div class="metric-content">
                        <div class="metric-value" id="blocked-requests">0</div>
                        <div class="metric-label">Êã¶Êà™ÊîªÂáª</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">üåç</div>
                    <div class="metric-content">
                        <div class="metric-value" id="total-sites">0</div>
                        <div class="metric-label">ÊÄªÁ´ôÁÇπÊï∞</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">‚úÖ</div>
                    <div class="metric-content">
                        <div class="metric-value" id="alive-sites">0</div>
                        <div class="metric-label">Â≠òÊ¥ªÁ´ôÁÇπ</div>
                    </div>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÔºöÁ≥ªÁªüÁõëÊéß‰ª™Ë°®Áõò -->
            <div class="dashboard-charts">
                <div class="chart-container">
                    <div class="chart-title">üìä Á´ØÂè£ËØ∑Ê±ÇÈÄüÁéá</div>
                    <div id="port-stats-container">
                        <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">üíª CPU‰ΩøÁî®Áéá</div>
                    <div id="cpu-stats-container">
                        <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">üíæ ÂÜÖÂ≠ò‰ΩøÁî®Áéá</div>
                    <div id="memory-stats-container">
                        <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
            </div>

            
            
            <div class="refresh-section">
                <button class="refresh-btn" onclick="refreshAllStats()">
                    <span class="refresh-icon">üîÑ</span> Âà∑Êñ∞Êï∞ÊçÆ
                </button>
                <div class="last-update">
                    ÊúÄÂêéÊõ¥Êñ∞: <span id="last-update">${new Date().toLocaleTimeString()}</span>
                </div>
            </div>
        </div>
    `
},
            acl: {
                title: "ACLËßÑÂàôÁÆ°ÁêÜ",
                description: "ËÆøÈóÆÊéßÂà∂ÂàóË°®ËßÑÂàôÈÖçÁΩÆ",
                content: `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üõ°Ô∏è ACLËßÑÂàôÂàóË°®</h3>
                            <button class="btn" onclick="showAddACLModal()">
                                <span>+</span> Ê∑ªÂä†ËßÑÂàô
                            </button>
                        </div>
                        <div id="acl-rules-container">
                            <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                        </div>
                    </div>
                `
            },
            // Âú® pageContents ÂØπË±°‰∏≠Ê∑ªÂä†
            cc: {
                title: "CCÊîªÂáªÊã¶Êà™",
                description: "CCÊîªÂáªÈò≤Êä§ËßÑÂàôÈÖçÁΩÆÂíåÁªüËÆ°",
                content: `
                <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìä CCÊîªÂáªÁªüËÆ°</h3>
                <button class="btn" onclick="refreshCCStats()">
                    <span>üîÑ</span> Âà∑Êñ∞
                </button>
            </div>
            <div id="cc-stats-container">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>

        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üö´ CCËßÑÂàôÂàóË°®</h3>
                <button class="btn" onclick="showAddCCRuleModal()">
                    <span>+</span> Ê∑ªÂä†ËßÑÂàô
                </button>
            </div>
            <div id="cc-rules-container">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìù CCÊîªÂáªÊó•Âøó</h3>
                <button class="btn" onclick="clearCCCounters()">
                    <span>üóëÔ∏è</span> Ê∏ÖÁ©∫ËÆ°Êï∞Âô®
                </button>
            </div>
            
            <div class="form-group">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="cc-client-ip-filter" class="form-control" placeholder="ÂÆ¢Êà∑Á´ØIP" style="width: 150px;">
                    <input type="text" id="cc-domain-filter" class="form-control" placeholder="ÂüüÂêç" style="width: 150px;">
                    <input type="text" id="cc-rule-id-filter" class="form-control" placeholder="ËßÑÂàôID" style="width: 120px;">
                    <input type="date" id="cc-start-date" class="form-control" style="width: 150px;">
                    <input type="date" id="cc-end-date" class="form-control" style="width: 150px;">
                    <button class="btn" onclick="loadCCAttackLogs(1)">
                        <span>üîç</span> ÊêúÁ¥¢
                    </button>
                </div>
            </div>
            
            <div id="cc-logs-container">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
            
            <div id="cc-logs-pagination" class="pagination"></div>
        </div>
    `
            },
            // ‰øÆÊîπÁºìÂ≠òÁÆ°ÁêÜÈ°µÈù¢ÂÜÖÂÆπ
            cache: {
    title: "ÁºìÂ≠òÁÆ°ÁêÜ",
    description: "ÈùôÊÄÅÁºìÂ≠òÈÖçÁΩÆÂíåÁªüËÆ°",
    content: `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‚ö° ÁºìÂ≠òÁªüËÆ°</h3>
                <div>
                    <button class="btn btn-secondary" onclick="clearCache()">
                        <span>üóëÔ∏è</span> Ê∏ÖÁ©∫ÁºìÂ≠ò
                    </button>
                    <button class="btn" onclick="refreshCacheStats()">
                        <span>üîÑ</span> Âà∑Êñ∞
                    </button>
                </div>
            </div>
            <div id="cache-stats-container">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìÅ ÁºìÂ≠òÊñá‰ª∂ÂàóË°®</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="cache-site-filter" class="form-control" style="width: 200px;" onchange="window.loadCacheFiles(1)">
                        <option value="all">ÂÖ®ÈÉ®Á´ôÁÇπ</option>
                    </select>
                </div>
            </div>
            <div id="cache-files-container">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
            <!-- Ê∑ªÂä†ÂàÜÈ°µÂÆπÂô® -->
            <div id="cache-files-pagination" class="pagination"></div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‚öôÔ∏è ÁºìÂ≠òÈÖçÁΩÆ</h3>
            </div>
            <div id="cache-config-container">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
    `
},
            sites: {
                title: "Á´ôÁÇπÁÆ°ÁêÜ",
                description: "ÂèçÂêë‰ª£ÁêÜÁ´ôÁÇπÈÖçÁΩÆ",
                content: `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üåê Á´ôÁÇπÂàóË°®</h3>
                            <button class="btn" onclick="showAddSiteModal()">
                                <span>+</span> Ê∑ªÂä†Á´ôÁÇπ
                            </button>
                        </div>
                        <div id="sites-container">
                            <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                        </div>
                    </div>
                `
            },
            logs: {
                title: "ÊîªÂáªÊó•Âøó",
                description: "Êü•ÁúãÂíåÂàÜÊûêÊîªÂáªËÆ∞ÂΩï",
                content: `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìù ÊîªÂáªÊó•Âøó</h3>
                            <div>
                                <button class="btn btn-secondary" onclick="exportLogs()">
                                    <span>üì§</span> ÂØºÂá∫Êó•Âøó
                                </button>
                                <button class="btn btn-danger" onclick="showDeleteLogsModal()">
                                    <span>üóëÔ∏è</span> Âà†Èô§Êó•Âøó
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select id="log-method-filter" class="form-control" style="width: 150px;">
                                    <option value="">ÊâÄÊúâÊñπÊ≥ï</option>
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                                <input type="text" id="log-rule-filter" class="form-control" placeholder="ËßÑÂàôÂêçÁß∞" style="width: 200px;">
                                <input type="date" id="log-start-date" class="form-control" style="width: 150px;">
                                <input type="date" id="log-end-date" class="form-control" style="width: 150px;">
                                <button class="btn" onclick="loadAttackLogs(1)">
                                    <span>üîç</span> ÊêúÁ¥¢
                                </button>
                            </div>
                        </div>
                        
                        <div id="logs-container">
                            <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                        </div>
                        
                        <div id="logs-pagination" class="pagination"></div>
                    </div>
                `
            },
            settings: {
                title: "Á≥ªÁªüËÆæÁΩÆ",
                description: "Á≥ªÁªüÈÖçÁΩÆÂíåÂèÇÊï∞Ë∞ÉÊï¥",
                content: `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ</h3>
            </div>
            
            <div id="settings-message"></div>
            
            <form id="settings-form">
                <div class="form-group">
                    <label class="form-label">Èò≤ÂºÄÂèëËÄÖÂ∑•ÂÖ∑</label>
                    <div>
                        <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                            <input type="radio" name="anti-devtools" value="true"> ÂêØÁî®
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 8px;">
                            <input type="radio" name="anti-devtools" value="false"> Á¶ÅÁî®
                        </label>
                    </div>
                </div>
                
                <!-- Êñ∞Â¢ûÔºöJSÊ∑∑Ê∑ÜÂºÄÂÖ≥ -->
                <div class="form-group">
                    <label class="form-label">JSÊ∑∑Ê∑Ü</label>
                    <div>
                        <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                            <input type="radio" name="js-obfuscation" value="true"> ÂêØÁî®
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 8px;">
                            <input type="radio" name="js-obfuscation" value="false"> Á¶ÅÁî®
                        </label>
                    </div>
                    <small style="color: #666;">ÂêØÁî®Âêé‰ºöÂØπÂâçÁ´ØJavaScript‰ª£Á†ÅËøõË°åÊ∑∑Ê∑ÜÔºåÂ¢ûÂº∫ÂÆâÂÖ®ÊÄß</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ËßÑÂàôÂåπÈÖçÁéá (%)</label>
                    <input type="range" id="rule-match-rate" min="0" max="100" step="1" value="100" class="form-control range-slider">
                    <div id="rule-match-rate-value" style="text-align: center; margin-top: 5px;">100%</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Base64 Ëß£Á†ÅÊ∑±Â∫¶</label>
                    <input type="number" id="base64-depth" min="0" max="10" value="2" class="form-control">
                    <small style="color: #666;">ËÆæÁΩÆBase64Ëß£Á†ÅÁöÑÊúÄÂ§ßÊ∑±Â∫¶Ôºå0Ë°®Á§∫Á¶ÅÁî®Base64Ëß£Á†Å</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">URL Ëß£Á†ÅÊ∑±Â∫¶</label>
                    <input type="number" id="url-depth" min="0" max="10" value="2" class="form-control">
                    <small style="color: #666;">ËÆæÁΩÆURLËß£Á†ÅÁöÑÊúÄÂ§ßÊ∑±Â∫¶Ôºå0Ë°®Á§∫Á¶ÅÁî®URLËß£Á†Å</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ËßÑÂàôÁÆ°ÁêÜ</label>
                    <div>
                        <button type="button" class="btn btn-secondary" onclick="reloadCustomRules()" style="margin-right: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 15px 0 rgba(116, 75, 162, 0.3); transition: all 0.3s ease; position: relative; overflow: hidden;">
                            <span style="font-size: 16px; margin-right: 8px;">üîÑ</span> ÈáçÊñ∞Âä†ËΩΩËßÑÂàô
                        </button>
                        <button type="button" class="btn" onclick="saveSettings()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 15px 0 rgba(245, 87, 108, 0.3); transition: all 0.3s ease;">
                            <span style="font-size: 16px; margin-right: 8px;">üíæ</span> ‰øùÂ≠òËÆæÁΩÆ
                        </button>
                    </div>
                    <small style="color: #666;">ÁÇπÂáª"ÈáçÊñ∞Âä†ËΩΩËßÑÂàô"ÊåâÈíÆÂèØ‰ª•ÈáçÊñ∞Âä†ËΩΩÊâÄÊúâËßÑÂàôÊñá‰ª∂</small>
                </div>
                
                <style>
                .btn.btn-secondary:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 25px 0 rgba(116, 75, 162, 0.5);
                }
                
                .btn:not(.btn-secondary):hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 25px 0 rgba(245, 87, 108, 0.5);
                }
                </style>
            </form>
        </div>
    `
            },
            blocked_rules: {
        title: "Ë¢´Á¶ÅÁî®ÁöÑËßÑÂàô",
        description: "Êü•ÁúãÂíåÁÆ°ÁêÜË¢´Á¶ÅÁî®ÁöÑÈò≤Êä§ËßÑÂàô",
        content: `
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üö´ Ë¢´Á¶ÅÁî®ÁöÑËßÑÂàôÂàóË°®</h3>
                    <button class="btn" onclick="loadBlockedRules()">
                        <span>üîÑ</span> Âà∑Êñ∞
                    </button>
                </div>
                <div id="blocked-rules-container">
                    <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
        `
    },
    // Âú® pageContents ÂØπË±°‰∏≠Ê∑ªÂä†
custom_rules: {
    title: "Ëá™ÂÆö‰πâËßÑÂàôÁÆ°ÁêÜ",
    description: "ÁÆ°ÁêÜÁî®Êà∑Ëá™ÂÆö‰πâÁöÑWAFÈò≤Êä§ËßÑÂàô",
    content: `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìù Ëá™ÂÆö‰πâËßÑÂàôÂàóË°®</h3>
                <div>
                    <button class="btn btn-secondary" onclick="exportCustomRules()">
                        <span>üì§</span> ÂØºÂá∫ËßÑÂàô
                    </button>
                    <button class="btn btn-secondary" onclick="showImportRulesModal()">
                        <span>üì•</span> ÂØºÂÖ•ËßÑÂàô
                    </button>
                    <button class="btn" onclick="showAddCustomRuleModal()">
                        <span>+</span> Ê∑ªÂä†ËßÑÂàô
                    </button>
                </div>
            </div>
            <div id="custom-rules-container">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‚ÑπÔ∏è ËßÑÂàôËØ¥Êòé</h3>
            </div>
            <div style="padding: 20px;">
                <h4 style="color: #5210ed; margin-bottom: 15px;">ËßÑÂàôÈÖçÁΩÆËØ¥Êòé</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5>‰ΩçÁΩÆ (Position):</h5>
                        <ul style="color: #666; line-height: 1.6;">
                            <li><strong>uri</strong> - ËØ∑Ê±ÇURLË∑ØÂæÑ</li>
                            <li><strong>request_header</strong> - ËØ∑Ê±ÇÂ§¥</li>
                            <li><strong>request_body</strong> - ËØ∑Ê±Ç‰Ωì</li>
                            <li><strong>parameter_value</strong> - URLÂèÇÊï∞ÂÄº</li>
                            <li><strong>form_values</strong> - Ë°®ÂçïÂÄº</li>
                        </ul>
                    </div>
                    <div>
                        <h5>ÂåπÈÖçÊñπÂºè:</h5>
                        <ul style="color: #666; line-height: 1.6;">
                            <li><strong>Content</strong> - ÁÆÄÂçïÂ≠óÁ¨¶‰∏≤ÂåπÈÖç</li>
                            <li><strong>Rix (Ê≠£Âàô)</strong> - Ê≠£ÂàôË°®ËææÂºèÂåπÈÖç</li>
                            <li><strong>Action</strong> - "is" ÂåπÈÖç / "not" ‰∏çÂåπÈÖç</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `
}
        }

        // ÊòæÁ§∫Ë¢´Á¶ÅÁî®ÁöÑËßÑÂàô
// ÊîπËøõÁöÑÊòæÁ§∫Ë¢´Á¶ÅÁî®ËßÑÂàôÂáΩÊï∞
async function displayBlockedRules(blockedRuleIds) {
    const container = document.getElementById('blocked-rules-container');

    if (!blockedRuleIds || blockedRuleIds.length === 0) {
        container.innerHTML = '<div class="alert">ÊöÇÊó†Ë¢´Á¶ÅÁî®ÁöÑËßÑÂàô</div>';
        return;
    }

    // ÂàÜÈ°µÂ§ÑÁêÜ
    const pageSize = 10;
    const totalPages = Math.ceil(blockedRuleIds.length / pageSize);
    const currentPage = 1;
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const displayRules = blockedRuleIds.slice(startIndex, endIndex);

    // Ëé∑ÂèñÊâÄÊúâËßÑÂàôÊù•ÊòæÁ§∫ÂêçÁß∞ÔºàËøôÈáåÈúÄË¶Å‰Ω†Êèê‰æõËé∑ÂèñÊâÄÊúâËßÑÂàôÁöÑÊé•Âè£Ôºâ
    const allRules = await getAllRules();
    
    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ËßÑÂàôID</th>
                        <th>ËßÑÂàôÂêçÁß∞</th>
                        <th>ËßÑÂàôÊñπÊ≥ï</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
    `;

    displayRules.forEach(ruleId => {
        // Âú®ÂÆûÈôÖ‰ΩøÁî®‰∏≠ÔºåËøôÈáåÂ∫îËØ•‰ªé allRules ‰∏≠Êü•ÊâæËßÑÂàôÂêçÁß∞
        const ruleName = `ËßÑÂàô ${ruleId}`; // ‰∏¥Êó∂ÊòæÁ§∫
        const ruleMethod = 'Êú™Áü•'; // ‰∏¥Êó∂ÊòæÁ§∫
        
        html += `
            <tr>
                <td>${ruleId}</td>
                <td title="${ruleName}">${ruleName.length > 15 ? ruleName.substring(0, 15) + '...' : ruleName}</td>
                <td>${ruleMethod}</td>
                <td>
                    <span class="status-indicator status-inactive">
                        Â∑≤Á¶ÅÁî®
                    </span>
                </td>
                <td>
                    <button class="btn btn-success" onclick="enableRule('${ruleId}')">
                        ÂêØÁî®
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            ÊòæÁ§∫ 1-${displayRules.length} Êù°ÔºåÂÖ± ${blockedRuleIds.length} Êù°Ë¢´Á¶ÅÁî®ÁöÑËßÑÂàô
        </div>
    `;

    container.innerHTML = html;
}

// ÂêØÁî®ËßÑÂàô
async function enableRule(ruleId) {
    if (!confirm(`Á°ÆÂÆöË¶ÅÂêØÁî®ËßÑÂàô ID: ${ruleId} ÂêóÔºü`)) return;
    
    try {
        const response = await fetch('/api/rules/status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                rule_id: ruleId,
                enable: true
            })
        });

        if (response.ok) {
            showMessage(`ËßÑÂàô ${ruleId} Â∑≤ÂêØÁî®`, 'success');
            // Âà∑Êñ∞Ë¢´Á¶ÅÁî®ÁöÑËßÑÂàôÂàóË°®
            loadBlockedRules();
        } else {
            const error = await response.text();
            showMessage('ÂêØÁî®Â§±Ë¥•: ' + error, 'error');
        }
    } catch (error) {
        console.error('ÂêØÁî®ËßÑÂàôÈîôËØØ:', error);
        showMessage('ÂêØÁî®Â§±Ë¥•', 'error');
    }
}



        // Âä†ËΩΩË¢´Á¶ÅÁî®ÁöÑËßÑÂàô
async function loadBlockedRules() {
    try {
        const response = await fetch('/api/rule/blockRuleId', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            displayBlockedRules(data.id);
        } else {
            document.getElementById('blocked-rules-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩË¢´Á¶ÅÁî®ËßÑÂàôÂ§±Ë¥•</div>';
        }
    } catch (error) {
        console.error('Âä†ËΩΩË¢´Á¶ÅÁî®ËßÑÂàôÈîôËØØ:', error);
        document.getElementById('blocked-rules-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩË¢´Á¶ÅÁî®ËßÑÂàôÂ§±Ë¥•</div>';
    }
}

        // È°µÈù¢ÂàáÊç¢ÂäüËÉΩ
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                // Ê∑ªÂä†ÂΩìÂâçactiveÁ±ª
                this.classList.add('active');
                
                // Ëé∑ÂèñÈ°µÈù¢Ê†áËØÜ
                const pageId = this.getAttribute('data-page');
                loadPage(pageId);
            });
        });

        // ‰øÆÊîπÈ°µÈù¢Âä†ËΩΩÂáΩÊï∞ÔºåÂú®dashboardÈ°µÈù¢Âä†ËΩΩÁ≥ªÁªüÁõëÊéßÊï∞ÊçÆ
function loadPage(pageId) {
    currentPage = pageId;
    const page = pageContents[pageId];
    if (page) {
        document.getElementById('page-title').textContent = page.title;
        document.getElementById('page-description').textContent = page.description;
        document.getElementById('content-container').innerHTML = page.content;

        // Âä†ËΩΩÈ°µÈù¢ÁâπÂÆöÊï∞ÊçÆ
        switch (pageId) {
            case 'dashboard':
                loadStats(); // Ëøô‰ºöÂêåÊó∂Âä†ËΩΩÂü∫Êú¨ÁªüËÆ°ÂíåÁ≥ªÁªüÁõëÊéß
                break;
            case 'acl':
                loadACLRules();
                break;
            case 'cache':
                loadCacheStats();
                loadCacheConfig();
                window.loadCacheFiles(1);
                break;
            case 'sites':
                loadSites();
                // Á°Æ‰øùÂÅ•Â∫∑Áä∂ÊÄÅÂ∑≤Âä†ËΩΩ
                if (!window.siteHealthData || Object.keys(window.siteHealthData).length === 0) {
                    loadSiteHealthStatus();
                }
                break;
            case 'logs':
                loadAttackLogs(1);
                break;
            case 'settings':
                loadSettings();
                break;
            case 'cc':
                loadCCRules();
                loadCCStats();
                loadCCAttackLogs(1);
                break;
            case 'blocked_rules':
                loadBlockedRules();
                break;
            // Âú® loadPage ÂáΩÊï∞ÁöÑ switch ËØ≠Âè•‰∏≠Ê∑ªÂä†
            case 'custom_rules':
                loadCustomRules();
                break;
        }
    }
}

// Âä†ËΩΩËá™ÂÆö‰πâËßÑÂàô
async function loadCustomRules() {
    try {
        const response = await fetch('/api/custom-rules', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            displayCustomRules(data.rules);
        } else {
            const container = document.getElementById('custom-rules-container');
            if (container) {
                container.innerHTML = '<div class="alert alert-error">Âä†ËΩΩËá™ÂÆö‰πâËßÑÂàôÂ§±Ë¥•</div>';
            }
        }
    } catch (error) {
        console.error('Âä†ËΩΩËá™ÂÆö‰πâËßÑÂàôÈîôËØØ:', error);
        const container = document.getElementById('custom-rules-container');
        if (container) {
            container.innerHTML = '<div class="alert alert-error">Âä†ËΩΩËá™ÂÆö‰πâËßÑÂàôÂ§±Ë¥•</div>';
        }
    }
}

// ÊòæÁ§∫Ëá™ÂÆö‰πâËßÑÂàô
function displayCustomRules(rules) {
    const container = document.getElementById('custom-rules-container');
    
    if (!container) {
        return;
    }

    if (!rules || rules.length === 0) {
        container.innerHTML = `
            <div class="alert" style="text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
                <h3 style="color: #5210ed; margin-bottom: 10px;">ÊöÇÊó†Ëá™ÂÆö‰πâËßÑÂàô</h3>
                <p style="color: #666; margin-bottom: 20px;">ÂºÄÂßãÂàõÂª∫ÊÇ®ÁöÑÁ¨¨‰∏ÄÊù°Ëá™ÂÆö‰πâËßÑÂàôÊù•Â¢ûÂº∫WAFÈò≤Êä§ËÉΩÂäõ</p>
                <button class="btn" onclick="showAddCustomRuleModal()">
                    <span>+</span> ÂàõÂª∫Á¨¨‰∏ÄÊù°ËßÑÂàô
                </button>
            </div>
        `;
        return;
    }

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ÂêçÁß∞</th>
                        <th>ÊñπÊ≥ï</th>
                        <th>ÂÖ≥Á≥ª</th>
                        <th>Âà§Êñ≠Êù°‰ª∂</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>ÊèèËø∞</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
    `;

    rules.forEach(rule => {
        const judgesText = rule.Judges.map(judge => {
            let text = `${judge.Position}: `;
            if (judge.Rix) {
                text += `Ê≠£Âàô(${judge.Rix.length > 10 ? judge.Rix.substring(0, 10) + '...' : judge.Rix})`;
            } else if (judge.Content) {
                text += `ÂÜÖÂÆπ(${judge.Content.length > 10 ? judge.Content.substring(0, 10) + '...' : judge.Content})`;
            }
            if (judge.Action) {
                text += ` [${judge.Action}]`;
            }
            return text;
        }).join('; ');

        html += `
        <tr>
            <td>${rule.ID}</td>
            <td title="${rule.Name}">${rule.Name.length > 15 ? rule.Name.substring(0, 15) + '...' : rule.Name}</td>
            <td>
                <span class="status-indicator ${rule.Method === 'any' ? 'status-active' : 'status-inactive'}">
                    ${rule.Method}
                </span>
            </td>
            <td>${rule.Relation || 'and'}</td>
            <td title="${judgesText}">${judgesText.length > 20 ? judgesText.substring(0, 20) + '...' : judgesText}</td>
            <td>
                <span class="status-indicator ${rule.Enabled ? 'status-active' : 'status-inactive'} clickable" 
                      onclick="toggleCustomRuleStatus('${rule.ID}', ${!rule.Enabled})"
                      title="ÁÇπÂáªÂàáÊç¢Áä∂ÊÄÅ">
                    ${rule.Enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
                </span>
            </td>
            <td title="${rule.Description || 'Êó†ÊèèËø∞'}">
                ${rule.Description ? (rule.Description.length > 15 ? rule.Description.substring(0, 15) + '...' : rule.Description) : '-'}
            </td>
            <td>
                <div class="action-buttons">
                    <button class="btn" onclick="showEditCustomRuleModal('${rule.ID}')">ÁºñËæë</button>
                    <button class="btn btn-danger" onclick="deleteCustomRule('${rule.ID}')">Âà†Èô§</button>
                </div>
            </td>
        </tr>
    `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            ÂÖ± ${rules.length} Êù°Ëá™ÂÆö‰πâËßÑÂàô
        </div>
    `;

    container.innerHTML = html;
}

// ÊòæÁ§∫Ê∑ªÂä†Ëá™ÂÆö‰πâËßÑÂàôÊ®°ÊÄÅÊ°Ü
function showAddCustomRuleModal() {
    document.getElementById('modal-title').textContent = 'Ê∑ªÂä†Ëá™ÂÆö‰πâËßÑÂàô';
    document.getElementById('modal-body').innerHTML = `
        <form id="add-custom-rule-form">
            <div class="form-group">
                <label class="form-label">ËßÑÂàôÂêçÁß∞</label>
                <input type="text" name="name" class="form-control" placeholder="‰æãÂ¶Ç: SQLÊ≥®ÂÖ•Èò≤Êä§" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">HTTPÊñπÊ≥ï</label>
                <select name="method" class="form-control" required>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="any">‰ªªÊÑèÊñπÊ≥ï (any)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Êù°‰ª∂ÂÖ≥Á≥ª</label>
                <select name="relation" class="form-control" required>
                    <option value="and">AND (ÊâÄÊúâÊù°‰ª∂ÈÉΩË¶ÅÊª°Ë∂≥)</option>
                    <option value="or">OR (‰ªªÊÑèÊù°‰ª∂Êª°Ë∂≥)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ËßÑÂàôÊèèËø∞</label>
                <textarea name="description" class="form-control" placeholder="ËßÑÂàôÊèèËø∞‰ø°ÊÅØ"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Âà§Êñ≠Êù°‰ª∂</label>
                <div id="judges-container">
                    <div class="judge-item" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <select name="position" class="form-control" required>
                                <option value="uri">URI</option>
                                <option value="request_header">ËØ∑Ê±ÇÂ§¥</option>
                                <option value="request_body">ËØ∑Ê±Ç‰Ωì</option>
                                <option value="parameter_value">ÂèÇÊï∞ÂÄº</option>
                                <option value="form_values">Ë°®ÂçïÂÄº</option>
                            </select>
                            <input type="text" name="content" class="form-control" placeholder="ÂåπÈÖçÂÜÖÂÆπ (ÂèØÈÄâ)">
                            <input type="text" name="rix" class="form-control" placeholder="Ê≠£ÂàôË°®ËææÂºè (ÂèØÈÄâ)">
                            <select name="action" class="form-control">
                                <option value="is">ÂåπÈÖç (is)</option>
                                <option value="not">‰∏çÂåπÈÖç (not)</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removeJudge(this)" style="padding: 5px 10px; font-size: 12px;">Âà†Èô§Êù°‰ª∂</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addJudge()" style="margin-top: 10px;">
                    <span>+</span> Ê∑ªÂä†Êù°‰ª∂
                </button>
            </div>
            
            <div class="form-group">
                <label style="display: inline-flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="enabled" checked> ÂêØÁî®ËßÑÂàô
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button type="submit" class="btn">Ê∑ªÂä†ËßÑÂàô</button>
            </div>
        </form>
    `;

    document.getElementById('add-custom-rule-form').addEventListener('submit', function(e) {
        e.preventDefault();
        addCustomRule(new FormData(this));
    });

    showModal();
    
    // Ëß¶Âèë‰ª£Á†ÅÈ´ò‰∫Æ
    setTimeout(() => {
        if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
        }
    }, 100);
}

// ‰øÆÊîπÊ∑ªÂä†Âà§Êñ≠Êù°‰ª∂ÁöÑHTMLÔºåÁ°Æ‰øùÈªòËÆ§ÂÄºÊ≠£Á°Æ
function addJudge() {
    const container = document.getElementById('judges-container');
    const judgeItem = document.createElement('div');
    judgeItem.className = 'judge-item';
    judgeItem.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;';
    
    judgeItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <select name="position" class="form-control" required>
                <option value="uri">URI</option>
                <option value="request_header">ËØ∑Ê±ÇÂ§¥</option>
                <option value="request_body">ËØ∑Ê±Ç‰Ωì</option>
                <option value="parameter_value">ÂèÇÊï∞ÂÄº</option>
                <option value="form_values">Ë°®ÂçïÂÄº</option>
            </select>
            <input type="text" name="content" class="form-control" placeholder="ÂåπÈÖçÂÜÖÂÆπ (‰∏éÊ≠£Âàô‰∫åÈÄâ‰∏Ä)">
            <input type="text" name="rix" class="form-control" placeholder="Ê≠£ÂàôË°®ËææÂºè (‰∏éÂÜÖÂÆπ‰∫åÈÄâ‰∏Ä)">
            <select name="action" class="form-control">
                <option value="is">ÂåπÈÖç (is)</option>
                <option value="not">‰∏çÂåπÈÖç (not)</option>
            </select>
        </div>
        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
            <strong>ÊèêÁ§∫:</strong> ÂÜÖÂÆπÂíåÊ≠£ÂàôË°®ËææÂºèËá≥Â∞ëÂ°´ÂÜô‰∏Ä‰∏™
        </div>
        <button type="button" class="btn btn-danger" onclick="removeJudge(this)" style="padding: 5px 10px; font-size: 12px;">Âà†Èô§Êù°‰ª∂</button>
    `;
    
    container.appendChild(judgeItem);
}


// Âà†Èô§Âà§Êñ≠Êù°‰ª∂
function removeJudge(button) {
    const judgeItem = button.closest('.judge-item');
    if (document.querySelectorAll('.judge-item').length > 1) {
        judgeItem.remove();
    } else {
        showMessage('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏Ä‰∏™Âà§Êñ≠Êù°‰ª∂', 'error');
    }
}

// ‰øÆÊîπÊ∑ªÂä†Ëá™ÂÆö‰πâËßÑÂàôÂáΩÊï∞
async function addCustomRule(formData) {
    try {
        const data = Object.fromEntries(formData);
        
        // Â§ÑÁêÜÂà§Êñ≠Êù°‰ª∂
        const judges = [];
        const judgeItems = document.querySelectorAll('.judge-item');
        
        judgeItems.forEach(item => {
            const judge = {
                position: item.querySelector('select[name="position"]').value,
                content: item.querySelector('input[name="content"]').value,
                rix: item.querySelector('input[name="rix"]').value,
                action: item.querySelector('select[name="action"]').value || 'is' // ÈªòËÆ§ÂÄº
            };
            
            // Â¶ÇÊûúÂÜÖÂÆπÂíåÊ≠£ÂàôÈÉΩ‰∏∫Á©∫ÔºåË∑≥ËøáËøô‰∏™Êù°‰ª∂
            if (!judge.content && !judge.rix) {
                return;
            }
            
            // Â¶ÇÊûúÊ≠£ÂàôË°®ËææÂºè‰∏ç‰∏∫Á©∫ÔºåÈ™åËØÅÊ≠£ÂàôÊ†ºÂºè
            if (judge.rix) {
                try {
                    new RegExp(judge.rix);
                } catch (e) {
                    showMessage(`Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ: ${judge.rix}`, 'error');
                    throw new Error('Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ');
                }
            }
            
            judges.push(judge);
        });
        
        if (judges.length === 0) {
            showMessage('Ëá≥Â∞ëÈúÄË¶ÅÈÖçÁΩÆ‰∏Ä‰∏™ÊúâÊïàÁöÑÂà§Êñ≠Êù°‰ª∂', 'error');
            return;
        }
        
        // ÊûÑÂª∫Ê≠£Á°ÆÁöÑËØ∑Ê±ÇÊï∞ÊçÆ
        const requestData = {
            name: data.name,
            description: data.description || '',
            method: data.method,
            relation: data.relation || 'and',
            judges: judges,
            enabled: data.enabled === 'on'
        };

        console.log('ÂèëÈÄÅÁöÑÊï∞ÊçÆ:', requestData); // Ë∞ÉËØïÁî®

        const response = await fetch('/api/custom-rules', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const result = await response.json();
            closeModal();
            showMessage('Ëá™ÂÆö‰πâËßÑÂàôÊ∑ªÂä†ÊàêÂäü', 'success');
            loadCustomRules();
        } else {
            const errorText = await response.text();
            let errorMessage = 'Ê∑ªÂä†Â§±Ë¥•';
            try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorText;
            } catch {
                errorMessage = errorText;
            }
            showMessage('Ê∑ªÂä†Â§±Ë¥•: ' + errorMessage, 'error');
        }
    } catch (error) {
        console.error('Ê∑ªÂä†Ëá™ÂÆö‰πâËßÑÂàôÈîôËØØ:', error);
        if (error.message !== 'Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ') {
            showMessage('Ê∑ªÂä†Â§±Ë¥•: ' + error.message, 'error');
        }
    }
}

// ÊòæÁ§∫ÁºñËæëËá™ÂÆö‰πâËßÑÂàôÊ®°ÊÄÅÊ°Ü
async function showEditCustomRuleModal(ruleId) {
    try {
        const response = await fetch('/api/custom-rules', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            const rule = data.rules.find(r => r.ID === ruleId);

            if (rule) {
                document.getElementById('modal-title').textContent = 'ÁºñËæëËá™ÂÆö‰πâËßÑÂàô';
                document.getElementById('modal-body').innerHTML = `
                    <form id="edit-custom-rule-form">
                        <input type="hidden" name="id" value="${rule.ID}">
                        <div class="form-group">
                            <label class="form-label">ËßÑÂàôÂêçÁß∞</label>
                            <input type="text" name="name" class="form-control" value="${rule.Name}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">HTTPÊñπÊ≥ï</label>
                            <select name="method" class="form-control" required>
                                <option value="GET" ${rule.Method === 'GET' ? 'selected' : ''}>GET</option>
                                <option value="POST" ${rule.Method === 'POST' ? 'selected' : ''}>POST</option>
                                <option value="PUT" ${rule.Method === 'PUT' ? 'selected' : ''}>PUT</option>
                                <option value="DELETE" ${rule.Method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                <option value="any" ${rule.Method === 'any' ? 'selected' : ''}>‰ªªÊÑèÊñπÊ≥ï (any)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Êù°‰ª∂ÂÖ≥Á≥ª</label>
                            <select name="relation" class="form-control" required>
                                <option value="and" ${rule.Relation === 'and' ? 'selected' : ''}>AND (ÊâÄÊúâÊù°‰ª∂ÈÉΩË¶ÅÊª°Ë∂≥)</option>
                                <option value="or" ${rule.Relation === 'or' ? 'selected' : ''}>OR (‰ªªÊÑèÊù°‰ª∂Êª°Ë∂≥)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ËßÑÂàôÊèèËø∞</label>
                            <textarea name="description" class="form-control">${rule.Description || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Âà§Êñ≠Êù°‰ª∂</label>
                            <div id="edit-judges-container">
                                ${rule.Judges.map((judge, index) => `
                                    <div class="judge-item" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                            <select name="position" class="form-control" required>
                                                <option value="uri" ${judge.Position === 'uri' ? 'selected' : ''}>URI</option>
                                                <option value="request_header" ${judge.Position === 'request_header' ? 'selected' : ''}>ËØ∑Ê±ÇÂ§¥</option>
                                                <option value="request_body" ${judge.Position === 'request_body' ? 'selected' : ''}>ËØ∑Ê±Ç‰Ωì</option>
                                                <option value="parameter_value" ${judge.Position === 'parameter_value' ? 'selected' : ''}>ÂèÇÊï∞ÂÄº</option>
                                                <option value="form_values" ${judge.Position === 'form_values' ? 'selected' : ''}>Ë°®ÂçïÂÄº</option>
                                            </select>
                                            <input type="text" name="content" class="form-control" value="${judge.Content || ''}" placeholder="ÂåπÈÖçÂÜÖÂÆπ (ÂèØÈÄâ)">
                                            <input type="text" name="rix" class="form-control" value="${judge.Rix || ''}" placeholder="Ê≠£ÂàôË°®ËææÂºè (ÂèØÈÄâ)">
                                            <select name="action" class="form-control">
                                                <option value="is" ${judge.Action === 'is' ? 'selected' : ''}>ÂåπÈÖç (is)</option>
                                                <option value="not" ${judge.Action === 'not' ? 'selected' : ''}>‰∏çÂåπÈÖç (not)</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-danger" onclick="removeJudge(this)" style="padding: 5px 10px; font-size: 12px;">Âà†Èô§Êù°‰ª∂</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addEditJudge()" style="margin-top: 10px;">
                                <span>+</span> Ê∑ªÂä†Êù°‰ª∂
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: inline-flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="enabled" ${rule.Enabled ? 'checked' : ''}> ÂêØÁî®ËßÑÂàô
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                            <button type="submit" class="btn">Êõ¥Êñ∞ËßÑÂàô</button>
                        </div>
                    </form>
                `;

                document.getElementById('edit-custom-rule-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    updateCustomRule(new FormData(this));
                });

                showModal();
            } else {
                showMessage('ËßÑÂàô‰∏çÂ≠òÂú®', 'error');
            }
        } else {
            showMessage('Âä†ËΩΩËßÑÂàôÂ§±Ë¥•', 'error');
        }
    } catch (error) {
        console.error('Âä†ËΩΩËßÑÂàôÈîôËØØ:', error);
        showMessage('Âä†ËΩΩËßÑÂàôÂ§±Ë¥•', 'error');
    }
}

// ÂêåÊ†∑‰øÆÊîπÁºñËæëÊ®°ÊÄÅÊ°ÜÁöÑÊ∑ªÂä†Êù°‰ª∂ÂáΩÊï∞
function addEditJudge() {
    const container = document.getElementById('edit-judges-container');
    const judgeItem = document.createElement('div');
    judgeItem.className = 'judge-item';
    judgeItem.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;';
    
    judgeItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <select name="position" class="form-control" required>
                <option value="uri">URI</option>
                <option value="request_header">ËØ∑Ê±ÇÂ§¥</option>
                <option value="request_body">ËØ∑Ê±Ç‰Ωì</option>
                <option value="parameter_value">ÂèÇÊï∞ÂÄº</option>
                <option value="form_values">Ë°®ÂçïÂÄº</option>
            </select>
            <input type="text" name="content" class="form-control" placeholder="ÂåπÈÖçÂÜÖÂÆπ (‰∏éÊ≠£Âàô‰∫åÈÄâ‰∏Ä)">
            <input type="text" name="rix" class="form-control" placeholder="Ê≠£ÂàôË°®ËææÂºè (‰∏éÂÜÖÂÆπ‰∫åÈÄâ‰∏Ä)">
            <select name="action" class="form-control">
                <option value="is">ÂåπÈÖç (is)</option>
                <option value="not">‰∏çÂåπÈÖç (not)</option>
            </select>
        </div>
        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
            <strong>ÊèêÁ§∫:</strong> ÂÜÖÂÆπÂíåÊ≠£ÂàôË°®ËææÂºèËá≥Â∞ëÂ°´ÂÜô‰∏Ä‰∏™
        </div>
        <button type="button" class="btn btn-danger" onclick="removeJudge(this)" style="padding: 5px 10px; font-size: 12px;">Âà†Èô§Êù°‰ª∂</button>
    `;
    
    container.appendChild(judgeItem);
}


// ‰øÆÊîπÊõ¥Êñ∞Ëá™ÂÆö‰πâËßÑÂàôÂáΩÊï∞
// ‰øÆÊîπÊõ¥Êñ∞Ëá™ÂÆö‰πâËßÑÂàôÂáΩÊï∞
async function updateCustomRule(formData) {
    try {
        const data = Object.fromEntries(formData);
        
        // Â§ÑÁêÜÂà§Êñ≠Êù°‰ª∂ - Á°Æ‰øùÂ≠óÊÆµÂêçÁß∞Ê≠£Á°Æ
        const judges = [];
        const judgeItems = document.querySelectorAll('#edit-judges-container .judge-item');
        
        judgeItems.forEach(item => {
            const judge = {
                position: item.querySelector('select[name="position"]').value,
                content: item.querySelector('input[name="content"]').value,
                rix: item.querySelector('input[name="rix"]').value,
                action: item.querySelector('select[name="action"]').value || 'is'
            };
            
            if (!judge.content && !judge.rix) {
                return;
            }
            
            if (judge.rix) {
                try {
                    new RegExp(judge.rix);
                } catch (e) {
                    showMessage(`Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ: ${judge.rix}`, 'error');
                    throw new Error('Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ');
                }
            }
            
            judges.push(judge);
        });
        
        if (judges.length === 0) {
            showMessage('Ëá≥Â∞ëÈúÄË¶ÅÈÖçÁΩÆ‰∏Ä‰∏™ÊúâÊïàÁöÑÂà§Êñ≠Êù°‰ª∂', 'error');
            return;
        }
        
        // ÊûÑÂª∫Ê≠£Á°ÆÁöÑËØ∑Ê±ÇÊï∞ÊçÆ - ‰ΩøÁî® judges ËÄå‰∏çÊòØ judge
        const requestData = {
            name: data.name,
            description: data.description || '',
            method: data.method,
            relation: data.relation || 'and',
            judges: judges,  // ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ΩøÁî® judges ËÄå‰∏çÊòØ judge
            enabled: data.enabled === 'on'
        };

        const response = await fetch(`/api/custom-rules/${data.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            closeModal();
            showMessage('Ëá™ÂÆö‰πâËßÑÂàôÊõ¥Êñ∞ÊàêÂäü', 'success');
            loadCustomRules();
        } else {
            const errorText = await response.text();
            let errorMessage = 'Êõ¥Êñ∞Â§±Ë¥•';
            try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorText;
            } catch {
                errorMessage = errorText;
            }
            showMessage('Êõ¥Êñ∞Â§±Ë¥•: ' + errorMessage, 'error');
        }
    } catch (error) {
        console.error('Êõ¥Êñ∞Ëá™ÂÆö‰πâËßÑÂàôÈîôËØØ:', error);
        if (error.message !== 'Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ') {
            showMessage('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
        }
    }
}

// ÂàáÊç¢Ëá™ÂÆö‰πâËßÑÂàôÁä∂ÊÄÅ
// ÂàáÊç¢Ëá™ÂÆö‰πâËßÑÂàôÁä∂ÊÄÅ
async function toggleCustomRuleStatus(ruleId, enabled) {
    const action = enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
    
    if (!confirm(`Á°ÆÂÆöË¶Å${action}ËøôÊù°ËßÑÂàôÂêóÔºü`)) return;
    
    try {
        const response = await fetch(`/api/custom-rules/${ruleId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ enabled })
        });

        if (response.ok) {
            showMessage(`ËßÑÂàô${action}ÊàêÂäü`, 'success');
            loadCustomRules();
        } else {
            const error = await response.text();
            showMessage(`${action}Â§±Ë¥•: ${error}`, 'error');
        }
    } catch (error) {
        console.error(`${action}ËßÑÂàôÈîôËØØ:`, error);
        showMessage(`${action}Â§±Ë¥•`, 'error');
    }
}

// Âà†Èô§Ëá™ÂÆö‰πâËßÑÂàô
async function deleteCustomRule(ruleId) {
    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËßÑÂàôÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) return;
    
    try {
        const response = await fetch(`/api/custom-rules/${ruleId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            showMessage('ËßÑÂàôÂà†Èô§ÊàêÂäü', 'success');
            loadCustomRules();
        } else {
            showMessage('Âà†Èô§Â§±Ë¥•', 'error');
        }
    } catch (error) {
        console.error('Âà†Èô§ËßÑÂàôÈîôËØØ:', error);
        showMessage('Âà†Èô§Â§±Ë¥•', 'error');
    }
}

// ÂØºÂá∫ËßÑÂàô
function exportCustomRules() {
    window.open('/api/custom-rules/export', '_blank');
}

// ÊòæÁ§∫ÂØºÂÖ•ËßÑÂàôÊ®°ÊÄÅÊ°Ü
function showImportRulesModal() {
    document.getElementById('modal-title').textContent = 'ÂØºÂÖ•Ëá™ÂÆö‰πâËßÑÂàô';
    document.getElementById('modal-body').innerHTML = `
        <form id="import-rules-form" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label">ÈÄâÊã©ËßÑÂàôÊñá‰ª∂</label>
                <input type="file" name="file" class="form-control" accept=".zip" required>
                <small style="color: #666;">ËØ∑ÈÄâÊã©‰πãÂâçÂØºÂá∫ÁöÑZIPÊ†ºÂºèËßÑÂàôÊñá‰ª∂</small>
            </div>
            
            <div class="alert alert-success">
                <strong>ÂØºÂÖ•ËØ¥Êòé:</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li>‰ªÖÊîØÊåÅZIPÊ†ºÂºèÁöÑËßÑÂàôÂ§á‰ªΩÊñá‰ª∂</li>
                    <li>ÂØºÂÖ•ÁöÑËßÑÂàô‰ºöË¶ÜÁõñÂêåIDÁöÑÁé∞ÊúâËßÑÂàô</li>
                    <li>Âª∫ËÆÆÂú®ÂØºÂÖ•ÂâçÂÖàÂØºÂá∫ÂΩìÂâçËßÑÂàô‰Ωú‰∏∫Â§á‰ªΩ</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button type="submit" class="btn">ÂØºÂÖ•ËßÑÂàô</button>
            </div>
        </form>
    `;

    document.getElementById('import-rules-form').addEventListener('submit', function(e) {
        e.preventDefault();
        importCustomRules(new FormData(this));
    });

    showModal();
}

// ÂØºÂÖ•ËßÑÂàô
async function importCustomRules(formData) {
    try {
        const response = await fetch('/api/custom-rules/import', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            closeModal();
            showMessage(`ËßÑÂàôÂØºÂÖ•ÊàêÂäüÔºåÂÖ±ÂØºÂÖ• ${result.imported_count} Êù°ËßÑÂàô`, 'success');
            loadCustomRules();
        } else {
            const error = await response.text();
            showMessage('ÂØºÂÖ•Â§±Ë¥•: ' + error, 'error');
        }
    } catch (error) {
        console.error('ÂØºÂÖ•ËßÑÂàôÈîôËØØ:', error);
        showMessage('ÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'error');
    }
}

// ÈáçÊñ∞Âä†ËΩΩËá™ÂÆö‰πâËßÑÂàô
async function reloadCustomRules() {
    try {
        const response = await fetch('/api/custom-rules/reload', {
            method: 'POST',
            credentials: 'include'
        });

        if (response.ok) {
            const result = await response.json();
            showMessage(`ËßÑÂàôÈáçÊñ∞Âä†ËΩΩÊàêÂäüÔºåÂÖ±Âä†ËΩΩ ${result.count} Êù°ËßÑÂàô`, 'success');
            loadCustomRules();
        } else {
            showMessage('ÈáçÊñ∞Âä†ËΩΩÂ§±Ë¥•', 'error');
        }
    } catch (error) {
        console.error('ÈáçÊñ∞Âä†ËΩΩËßÑÂàôÈîôËØØ:', error);
        showMessage('ÈáçÊñ∞Âä†ËΩΩÂ§±Ë¥•', 'error');
    }
}

            // Ëé∑ÂèñÊâÄÊúâËßÑÂàôÁî®‰∫éÊòæÁ§∫ÂêçÁß∞
async function getAllRules() {
    try {
        // ËøôÈáåÈúÄË¶ÅË∞ÉÁî®Ëé∑ÂèñÊâÄÊúâËßÑÂàôÁöÑÊé•Âè£
        // ÊöÇÊó∂ËøîÂõûÁ©∫ÂØπË±°ÔºåÂÆûÈôÖ‰ΩøÁî®Êó∂ÈúÄË¶ÅÂÆûÁé∞Ëøô‰∏™Êé•Âè£
        return {};
    } catch (error) {
        console.error('Ëé∑ÂèñËßÑÂàôÂàóË°®ÈîôËØØ:', error);
        return {};
    }
}

// Âä†ËΩΩÁ≥ªÁªüÁõëÊéßÊï∞ÊçÆ
async function loadSystemMonitor() {
    try {
        const response = await fetch('/api/monitor/system', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            displaySystemMonitor(data);
        } else {
            console.error('Ëé∑ÂèñÁ≥ªÁªüÁõëÊéßÊï∞ÊçÆÂ§±Ë¥•:', response.status);
            displaySystemMonitorError();
        }
    } catch (error) {
        console.error('Ëé∑ÂèñÁ≥ªÁªüÁõëÊéßÊï∞ÊçÆÈîôËØØ:', error);
        displaySystemMonitorError();
    }
}

// ÊòæÁ§∫Á≥ªÁªüÁõëÊéßÊï∞ÊçÆ
function displaySystemMonitor(data) {
    // ÊòæÁ§∫Á´ØÂè£ÁªüËÆ°
    displayPortStats(data.port_stats);
    
    // ÊòæÁ§∫CPUÁªüËÆ°
    displayCPUStats(data.cpu_stats);
    
    // ÊòæÁ§∫ÂÜÖÂ≠òÁªüËÆ°
    displayMemoryStats(data.memory_stats);
}

// ÊòæÁ§∫Á´ØÂè£ÁªüËÆ°
function displayPortStats(portStats) {
    const container = document.getElementById('port-stats-container');
    const isDark = document.body.classList.contains('dark-theme');
    const primaryColor = isDark ? '#58a6ff' : '#5210ed';
    const textColor = isDark ? '#adbac7' : '#666';
    
    container.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: ${primaryColor}; margin-bottom: 10px;">
                ${portStats.total_connections}
            </div>
            <div style="font-size: 14px; color: ${textColor}; margin-bottom: 15px;">
                ÊÄªËøûÊé•Êï∞
            </div>
            <div style="display: flex; justify-content: space-around; font-size: 12px;">
                <div>
                    <div style="color: #2ed573; font-size: 18px;font-weight: bold;">80Á´ØÂè£</div>
                    <div style="font-weight: bold; font-size: 20px; color: ${textColor};">${portStats.port_80_rate}</div>
                </div>
                <div>
                    <div style="color: #1e90ff;font-size: 18px;font-weight: bold;">443Á´ØÂè£</div>
                    <div style="font-weight: bold; font-size: 20px; color: ${textColor};">${portStats.port_443_rate}</div>
                </div>
            </div>
        </div>
    `;
}

// ÊòæÁ§∫CPUÁªüËÆ°
function displayCPUStats(cpuStats) {
    const container = document.getElementById('cpu-stats-container');
    const usagePercent = parseFloat(cpuStats.usage_percent);
    const isDark = document.body.classList.contains('dark-theme');
    const primaryColor = isDark ? '#58a6ff' : '#5210ed';
    const textColor = isDark ? '#768390' : '#666';
    const secondaryTextColor = isDark ? '#768390' : '#888';
    
    container.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: ${primaryColor}; margin-bottom: 10px;">
                ${usagePercent.toFixed(1)}%
            </div>
            <div style="font-size: 14px; color: ${textColor}; margin-bottom: 15px;">
                CPU‰ΩøÁî®Áéá
            </div>
            <div style="font-size: 12px; color: ${secondaryTextColor};">
                Ë¥üËΩΩ: ${cpuStats.load_average_1} | ${cpuStats.load_average_5} | ${cpuStats.load_average_15}
            </div>
            <div style="font-size: 11px; color: ${secondaryTextColor};">
                ${cpuStats.cores} Ê†∏ÂøÉ
            </div>
        </div>
    `;
}

// ÊòæÁ§∫ÂÜÖÂ≠òÁªüËÆ°
function displayMemoryStats(memoryStats) {
    const container = document.getElementById('memory-stats-container');
    const usagePercent = parseFloat(memoryStats.usage_percent);
    const isDark = document.body.classList.contains('dark-theme');
    const primaryColor = isDark ? '#58a6ff' : '#5210ed';
    const textColor = isDark ? '#768390' : '#666';
    const secondaryTextColor = isDark ? '#768390' : '#888';
    
    container.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: ${primaryColor}; margin-bottom: 10px;">
                ${usagePercent.toFixed(1)}%
            </div>
            <div style="font-size: 14px; color: ${textColor}; margin-bottom: 15px;">
                ÂÜÖÂ≠ò‰ΩøÁî®Áéá
            </div>
            <div style="font-size: 12px; color: ${textColor};">
                Â∑≤Áî®: ${memoryStats.used}
            </div>
            <div style="font-size: 11px; color: ${secondaryTextColor};">
                ÊÄªÂÖ±: ${memoryStats.total}
            </div>
        </div>
    `;
}

// ÊòæÁ§∫Á≥ªÁªüÁõëÊéßÈîôËØØ
function displaySystemMonitorError() {
    const errorHtml = '<div class="alert alert-error">Á≥ªÁªüÁõëÊéßÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</div>';
    
    document.getElementById('port-stats-container').innerHTML = errorHtml;
    document.getElementById('cpu-stats-container').innerHTML = errorHtml;
    document.getElementById('memory-stats-container').innerHTML = errorHtml;
}





            // ËÆ°ÁÆóÂ≠òÊ¥ªÁ´ôÁÇπÊï∞Èáè
                function calculateAliveSites() {
                        if (!window.siteHealthData) return 0;

                        let aliveCount = 0;
                        Object.values(window.siteHealthData).forEach(health => {
                            if (health.is_alive) {
                                aliveCount++;
                            }
                        });
                        return aliveCount;
                    }

                
                        


        // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
            // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
async function loadStats() {
    try {
        // Âπ∂Ë°åÂä†ËΩΩÂü∫Êú¨ÁªüËÆ°ÂíåÁ≥ªÁªüÁõëÊéß
        const [statsResponse, monitorResponse] = await Promise.all([
            fetch('/api/stats', { method: 'GET', credentials: 'include' }),
            fetch('/api/monitor/system', { method: 'GET', credentials: 'include' })
        ]);

        // Â§ÑÁêÜÂü∫Êú¨ÁªüËÆ°Êï∞ÊçÆ
        if (statsResponse.ok) {
            const stats = await statsResponse.json();
            
            // ËÆ°ÁÆóÂ≠òÊ¥ªÁ´ôÁÇπÊï∞Èáè
            const aliveSites = calculateAliveSites();

            // Ê£ÄÊü•Êï∞ÊçÆÂèòÂåñÂπ∂Ê∑ªÂä†Âä®Áîª
            checkAndAnimateValueChange('total-requests', stats.total_requests, previousStats.total_requests);
            checkAndAnimateValueChange('blocked-requests', stats.blocked_requests, previousStats.blocked_requests);
            checkAndAnimateValueChange('total-sites', stats.total_sites, previousStats.total_sites);
            checkAndAnimateValueChange('alive-sites', aliveSites, previousStats.alive_sites);

            // Êõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
            document.getElementById('total-requests').textContent = stats.total_requests.toLocaleString();
            document.getElementById('blocked-requests').textContent = stats.blocked_requests.toLocaleString();
            document.getElementById('total-sites').textContent = stats.total_sites;
            document.getElementById('alive-sites').textContent = aliveSites;


            // ‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆÁî®‰∫é‰∏ãÊ¨°ÊØîËæÉ
            previousStats = {
                total_requests: stats.total_requests,
                blocked_requests: stats.blocked_requests,
                total_sites: stats.total_sites,
                alive_sites: aliveSites
            };
        } else {
            console.error('Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', statsResponse.status);
        }

        // Â§ÑÁêÜÁ≥ªÁªüÁõëÊéßÊï∞ÊçÆ
        if (monitorResponse.ok) {
            const monitorData = await monitorResponse.json();
            displaySystemMonitor(monitorData);
        } else {
            console.error('Ëé∑ÂèñÁ≥ªÁªüÁõëÊéßÊï∞ÊçÆÂ§±Ë¥•:', monitorResponse.status);
            displaySystemMonitorError();
        }

        // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

    } catch (error) {
        console.error('Ëé∑ÂèñÊï∞ÊçÆÈîôËØØ:', error);
        displaySystemMonitorError();
    }
}
            // Ê£ÄÊü•Êï∞ÂÄºÂèòÂåñÂπ∂Ê∑ªÂä†Âä®Áîª
                function checkAndAnimateValueChange(elementId, newValue, oldValue) {
                        if (newValue !== oldValue) {
                            const element = document.getElementById(elementId);
                            if (element) {
                                element.classList.add('value-changing');

                                // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§Á±ª
                                setTimeout(() => {
                                    element.classList.remove('value-changing');
                                }, 500);
                            }
                        }
                    }

        // Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
        function refreshStats() {
                loadStats();
                // ÂêåÊó∂Âà∑Êñ∞ÂÅ•Â∫∑Áä∂ÊÄÅ‰ª•Ëé∑ÂèñÊúÄÊñ∞ÁöÑÁ´ôÁÇπÂ≠òÊ¥ªÊï∞ÊçÆ
                loadSiteHealthStatus();
            }

        // Âä†ËΩΩACLËßÑÂàô
        async function loadACLRules() {
            try {
                const response = await fetch('/api/acl/rules', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayACLRules(data.rules);
                } else {
                    document.getElementById('acl-rules-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩACLËßÑÂàôÂ§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩACLËßÑÂàôÈîôËØØ:', error);
                document.getElementById('acl-rules-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩACLËßÑÂàôÂ§±Ë¥•</div>';
            }
        }

        // ÊòæÁ§∫ACLËßÑÂàô
        function displayACLRules(rules) {
    const container = document.getElementById('acl-rules-container');
    
    if (!rules || rules.length === 0) {
        container.innerHTML = '<div class="alert">ÊöÇÊó†ACLËßÑÂàô</div>';
        return;
    }
    
    // ÂàÜÈ°µÂ§ÑÁêÜ
    const pageSize = 10;
    const totalPages = Math.ceil(rules.length / pageSize);
    const currentPage = 1;
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const displayRules = rules.slice(startIndex, endIndex);
    
    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Á±ªÂûã</th>
                        <th>‰∏ªÊú∫</th>
                        <th>ËßÑÂàôÁ±ªÂûã</th>
                        <th>Ê®°Âºè</th>
                        <th>Âä®‰Ωú</th>
                        <th>ÊèèËø∞</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    displayRules.forEach(rule => {
        html += `
            <tr>
                <td>${rule.id}</td>
                <td>${rule.type}</td>
                <td>${rule.host || '-'}</td>
                <td>${rule.rule_type}</td>
                        <td title="${rule.pattern}">${rule.pattern.length > 20 ? rule.pattern.substring(0, 20) + '...' : rule.pattern}</td>
                <td>
                    <span class="status-indicator ${rule.action === 'allow' ? 'status-active' : 'status-inactive'}">
                        ${rule.action === 'allow' ? 'ÂÖÅËÆ∏' : 'ÈòªÊ≠¢'}
                    </span>
                </td>
                <td title="${rule.description || '-'}">${rule.description ? (rule.description.length > 15 ? rule.description.substring(0, 15) + '...' : rule.description) : '-'}</td>
                <td>
                    <button class="btn ${rule.enabled ? 'btn-success' : 'btn-secondary'}" 
                            onclick="toggleACLRuleStatus(${rule.id}, ${!rule.enabled})"
                            title="ÁÇπÂáªÂàáÊç¢Áä∂ÊÄÅ">
                        ${rule.enabled ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}
                    </button>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-danger" onclick="deleteACLRule(${rule.id})">Âà†Èô§</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            ÊòæÁ§∫ 1-${displayRules.length} Êù°ÔºåÂÖ± ${rules.length} Êù°ËßÑÂàô
        </div>
    `;
    
    container.innerHTML = html;
}

        // ÊòæÁ§∫Ê∑ªÂä†ACLËßÑÂàôÊ®°ÊÄÅÊ°Ü
        function showAddACLModal() {
            document.getElementById('modal-title').textContent = 'Ê∑ªÂä†ACLËßÑÂàô';
            document.getElementById('modal-body').innerHTML = `
                <form id="add-acl-form">
                    <div class="form-group">
                        <label class="form-label">ËßÑÂàôÁ±ªÂûã</label>
                        <select name="type" class="form-control" required>
                            <option value="global">ÂÖ®Â±ÄËßÑÂàô</option>
                            <option value="host">‰∏ªÊú∫ËßÑÂàô</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="host-field" style="display: none;">
                        <label class="form-label">‰∏ªÊú∫Âêç</label>
                        <input type="text" name="host" class="form-control" placeholder="‰æãÂ¶Ç: example.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ËßÑÂàôÁ±ªÂûã</label>
                        <select name="rule_type" class="form-control" required>
                            <option value="ip">IPÂú∞ÂùÄ</option>
                            <option value="user_agent">User Agent</option>
                            <option value="referer">Referer</option>
                            <option value="path">Ë∑ØÂæÑ</option>
                            <option value="country">ÂõΩÂÆ∂</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂåπÈÖçÊ®°Âºè</label>
                        <input type="text" name="pattern" class="form-control" placeholder="‰æãÂ¶Ç: 192.168.1.* Êàñ ^/admin" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Âä®‰Ωú</label>
                        <div>
                            <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                                <input type="radio" name="action" value="allow" checked> ÂÖÅËÆ∏
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 8px;">
                                <input type="radio" name="action" value="block"> ÈòªÊ≠¢
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊèèËø∞</label>
                        <textarea name="description" class="form-control" placeholder="ËßÑÂàôÊèèËø∞"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: inline-flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="enabled" checked> ÂêØÁî®ËßÑÂàô
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                        <button type="submit" class="btn">Ê∑ªÂä†ËßÑÂàô</button>
                    </div>
                </form>
            `;
            
            // ÊòæÁ§∫/ÈöêËóè‰∏ªÊú∫Â≠óÊÆµ
            document.querySelector('select[name="type"]').addEventListener('change', function() {
                document.getElementById('host-field').style.display = this.value === 'host' ? 'block' : 'none';
            });
            
            // Ë°®ÂçïÊèê‰∫§
            document.getElementById('add-acl-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addACLRule(new FormData(this));
            });
            
            showModal();
        }

        // Ê∑ªÂä†ACLËßÑÂàô
        async function addACLRule(formData) {
            try {
                const data = Object.fromEntries(formData);
                data.enabled = data.enabled === 'on';
                
                const response = await fetch('/api/acl/rules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    showMessage('ACLËßÑÂàôÊ∑ªÂä†ÊàêÂäü', 'success');
                    loadACLRules();
                } else {
                    const error = await response.text();
                    showMessage('Ê∑ªÂä†Â§±Ë¥•: ' + error, 'error');
                }
            } catch (error) {
                console.error('Ê∑ªÂä†ACLËßÑÂàôÈîôËØØ:', error);
                showMessage('Ê∑ªÂä†Â§±Ë¥•', 'error');
            }
        }

        // ÂàáÊç¢ACLËßÑÂàôÁä∂ÊÄÅ
        async function toggleACLRuleStatus(id, enabled) {
            try {
                const response = await fetch(`/api/acl/rules/${id}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ enabled: enabled })
                });

                if (response.ok) {
                    const data = await response.json();
                    showMessage(data.message || 'ACLËßÑÂàôÁä∂ÊÄÅÂàáÊç¢ÊàêÂäü', 'success');
                    loadACLRules();
                } else {
                    const error = await response.text();
                    showMessage('ÂàáÊç¢Â§±Ë¥•: ' + error, 'error');
                }
            } catch (error) {
                console.error('ÂàáÊç¢ACLËßÑÂàôÁä∂ÊÄÅÈîôËØØ:', error);
                showMessage('ÂàáÊç¢Â§±Ë¥•', 'error');
            }
        }

        // Âà†Èô§ACLËßÑÂàô
        async function deleteACLRule(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ACLËßÑÂàôÂêóÔºü')) return;
            
            try {
                const response = await fetch(`/api/acl/rules/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showMessage('ACLËßÑÂàôÂà†Èô§ÊàêÂäü', 'success');
                    loadACLRules();
                } else {
                    showMessage('Âà†Èô§Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âà†Èô§ACLËßÑÂàôÈîôËØØ:', error);
                showMessage('Âà†Èô§Â§±Ë¥•', 'error');
            }
        }

        // Âä†ËΩΩÁºìÂ≠òÁªüËÆ°
        async function loadCacheStats() {
            try {
                const response = await fetch('/api/cache/stats', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const stats = await response.json();
                    displayCacheStats(stats);
                } else {
                    document.getElementById('cache-stats-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩÁºìÂ≠òÁªüËÆ°Â§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁºìÂ≠òÁªüËÆ°ÈîôËØØ:', error);
                document.getElementById('cache-stats-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩÁºìÂ≠òÁªüËÆ°Â§±Ë¥•</div>';
            }
        }

        // ÊòæÁ§∫ÁºìÂ≠òÁªüËÆ°
        // ÊòæÁ§∫ÁºìÂ≠òÁªüËÆ°
            function displayCacheStats(stats) {
                const container = document.getElementById('cache-stats-container');

                container.innerHTML = `
        <div class="metric-row">
            <div class="metric-card">
                <div class="metric-icon">üìä</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.cache_hits}</div>
                    <div class="metric-label">ÁºìÂ≠òÂëΩ‰∏≠</div>
                </div>
            </div>
            
            <div class="metric-card clickable" onclick="window.loadCacheFiles(1)" style="cursor: pointer;">
                <div class="metric-icon">üìÅ</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.cached_files}</div>
                    <div class="metric-label">ÁºìÂ≠òÊñá‰ª∂Êï∞</div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">üîí</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.enable ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}</div>
                    <div class="metric-label">ÁºìÂ≠òÁä∂ÊÄÅ</div>
                </div>
            </div>
        </div>
        
        <div class="metric-row">
            <div class="metric-card small">
                <div class="metric-content">
                    <div class="metric-value">${stats.current_size}</div>
                    <div class="metric-label">ÁºìÂ≠òÂ§ßÂ∞è</div>
                </div>
            </div>
        </div>
    `;
            }

        // Âä†ËΩΩÁºìÂ≠òÈÖçÁΩÆ
        async function loadCacheConfig() {
            try {
                const response = await fetch('/api/cache/stats', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const stats = await response.json();
                    displayCacheConfig(stats);
                } else {
                    document.getElementById('cache-config-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩÁºìÂ≠òÈÖçÁΩÆÂ§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁºìÂ≠òÈÖçÁΩÆÈîôËØØ:', error);
                document.getElementById('cache-config-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩÁºìÂ≠òÈÖçÁΩÆÂ§±Ë¥•</div>';
            }
        }

        // ÊòæÁ§∫ÁºìÂ≠òÈÖçÁΩÆ
        // ‰øÆÊîπÊòæÁ§∫ÁºìÂ≠òÈÖçÁΩÆÂáΩÊï∞
            function displayCacheConfig(stats) {
                const container = document.getElementById('cache-config-container');

                // ‰øÆÂ§çÔºöÊ≠£Á°ÆËß£ÊûêÊúÄÂ§ßÁºìÂ≠òÂ§ßÂ∞è
                const maxSizeMB = stats.max_size ? parseInt(stats.max_size) : 100;

                container.innerHTML = `
        <form id="cache-config-form">
            <div class="form-group">
                <label class="form-label">ÂêØÁî®ÁºìÂ≠ò</label>
                <div>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="enable" value="true" ${stats.enable ? 'checked' : ''}> ÂêØÁî®
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="radio" name="enable" value="false" ${!stats.enable ? 'checked' : ''}> Á¶ÅÁî®
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ÊúÄÂ§ßÁºìÂ≠òÂ§ßÂ∞è (MB)</label>
                <input type="number" name="max_size_mb" class="form-control" value="${maxSizeMB}">
            </div>
            
            <button type="submit" class="btn">‰øùÂ≠òÈÖçÁΩÆ</button>
        </form>
    `;

                document.getElementById('cache-config-form').addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateCacheConfig(new FormData(this));
                });
            }

        // Êõ¥Êñ∞ÁºìÂ≠òÈÖçÁΩÆ
        async function updateCacheConfig(formData) {
            try {
                const data = Object.fromEntries(formData);
                data.enable = data.enable === 'true';
                data.max_size_mb = parseInt(data.max_size_mb);
                
                const response = await fetch('/api/cache/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showMessage('ÁºìÂ≠òÈÖçÁΩÆÊõ¥Êñ∞ÊàêÂäü', 'success');
                    loadCacheStats();
                    loadCacheConfig();
                } else {
                    showMessage('Êõ¥Êñ∞Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÁºìÂ≠òÈÖçÁΩÆÈîôËØØ:', error);
                showMessage('Êõ¥Êñ∞Â§±Ë¥•', 'error');
            }
        }

        // Ê∏ÖÁ©∫ÁºìÂ≠ò
        async function clearCache() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÁºìÂ≠òÂêóÔºü')) return;
            
            try {
                const response = await fetch('/api/cache/clear', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    showMessage('ÁºìÂ≠òÂ∑≤Ê∏ÖÁ©∫', 'success');
                    loadCacheStats();
                } else {
                    showMessage('Ê∏ÖÁ©∫ÁºìÂ≠òÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ê∏ÖÁ©∫ÁºìÂ≠òÈîôËØØ:', error);
                showMessage('Ê∏ÖÁ©∫ÁºìÂ≠òÂ§±Ë¥•', 'error');
            }
        }

        // Âà∑Êñ∞ÁºìÂ≠òÁªüËÆ°
        function refreshCacheStats() {
            loadCacheStats();
            loadCacheConfig();
            window.loadCacheFiles(1); // ÂêåÊó∂Âà∑Êñ∞Êñá‰ª∂ÂàóË°®
        }

        // ÂàáÊç¢Á´ôÁÇπÁä∂ÊÄÅ
async function toggleSiteStatus(siteId, newStatus) {
    const action = newStatus === 1 ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
    
    if (!confirm(`Á°ÆÂÆöË¶Å${action}Ëøô‰∏™Á´ôÁÇπÂêóÔºü`)) return;
    
    try {
        const response = await fetch('/api/site/status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ 
                id: parseInt(siteId), 
                status: parseInt(newStatus)
            })
        });

        if (response.ok) {
            showMessage(`Á´ôÁÇπ${action}ÊàêÂäü`, 'success');
            loadSites();
        } else {
            const error = await response.text();
            showMessage(`${action}Â§±Ë¥•: ${error}`, 'error');
        }
    } catch (error) {
        console.error(`${action}Á´ôÁÇπÈîôËØØ:`, error);
        showMessage(`${action}Â§±Ë¥•`, 'error');
    }
}

        // Âä†ËΩΩÁ´ôÁÇπÂàóË°®
        async function loadSites() {
            try {
                const response = await fetch('/api/sites', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySites(data.sites);
                } else {
                    document.getElementById('sites-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩÁ´ôÁÇπÂàóË°®Â§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ´ôÁÇπÂàóË°®ÈîôËØØ:', error);
                document.getElementById('sites-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩÁ´ôÁÇπÂàóË°®Â§±Ë¥•</div>';
            }
        }

        // ÊòæÁ§∫Á´ôÁÇπÂàóË°®
    // ‰øÆÊîπdisplaySitesÂáΩÊï∞ÔºåÊòæÁ§∫ËØÅ‰π¶‰ø°ÊÅØ
    function displaySites(sites) {
    const container = document.getElementById('sites-container');

    if (!sites || sites.length === 0) {
        container.innerHTML = '<div class="alert">ÊöÇÊó†Á´ôÁÇπ</div>';
        return;
    }

    // ÂàÜÈ°µÂ§ÑÁêÜ
    const pageSize = 10;
    const totalPages = Math.ceil(sites.length / pageSize);
    const currentPage = 1;
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const displaySites = sites.slice(startIndex, endIndex);

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ÂêçÁß∞</th>
                        <th>ÂüüÂêç</th>
                        <th>ÁõÆÊ†áURL/Ë¥üËΩΩÂùáË°°</th>
                        <th>HTTPS</th>
                        <th>ËØÅ‰π¶Áä∂ÊÄÅ</th>
                        <th>Á´ôÁÇπÁä∂ÊÄÅ</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
    `;

    displaySites.forEach(site => {
        // Ëé∑ÂèñÁ´ôÁÇπÂÅ•Â∫∑Áä∂ÊÄÅ
        const isTargetAlive = window.siteHealthData && window.siteHealthData[site.id] ? window.siteHealthData[site.id].is_alive : false;
        const rowClass = isTargetAlive ? 'row-alive' : 'row-dead';

        // ËØÅ‰π¶Áä∂ÊÄÅ
        let certStatus = '';
        if (site.enable_https) {
            if (site.cert_id) {
                certStatus = '<span class="status-indicator status-active" title="Â∑≤ÈÖçÁΩÆËØÅ‰π¶">‚úÖ Â∑≤ÈÖçÁΩÆ</span>';
            } else {
                certStatus = '<span class="status-indicator status-inactive" title="Êú™ÈÖçÁΩÆËØÅ‰π¶">‚ùå Êó†ËØÅ‰π¶</span>';
            }
        } else {
            certStatus = '<span class="status-indicator">-</span>';
        }
        
        // Ë¥üËΩΩÂùáË°°‰ø°ÊÅØ - ÊòæÁ§∫‰∏äÊ∏∏ÊúçÂä°Âô®ÂàóË°®
        let targetInfo = '';
        let upstreamDetails = '';
        
        if (site.load_balance_algorithm) {
            const algoText = site.load_balance_algorithm === 'round_robin' ? 'ËΩÆËØ¢' : 'ÊùÉÈáç';
            const serverCount = site.upstream_servers ? site.upstream_servers.length : 0;
            
            // Ëé∑Âèñ‰∏äÊ∏∏ÊúçÂä°Âô®ÂÅ•Â∫∑Áä∂ÊÄÅ
            const upstreamHealth = window.siteHealthData && window.siteHealthData[site.id] && window.siteHealthData[site.id].upstream_server_health ? 
                                   window.siteHealthData[site.id].upstream_server_health : [];
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â±ïÂºÄ
            const isExpanded = expandedUpstreamSites.has(site.id);
            const arrowIcon = isExpanded ? '‚ñ≤' : '‚ñº';
            
            targetInfo = `<span class="clickable" onclick="toggleUpstreamDetails(${site.id})" style="cursor: pointer;">‚öñÔ∏è ${algoText} (${serverCount}) ${arrowIcon}</span>`;
            
            // ÊûÑÂª∫ÂèØÊäòÂè†ÁöÑ‰∏äÊ∏∏ÊúçÂä°Âô®ËØ¶ÊÉÖ
            if (serverCount > 0) {
                let upstreamList = '';
                if (upstreamHealth.length > 0) {
                    // ÊúâÂÅ•Â∫∑Áä∂ÊÄÅÊï∞ÊçÆÔºåÊòæÁ§∫ÂÅ•Â∫∑Áä∂ÊÄÅ
                    upstreamList = upstreamHealth.map(us => {
                        const statusClass = us.is_alive ? 'status-active' : 'status-inactive';
                        const statusText = us.is_alive ? 'Ê≠£Â∏∏' : 'ÂºÇÂ∏∏';
                        const latency = us.latency ? `${us.latency}ms` : 'N/A';
                        const weightDisplay = site.load_balance_algorithm === 'weighted' ? `(${us.weight})` : '';
                        return `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            ${us.url} ${weightDisplay}
                                        </div>
                                        <span class="status-indicator ${statusClass}" title="Âª∂Ëøü: ${latency}">
                                            ${statusText} (${latency})
                                        </span>
                                    </div>
                                </div>`;
                    }).join('');
                } else {
                    // Ê≤°ÊúâÂÅ•Â∫∑Áä∂ÊÄÅÊï∞ÊçÆÔºå‰ªÖÊòæÁ§∫‰∏äÊ∏∏ÊúçÂä°Âô®URL
                    upstreamList = site.upstream_servers.map(us => {
                        const weightDisplay = site.load_balance_algorithm === 'weighted' ? `(${us.weight})` : '';
                        return `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            ${us.url} ${weightDisplay}
                                        </div>
                                        <span class="status-indicator">Âä†ËΩΩ‰∏≠...</span>
                                    </div>
                                </div>`;
                    }).join('');
                }
                
                // Ê†πÊçÆÂ±ïÂºÄÁä∂ÊÄÅËÆæÁΩÆÂàùÂßãÊòæÁ§∫
                const initialDisplay = isExpanded ? 'table-row' : 'none';
                
                upstreamDetails = `
                    <tr id="upstream-details-${site.id}" style="display: ${initialDisplay};">
                        <td colspan="8">
                            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 10px 0;">
                                <strong>‰∏äÊ∏∏ÊúçÂä°Âô®ËØ¶ÊÉÖ:</strong>
                                <div style="margin-top: 10px;">
                                    ${upstreamList}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        } else {
            // ÊôÆÈÄöÁ´ôÁÇπÊòæÁ§∫ÂÅ•Â∫∑Áä∂ÊÄÅ
            const health = window.siteHealthData && window.siteHealthData[site.id] ? window.siteHealthData[site.id] : null;
            if (health) {
                const statusClass = health.is_alive ? 'status-active' : 'status-inactive';
                const statusText = health.is_alive ? 'Ê≠£Â∏∏' : 'ÂºÇÂ∏∏';
                const latency = health.latency ? `${health.latency}ms` : 'N/A';
                targetInfo = `
                    <span title="${site.target_url}">${site.target_url.length > 20 ? site.target_url.substring(0, 20) + '...' : site.target_url}</span>
                    <span class="status-indicator ${statusClass}" title="Âª∂Ëøü: ${latency}" style="margin-left: 8px;">
                        ${statusText} (${latency})
                    </span>
                `;
            } else {
                targetInfo = `<span title="${site.target_url}">${site.target_url.length > 20 ? site.target_url.substring(0, 20) + '...' : site.target_url}</span>`;
            }
        }

        html += `
            <tr class="${rowClass}">
                <td>${site.id}</td>
                <td title="${site.name}">${site.name.length > 15 ? site.name.substring(0, 15) + '...' : site.name}</td>
                <td title="${site.domain}">${site.domain.length > 15 ? site.domain.substring(0, 15) + '...' : site.domain}</td>
                <td>${targetInfo}</td>
                <td>
                    <span class="status-indicator ${site.enable_https ? 'status-active' : 'status-inactive'} clickable" 
                          onclick="toggleSiteHTTPS(${site.id}, ${!site.enable_https})"
                          title="ÁÇπÂáªÂàáÊç¢HTTPSÁä∂ÊÄÅ">
                        ${site.enable_https ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
                    </span>
                </td>
                <td>${certStatus}</td>
                <td>
                    <span class="status-indicator ${site.status === 1 ? 'status-active' : 'status-inactive'} clickable" 
                          onclick="toggleSiteStatus(${site.id}, ${site.status === 1 ? 0 : 1})"
                          title="ÁÇπÂáªÂàáÊç¢Á´ôÁÇπÁä∂ÊÄÅ">
                        ${site.status === 1 ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn" onclick="showEditSiteModal(${site.id})" title="ÁºñËæë">‚úèÔ∏è</button>
                        ${site.enable_https ? `
                            <button class="btn" onclick="manageSiteCertificate(${site.id}, '${site.domain}')" title="ÁÆ°ÁêÜËØÅ‰π¶">üìú</button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="deleteSite(${site.id})">Âà†Èô§</button>
                    </div>
                </td>
            </tr>
            ${upstreamDetails}
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            ÊòæÁ§∫ 1-${displaySites.length} Êù°ÔºåÂÖ± ${sites.length} ‰∏™Á´ôÁÇπ
        </div>
    `;

    container.innerHTML = html;
    
    // ÊÅ¢Â§çÂ±ïÂºÄÁöÑ‰∏äÊ∏∏ÊúçÂä°Âô®ËØ¶ÊÉÖ
    setTimeout(() => {
        restoreExpandedUpstreamDetails();
    }, 0);
}

// Âà∑Êñ∞ÊâÄÊúâÁªüËÆ°Êï∞ÊçÆ
function refreshAllStats() {
    loadStats();
    loadSiteHealthStatus();
}
    // ÁÆ°ÁêÜÁ´ôÁÇπËØÅ‰π¶
        function manageSiteCertificate(siteId, domain) {
            document.getElementById('modal-title').textContent = `ÁÆ°ÁêÜËØÅ‰π¶ - ${domain}`;
            document.getElementById('modal-body').innerHTML = `
        <div style="margin-bottom: 20px;">
            <h4>ÂΩìÂâçËØÅ‰π¶‰ø°ÊÅØ</h4>
            <div id="current-cert-info">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="renew">Êõ¥Êñ∞ËØÅ‰π¶</div>
            <div class="tab" data-tab="replace">ÊõøÊç¢ËØÅ‰π¶</div>
        </div>
        
        <div id="renew-tab" class="tab-content active">
            <form id="renew-cert-form">
                <div class="form-group">
                    <label class="form-label">Êñ∞ÁöÑÊúâÊïàÊúü (Â§©)</label>
                    <input type="number" name="valid_days" class="form-control" value="365" min="1" max="3650">
                </div>
                <button type="submit" class="btn">ÈáçÊñ∞ÁîüÊàêËØÅ‰π¶</button>
            </form>
        </div>
        
        <div id="replace-tab" class="tab-content">
            <form id="replace-cert-form">
                <div class="form-group">
                    <label class="form-label">Êñ∞ÁöÑËØÅ‰π¶ÂÜÖÂÆπ (PEMÊ†ºÂºè)</label>
                    <textarea name="cert_text" class="form-control" rows="6" placeholder="-----BEGIN CERTIFICATE----- ..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Êñ∞ÁöÑÁßÅÈí•ÂÜÖÂÆπ (PEMÊ†ºÂºè)</label>
                    <textarea name="key_text" class="form-control" rows="6" placeholder="-----BEGIN PRIVATE KEY----- ..." required></textarea>
                </div>
                <button type="submit" class="btn">ÊõøÊç¢ËØÅ‰π¶</button>
            </form>
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
            <button class="btn btn-danger" onclick="removeSiteCertificate(${siteId})">
                <span>üóëÔ∏è</span> ÁßªÈô§ËØÅ‰π¶ÔºàÁ¶ÅÁî®HTTPSÔºâ
            </button>
        </div>
    `;

            // Âä†ËΩΩÂΩìÂâçËØÅ‰π¶‰ø°ÊÅØ
            loadCurrentCertificateInfo(siteId);

            // Ê†áÁ≠æÈ°µÂàáÊç¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');

                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });

            // Ë°®ÂçïÊèê‰∫§
            document.getElementById('renew-cert-form').addEventListener('submit', function (e) {
                e.preventDefault();
                renewSiteCertificate(siteId, new FormData(this));
            });

            document.getElementById('replace-cert-form').addEventListener('submit', function (e) {
                e.preventDefault();
                replaceSiteCertificate(siteId, new FormData(this));
            });

            showModal();
        }



        // Âä†ËΩΩÂΩìÂâçËØÅ‰π¶‰ø°ÊÅØ
        async function loadCurrentCertificateInfo(siteId) {
                try {
                    const response = await fetch(`/api/site/${siteId}/certificate`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        displayCurrentCertificateInfo(data.certificate);
                    } else {
                        document.getElementById('current-cert-info').innerHTML =
                            '<div class="alert alert-error">Âä†ËΩΩËØÅ‰π¶‰ø°ÊÅØÂ§±Ë¥•</div>';
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩËØÅ‰π¶‰ø°ÊÅØÈîôËØØ:', error);
                    document.getElementById('current-cert-info').innerHTML =
                        '<div class="alert alert-error">Âä†ËΩΩËØÅ‰π¶‰ø°ÊÅØÂ§±Ë¥•</div>';
                }
            }

       // ÊòæÁ§∫ÂΩìÂâçËØÅ‰π¶‰ø°ÊÅØ
        function displayCurrentCertificateInfo(certInfo) {
            const container = document.getElementById('current-cert-info');

            if (!certInfo || !certInfo.exists) {
                container.innerHTML = '<div class="alert">ËØ•Á´ôÁÇπÊú™ÈÖçÁΩÆËØÅ‰π¶</div>';
                return;
            }

            let html = `
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold; width: 120px;">ÂüüÂêç</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${certInfo.domain}</td>
            </tr>
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ÊúâÊïàÊúü</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${certInfo.valid_from} Ëá≥ ${certInfo.valid_to}</td>
            </tr>
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">Á≠æÂèëËÄÖ</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${certInfo.issuer}</td>
            </tr>
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ËØÅ‰π¶Á±ªÂûã</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${certInfo.is_self_signed ? 'Ëá™Á≠æÂêçËØÅ‰π¶' : 'CAÁ≠æÂèëËØÅ‰π¶'}</td>
            </tr>
        </table>
    `;

            container.innerHTML = html;
        }

        // ÈáçÊñ∞ÁîüÊàêËØÅ‰π¶
            async function renewSiteCertificate(siteId, formData) {
                try {
                    const data = Object.fromEntries(formData);
                    data.valid_days = parseInt(data.valid_days) || 365;

                    const response = await fetch(`/api/site/${siteId}/renew-certificate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        showMessage('ËØÅ‰π¶ÈáçÊñ∞ÁîüÊàêÊàêÂäü', 'success');
                        loadCurrentCertificateInfo(siteId);
                    } else {
                        const error = await response.text();
                        showMessage('ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('ÈáçÊñ∞ÁîüÊàêËØÅ‰π¶ÈîôËØØ:', error);
                    showMessage('ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•', 'error');
                }
            }

        // ÊõøÊç¢ËØÅ‰π¶
        async function replaceSiteCertificate(siteId, formData) {
                try {
                    const data = Object.fromEntries(formData);

                    const response = await fetch(`/api/site/${siteId}/replace-certificate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        showMessage('ËØÅ‰π¶ÊõøÊç¢ÊàêÂäü', 'success');
                        loadCurrentCertificateInfo(siteId);
                    } else {
                        const error = await response.text();
                        showMessage('ÊõøÊç¢Â§±Ë¥•: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('ÊõøÊç¢ËØÅ‰π¶ÈîôËØØ:', error);
                    showMessage('ÊõøÊç¢Â§±Ë¥•', 'error');
                }
            }
            

        // ÁßªÈô§ËØÅ‰π¶ÔºàÁ¶ÅÁî®HTTPSÔºâ
        // ÁßªÈô§ËØÅ‰π¶ÔºàÁ¶ÅÁî®HTTPSÔºâ
            async function removeSiteCertificate(siteId) {
                if (!confirm('Á°ÆÂÆöË¶ÅÁßªÈô§ËØÅ‰π¶Âπ∂Á¶ÅÁî®HTTPSÂêóÔºü')) return;

                try {
                    const response = await fetch(`/api/site/${siteId}/remove-certificate`, {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        closeModal();
                        showMessage('ËØÅ‰π¶Â∑≤ÁßªÈô§ÔºåHTTPSÂ∑≤Á¶ÅÁî®', 'success');
                        loadSites();
                    } else {
                        const error = await response.text();
                        showMessage('ÁßªÈô§Â§±Ë¥•: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('ÁßªÈô§ËØÅ‰π¶ÈîôËØØ:', error);
                    showMessage('ÁßªÈô§Â§±Ë¥•', 'error');
                }
            }

// Âä†ËΩΩÁ´ôÁÇπÂÅ•Â∫∑Áä∂ÊÄÅ
async function loadSiteHealthStatus() {
    try {
        console.log('ÂºÄÂßãÂä†ËΩΩÂÅ•Â∫∑Áä∂ÊÄÅ...');
        const response = await fetch('/api/health', {
            method: 'GET',
            credentials: 'include'
        });

        console.log('ÂÅ•Â∫∑Áä∂ÊÄÅÂìçÂ∫î:', response.status, response.statusText);
        
        if (response.ok) {
            const data = await response.json();
            console.log('ÂÅ•Â∫∑Áä∂ÊÄÅÊï∞ÊçÆ:', data);
            window.siteHealthData = data.health_status; // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè
            updateHealthStatusDisplay();
        } else {
            const errorText = await response.text();
            console.error('ÂÅ•Â∫∑Áä∂ÊÄÅËØ∑Ê±ÇÂ§±Ë¥•:', response.status, errorText);
        }
        
        // Êó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÈÉΩËÆæÁΩÆÂÆöÊó∂Âô®ÁªßÁª≠Â∞ùËØï
        setTimeout(loadSiteHealthStatus, 3000); // ÊØè3ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
    } catch (error) {
        console.error('Âä†ËΩΩÂÅ•Â∫∑Áä∂ÊÄÅÈîôËØØ:', error);
        // Âá∫ÈîôÊó∂‰πüËÆæÁΩÆÂÆöÊó∂Âô®ÔºåÁ°Æ‰øùÁªßÁª≠Â∞ùËØï
        setTimeout(loadSiteHealthStatus, 30000);
    }
}

// Ëé∑ÂèñÁ´ôÁÇπÂÅ•Â∫∑Áä∂ÊÄÅHTML
function getSiteHealthStatus(siteId) {
    if (!window.siteHealthData || !window.siteHealthData[siteId]) {
        return '<span class="status-indicator">Êú™Áü•</span>';
    }
    
    const health = window.siteHealthData[siteId];
    const statusClass = health.is_alive ? 'status-active' : 'status-inactive';
    const statusText = health.is_alive ? 'Ê≠£Â∏∏' : 'ÂºÇÂ∏∏';
    const latency = health.latency ? `${health.latency}ms` : 'N/A';
    
    return `
        <span class="status-indicator ${statusClass}" title="Âª∂Ëøü: ${latency}">
            ${statusText} (${latency})
        </span>
    `;
}

    // Âä†ËΩΩÁºìÂ≠òÊñá‰ª∂ÂàóË°® - ÂÖ®Â±ÄÂáΩÊï∞
    window.loadCacheFiles = async function(page = 1) {
        console.log('loadCacheFiles Ë¢´Ë∞ÉÁî®ÔºåÈ°µÁ†Å:', page);
        try {
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const container = document.getElementById('cache-files-container');
            if (!container) {
                console.error('ÁºìÂ≠òÊñá‰ª∂ÂÆπÂô®‰∏çÂ≠òÂú®');
                return;
            }
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';

            // Ëé∑ÂèñÁ´ôÁÇπÁ≠õÈÄâÂô®
            const siteFilter = document.getElementById('cache-site-filter');
            const selectedSite = siteFilter ? siteFilter.value : 'all';

            const params = new URLSearchParams({
                page: page,
                page_size: 10, // ÊØèÈ°µÊòæÁ§∫10Êù°
                site: selectedSite // Ê∑ªÂä†Á´ôÁÇπÁ≠õÈÄâ
            });

            console.log('ËØ∑Ê±ÇURL:', `/api/cache/files?${params}`);
            const response = await fetch(`/api/cache/files?${params}`, {
                method: 'GET',
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Êî∂Âà∞Êï∞ÊçÆ:', data);
                
                // Êõ¥Êñ∞Á´ôÁÇπÁ≠õÈÄâÂô®ÁöÑÈÄâÈ°π
                if (data.sites && siteFilter) {
                    updateSiteFilter(data.sites, selectedSite);
                }
                
                displayCacheFiles(data);
            } else {
                console.error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', response.status);
                container.innerHTML = '<div class="alert alert-error">Âä†ËΩΩÁºìÂ≠òÊñá‰ª∂ÂàóË°®Â§±Ë¥•</div>';
            }
        } catch (error) {
            console.error('Âä†ËΩΩÁºìÂ≠òÊñá‰ª∂ÂàóË°®ÈîôËØØ:', error);
            const container = document.getElementById('cache-files-container');
            if (container) {
                container.innerHTML = '<div class="alert alert-error">Âä†ËΩΩÁºìÂ≠òÊñá‰ª∂ÂàóË°®Â§±Ë¥•</div>';
            }
        }
    };
    
    // Êõ¥Êñ∞Á´ôÁÇπÁ≠õÈÄâÂô®ÈÄâÈ°π
    function updateSiteFilter(sites, selectedValue) {
        const siteFilter = document.getElementById('cache-site-filter');
        if (!siteFilter) return;
        
        const currentValue = siteFilter.value;
        siteFilter.innerHTML = '<option value="all">ÂÖ®ÈÉ®Á´ôÁÇπ</option>';
        
        sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site;
            option.textContent = site;
            if (site === selectedValue || (selectedValue === 'all' && site === currentValue)) {
                option.selected = true;
            }
            siteFilter.appendChild(option);
        });
    }

    // ÊòæÁ§∫ÁºìÂ≠òÊñá‰ª∂ÂàóË°®
    function displayCCAttackLogs(data) {
    const container = document.getElementById('cc-logs-container');
    currentCCLogsTotal = data.total;

    if (!data.logs || data.logs.length === 0) {
        container.innerHTML = '<div class="alert">ÊöÇÊó†CCÊîªÂáªÊó•Âøó</div>';
        document.getElementById('cc-logs-pagination').innerHTML = '';
        return;
    }

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Êó∂Èó¥</th>
                        <th>ÂÆ¢Êà∑Á´ØIP</th>
                        <th>ÂüüÂêç</th>
                        <th>Ë∑ØÂæÑ</th>
                        <th>ËßÑÂàôÂêçÁß∞</th>
                        <th>ËØ∑Ê±ÇÊ¨°Êï∞</th>
                        <th>ÊâßË°åÂä®‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
    `;

    data.logs.forEach(log => {
        html += `
            <tr>
                <td>${log.created_at}</td>
                <td>${log.client_ip}</td>
                <td title="${log.domain}">${log.domain.length > 15 ? log.domain.substring(0, 15) + '...' : log.domain}</td>
                <td title="${log.path || 'ÂÖ®ÈÉ®'}">${log.path ? (log.path.length > 15 ? log.path.substring(0, 15) + '...' : log.path) : 'ÂÖ®ÈÉ®'}</td>
                <td title="${log.rule_name}">${log.rule_name.length > 15 ? log.rule_name.substring(0, 15) + '...' : log.rule_name}</td>
                <td>${log.count}</td>
                <td>
                    <span class="status-indicator ${log.action === 'block' ? 'status-inactive' : 'status-active'}">
                        ${log.action === 'block' ? 'Êã¶Êà™' : 'ÊåëÊàò'}
                    </span>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;

    // ÊòæÁ§∫ÂàÜÈ°µ
    displayCCPagination(data.total, data.page_size, data.page);
}

// ÊòæÁ§∫ÁºìÂ≠òÊñá‰ª∂ÂàóË°®
function displayCacheFiles(data) {
    const container = document.getElementById('cache-files-container');

    if (!data.files || data.files.length === 0) {
        container.innerHTML = '<div class="alert">ÊöÇÊó†ÁºìÂ≠òÊñá‰ª∂</div>';
        const pagination = document.getElementById('cache-files-pagination');
        if (pagination) {
            pagination.innerHTML = '';
        }
        return;
    }

    const files = data.files;
    const currentPage = data.page || 1;
    const pageSize = data.page_size || 10;
    const total = data.total || 0;

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Ë∑ØÂæÑ</th>
                        <th>Á´ôÁÇπ</th>
                        <th>Á±ªÂûã</th>
                        <th>Â§ßÂ∞è</th>
                        <th>ÊúÄÂêé‰øÆÊîπ</th>
                        <th>ËøáÊúüÊó∂Èó¥</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
    `;

    files.forEach(file => {
        // ÁÆÄÂåñÊòæÁ§∫ÁºìÂ≠òÈîÆÔºàÁßªÈô§Á´ôÁÇπÂâçÁºÄÔºåÂõ†‰∏∫Â∑≤ÁªèÂú®Á≠õÈÄâÂô®ÂíåÁ´ôÁÇπÂàóÊòæÁ§∫‰∫ÜÔºâ
        let displayKey = file.key;
        if (file.site && displayKey.startsWith(file.site)) {
            displayKey = displayKey.substring(file.site.length);
        }
        displayKey = displayKey.length > 30 ? displayKey.substring(0, 30) + '...' : displayKey;
        const displayType = file.content_type ? (file.content_type.length > 15 ? file.content_type.substring(0, 15) + '...' : file.content_type) : 'Êú™Áü•';

        // ËΩ¨‰πâÂçïÂºïÂè∑ÔºåÈò≤Ê≠¢XSSÂíåJavaScriptÈîôËØØ
        const safeKey = file.key.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        
        html += `
            <tr>
                <td title="${file.key}">${displayKey}</td>
                <td>${file.site || 'unknown'}</td>
                <td title="${file.content_type || 'Êú™Áü•'}">${displayType}</td>
                <td>${file.size || 0}</td>
                <td>${file.last_modified || 'Êú™Áü•'}</td>
                <td>${file.expire_at || 'Ê∞∏‰∏çËøáÊúü'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn" onclick="viewCacheFileContent('${safeKey}')">Êü•ÁúãÂÜÖÂÆπ</button>
                        <button class="btn btn-danger" onclick="deleteCacheFile('${safeKey}')">Âà†Èô§</button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            ÊòæÁ§∫ ${((currentPage - 1) * pageSize) + 1}-${Math.min(currentPage * pageSize, total)} ‰∏™ÔºåÂÖ± ${total} ‰∏™ÁºìÂ≠òÊñá‰ª∂
        </div>
    `;

    container.innerHTML = html;

    // ÊòæÁ§∫ÂàÜÈ°µ
    displayCacheFilesPagination(total, pageSize, currentPage);
}

// ÊòæÁ§∫ÁºìÂ≠òÊñá‰ª∂ÂàÜÈ°µ - ÂÖ®Â±ÄÂáΩÊï∞
function displayCacheFilesPagination(total, pageSize, currentPage) {
    const totalPages = Math.ceil(total / pageSize);
    const pagination = document.getElementById('cache-files-pagination');
    
    if (!pagination) {
        console.error('ÁºìÂ≠òÊñá‰ª∂ÂàÜÈ°µÂÆπÂô®‰∏çÂ≠òÂú®');
        return;
    }

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    // ÂÖàÊ∏ÖÁ©∫ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
    pagination.innerHTML = '';
    
    // ÂàõÂª∫‰∏ä‰∏ÄÈ°µÊåâÈíÆ
    if (currentPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.textContent = '‰∏ä‰∏ÄÈ°µ';
        prevBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.loadCacheFiles(currentPage - 1);
        });
        pagination.appendChild(prevBtn);
    }

    // ÂàõÂª∫È°µÁ†ÅÊåâÈíÆ
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            const activeBtn = document.createElement('button');
            activeBtn.className = 'page-btn active';
            activeBtn.textContent = i.toString();
            pagination.appendChild(activeBtn);
        } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            const pageBtn = document.createElement('button');
            pageBtn.className = 'page-btn';
            pageBtn.textContent = i.toString();
            // ‰ΩøÁî®Á´ãÂç≥ÊâßË°åÂáΩÊï∞ÔºàIIFEÔºâÊù•ÊçïËé∑Ê≠£Á°ÆÁöÑ i ÂÄº
            (function(pageNum) {
                pageBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ÁÇπÂáªÈ°µÁ†Å:', pageNum);
                    window.loadCacheFiles(pageNum);
                });
            })(i);
            pagination.appendChild(pageBtn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'page-btn';
            ellipsis.textContent = '...';
            pagination.appendChild(ellipsis);
        }
    }

    // ÂàõÂª∫‰∏ã‰∏ÄÈ°µÊåâÈíÆ
    if (currentPage < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.textContent = '‰∏ã‰∏ÄÈ°µ';
        nextBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.loadCacheFiles(currentPage + 1);
        });
        pagination.appendChild(nextBtn);
    }
}
// Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Âà†Èô§ÁºìÂ≠òÊñá‰ª∂
async function deleteCacheFile(cacheKey) {
    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÁºìÂ≠òÊñá‰ª∂ "${cacheKey}" ÂêóÔºü`)) return;
    
    try {
        const response = await fetch(`/api/cache/files/delete`, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json', // Ê∑ªÂä†JSONÂ§¥
            },
            body: JSON.stringify({ // Ê∑ªÂä†ËØ∑Ê±Ç‰Ωì
                file: cacheKey
            })
            
        });

        if (response.ok) {
            showMessage('ÁºìÂ≠òÊñá‰ª∂Âà†Èô§ÊàêÂäü', 'success');
            window.loadCacheFiles(1); // ÈáçÊñ∞Âä†ËΩΩÊñá‰ª∂ÂàóË°®
        } else {
            const error = await response.text();
            showMessage('Âà†Èô§Â§±Ë¥•: ' + error, 'error');
        }
    } catch (error) {
        console.error('Âà†Èô§ÁºìÂ≠òÊñá‰ª∂ÈîôËØØ:', error);
        showMessage('Âà†Èô§Â§±Ë¥•', 'error');
    }
}


    // Êü•ÁúãÁºìÂ≠òÊñá‰ª∂ÂÜÖÂÆπ
    async function viewCacheFileContent(cacheKey) {
            try {
                const response = await fetch(`/api/cache/files`, {
                    method: 'POST',  // Êîπ‰∏∫POST
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json', // Ê∑ªÂä†JSONÂ§¥
                    },
                    body: JSON.stringify({ // Ê∑ªÂä†ËØ∑Ê±Ç‰Ωì
                        file: cacheKey
                    })
                });

                if (response.ok) {
                    const fileContent = await response.json();
                    showCacheFileContentModal(fileContent);
                } else {
                    showMessage('Ëé∑ÂèñÊñá‰ª∂ÂÜÖÂÆπÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÊñá‰ª∂ÂÜÖÂÆπÈîôËØØ:', error);
                showMessage('Ëé∑ÂèñÊñá‰ª∂ÂÜÖÂÆπÂ§±Ë¥•', 'error');
            }
        }

    // ÊòæÁ§∫ÁºìÂ≠òÊñá‰ª∂ÂÜÖÂÆπÊ®°ÊÄÅÊ°Ü
    function showCacheFileContentModal(fileContent) {
        document.getElementById('modal-title').textContent = `ÁºìÂ≠òÊñá‰ª∂ÂÜÖÂÆπ - ${fileContent.key}`;

        // Ê†πÊçÆÂÜÖÂÆπÁ±ªÂûãÁ°ÆÂÆöËØ≠Ë®Ä
        function getLanguageFromContentType(contentType) {
            if (contentType.includes('json')) return 'json';
            if (contentType.includes('javascript')) return 'javascript';
            if (contentType.includes('css')) return 'css';
            if (contentType.includes('html')) return 'html';
            if (contentType.includes('xml')) return 'xml';
            if (contentType.includes('yaml')) return 'yaml';
            if (contentType.includes('sql')) return 'sql';
            if (contentType.includes('python')) return 'python';
            if (contentType.includes('php')) return 'php';
            if (contentType.includes('java')) return 'java';
            if (contentType.includes('c++') || contentType.includes('cpp')) return 'cpp';
            if (contentType.includes('shell') || contentType.includes('bash')) return 'bash';
            return 'markup'; // ÈªòËÆ§ËØ≠Ë®Ä
        }

        let contentDisplay = '';
        if (fileContent.content_type.startsWith('text/') ||
            fileContent.content_type.includes('json') ||
            fileContent.content_type.includes('javascript') ||
            fileContent.content_type.includes('css') ||
            fileContent.content_type.includes('html') ||
            fileContent.content_type.includes('xml') ||
            fileContent.content_type.includes('yaml')) {
            
            const language = getLanguageFromContentType(fileContent.content_type);
            
            // ÂØπ‰∫éÊñáÊú¨ÂÜÖÂÆπÔºå‰ΩøÁî®‰ª£Á†ÅÈ´ò‰∫ÆÊòæÁ§∫
            contentDisplay = `
                <div style="position: relative;">
                    <button type="button" class="btn" onclick="copyFileContent()" 
                            style="position: absolute; top: 10px; right: 10px; z-index: 10; padding: 5px 10px; font-size: 12px;">
                        üìã Â§çÂà∂ÂÜÖÂÆπ
                    </button>
                    <pre class="code-container language-${language}"><code class="language-${language}">${escapeHtml(fileContent.content)}</code></pre>
                </div>
            `;
        } else {
            // ÂØπ‰∫é‰∫åËøõÂà∂ÂÜÖÂÆπÔºåÊòæÁ§∫Âü∫Êú¨‰ø°ÊÅØ
            contentDisplay = `
            <div class="alert">
                <p>Êñá‰ª∂Á±ªÂûã: ${fileContent.content_type}</p>
                <p>Êñá‰ª∂Â§ßÂ∞è: ${fileContent.size}</p>
                <p>Ê≠§‰∏∫‰∫åËøõÂà∂Êñá‰ª∂ÔºåÊó†Ê≥ïÁõ¥Êé•ÊòæÁ§∫ÂÜÖÂÆπ„ÄÇ</p>
            </div>
        `;
        }

        document.getElementById('modal-body').innerHTML = `
        <div>
            <div style="margin-bottom: 15px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold; width: 100px;">ÁºìÂ≠òÈîÆ</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; word-break: break-all;">${fileContent.key}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ÂÜÖÂÆπÁ±ªÂûã</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${fileContent.content_type}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">Êñá‰ª∂Â§ßÂ∞è</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${fileContent.size}</td>
                    </tr>
                </table>
            </div>
            
            <h4 style="margin-bottom: 10px; color: #5210ed;">Êñá‰ª∂ÂÜÖÂÆπ</h4>
            ${contentDisplay}
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂÖ≥Èó≠</button>
        </div>
    `;

        showModal();
        
        // Ëß¶Âèë‰ª£Á†ÅÈ´ò‰∫Æ
        setTimeout(() => {
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        }, 100);
    }

    // ÊõøÊç¢ copyFileContent ÂáΩÊï∞
        function copyFileContent() {
            const contentElement = document.querySelector('#modal-body pre code');
            if (contentElement) {
                const content = contentElement.textContent;
                copyToClipboard(content, 'Êñá‰ª∂ÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            }
        }


// Êõ¥Êñ∞ÂÅ•Â∫∑Áä∂ÊÄÅÊòæÁ§∫
function updateHealthStatusDisplay() {
    if (currentPage === 'sites' && window.siteHealthData) {
        // ÈáçÊñ∞ÊòæÁ§∫Á´ôÁÇπÂàóË°®‰ª•Êõ¥Êñ∞ÂÅ•Â∫∑Áä∂ÊÄÅ
        loadSites();
    }
}

// ÂàáÊç¢‰∏äÊ∏∏ÊúçÂä°Âô®ËØ¶ÊÉÖÊòæÁ§∫
function toggleUpstreamDetails(siteId) {
    const detailsRow = document.getElementById(`upstream-details-${siteId}`);
    const trigger = window.event ? window.event.target : (event ? event.target : null);
    
    if (detailsRow) {
        if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
            // Â±ïÂºÄ
            detailsRow.style.display = 'table-row';
            expandedUpstreamSites.add(siteId);
            if (trigger) {
                trigger.innerHTML = trigger.innerHTML.replace('‚ñº', '‚ñ≤');
            }
        } else {
            // ÂÖ≥Èó≠
            detailsRow.style.display = 'none';
            expandedUpstreamSites.delete(siteId);
            if (trigger) {
                trigger.innerHTML = trigger.innerHTML.replace('‚ñ≤', '‚ñº');
            }
        }
    }
}

// ÊÅ¢Â§çÂ±ïÂºÄÁöÑ‰∏äÊ∏∏ÊúçÂä°Âô®ËØ¶ÊÉÖ
function restoreExpandedUpstreamDetails() {
    expandedUpstreamSites.forEach(siteId => {
        const detailsRow = document.getElementById(`upstream-details-${siteId}`);
        const triggerSpan = document.querySelector(`span[onclick="toggleUpstreamDetails(${siteId})"]`);
        
        if (detailsRow) {
            detailsRow.style.display = 'table-row';
        }
        if (triggerSpan) {
            triggerSpan.innerHTML = triggerSpan.innerHTML.replace('‚ñº', '‚ñ≤');
        }
    });
}

// Ê£ÄÊü•Âçï‰∏™Á´ôÁÇπÂÅ•Â∫∑Áä∂ÊÄÅ
async function checkSingleSiteHealth(siteId) {
    try {
        const response = await fetch(`/api/health/${siteId}`, {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            showMessage(`ÂÅ•Â∫∑Ê£ÄÊü•ÂÆåÊàê: ${data.health.is_alive ? 'Ê≠£Â∏∏' : 'ÂºÇÂ∏∏'} (${data.health.latency}ms)`, 'success');
            // Âà∑Êñ∞ÂÅ•Â∫∑Áä∂ÊÄÅÊòæÁ§∫
            loadSiteHealthStatus();
        } else {
            showMessage('ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•', 'error');
        }
    } catch (error) {
        console.error('ÂÅ•Â∫∑Ê£ÄÊü•ÈîôËØØ:', error);
        showMessage('ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•', 'error');
    }
}
       // ‰øÆÊîπshowAddSiteModalÂáΩÊï∞
        function showAddSiteModal() {
            document.getElementById('modal-title').textContent = 'Ê∑ªÂä†Á´ôÁÇπ';
            document.getElementById('modal-body').innerHTML = `
        <form id="add-site-form">
            <div class="form-group">
                <label class="form-label">Á´ôÁÇπÂêçÁß∞</label>
                <input type="text" name="name" class="form-control" placeholder="‰æãÂ¶Ç: ÊàëÁöÑÁΩëÁ´ô" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">ÂüüÂêç</label>
                <input type="text" name="domain" class="form-control" placeholder="‰æãÂ¶Ç: example.com" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ë¥üËΩΩÂùáË°°ÁÆóÊ≥ï</label>
                <div>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="load_balance_algorithm" value="" checked> ‰∏ç‰ΩøÁî®Ë¥üËΩΩÂùáË°°
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="load_balance_algorithm" value="round_robin"> ËΩÆËØ¢ÁÆóÊ≥ï
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="radio" name="load_balance_algorithm" value="weighted"> ÊùÉÈáçÁÆóÊ≥ï
                    </label>
                </div>
            </div>
            
            <div class="form-group" id="target-url-group">
                <label class="form-label">ÁõÆÊ†áURL</label>
                <input type="text" name="target_url" class="form-control" placeholder="‰æãÂ¶Ç: http://127.0.0.1:8080">
                <small style="color: #666;">Êú™ÂêØÁî®Ë¥üËΩΩÂùáË°°Êó∂ÂøÖÂ°´</small>
            </div>
            
            <div class="form-group" id="upstream-servers-group" style="display: none;">
                <label class="form-label">‰∏äÊ∏∏ÊúçÂä°Âô®ÂàóË°®</label>
                <div id="upstream-servers-list"></div>
                <button type="button" class="btn" style="margin-top: 10px;" onclick="addUpstreamServer()">+ Ê∑ªÂä†‰∏äÊ∏∏ÊúçÂä°Âô®</button>
                <small style="color: #666; display: block; margin-top: 5px;">ÂêØÁî®Ë¥üËΩΩÂùáË°°Êó∂ÔºåÂøÖÈ°ªËá≥Â∞ëÈÖçÁΩÆ‰∏Ä‰∏™‰∏äÊ∏∏ÊúçÂä°Âô®</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">ÂêØÁî®HTTPS</label>
                <div>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="enable_https" value="true"> ÂêØÁî®
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="radio" name="enable_https" value="false" checked> Á¶ÅÁî®
                    </label>
                </div>
            </div>
            
            <div class="form-group" id="https-options" style="display: none;">
                <div class="tabs" id="cert-tabs">
                    <div class="tab active" data-tab="auto">Ëá™Âä®ÁîüÊàêËØÅ‰π¶</div>
                    <div class="tab" data-tab="upload">‰∏ä‰º†ËØÅ‰π¶</div>
                </div>
                
                <div id="auto-cert-tab" class="tab-content active">
                    <div class="form-group">
                        <label class="form-label">ËØÅ‰π¶ÊúâÊïàÊúü (Â§©)</label>
                        <input type="number" name="valid_days" class="form-control" value="365" min="1" max="3650">
                        <small style="color: #666;">ÈªòËÆ§365Â§©ÔºåÊúÄÈïø10Âπ¥</small>
                    </div>
                </div>
                
                <div id="upload-cert-tab" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">ËØÅ‰π¶ÂÜÖÂÆπ (PEMÊ†ºÂºè)</label>
                        <textarea name="cert_text" class="form-control" rows="6" placeholder="-----BEGIN CERTIFICATE----- ..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÁßÅÈí•ÂÜÖÂÆπ (PEMÊ†ºÂºè)</label>
                        <textarea name="key_text" class="form-control" rows="6" placeholder="-----BEGIN PRIVATE KEY----- ..."></textarea>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button type="submit" class="btn">Ê∑ªÂä†Á´ôÁÇπ</button>
            </div>
        </form>
    `;

            // ÊòæÁ§∫/ÈöêËóèË¥üËΩΩÂùáË°°Áõ∏ÂÖ≥ÈÄâÈ°π
            document.querySelectorAll('input[name="load_balance_algorithm"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const useLB = this.value !== '';
                    document.getElementById('target-url-group').style.display = useLB ? 'none' : 'block';
                    document.getElementById('upstream-servers-group').style.display = useLB ? 'block' : 'none';
                    const targetUrlInput = document.querySelector('input[name="target_url"]');
                    if (useLB) {
                        targetUrlInput.removeAttribute('required');
                        // Êõ¥Êñ∞Áé∞ÊúâÊúçÂä°Âô®ÁöÑÊùÉÈáçÊòæÁ§∫
                        updateUpstreamServerWeights();
                        if (document.getElementById('upstream-servers-list').children.length === 0) {
                            addUpstreamServer();
                        }
                    } else {
                        targetUrlInput.setAttribute('required', 'required');
                    }
                });
            });

            // ÊòæÁ§∫/ÈöêËóèHTTPSÈÄâÈ°π
            document.querySelectorAll('input[name="enable_https"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    document.getElementById('https-options').style.display = this.value === 'true' ? 'block' : 'none';
                });
            });
            
            // Êõ¥Êñ∞Â∑≤ÊúâÊúçÂä°Âô®ÁöÑÊùÉÈáçÊòæÁ§∫
            function updateUpstreamServerWeights() {
                const list = document.getElementById('upstream-servers-list');
                const selectedAlgo = document.querySelector('input[name="load_balance_algorithm"]:checked').value;
                const isWeighted = selectedAlgo === 'weighted';
                
                list.querySelectorAll('.upstream-server-item').forEach(item => {
                    const weightInput = item.querySelector('input[type="number"]');
                    if (weightInput) {
                        weightInput.style.display = isWeighted ? 'block' : 'none';
                        weightInput.required = isWeighted;
                    }
                });
            }
            
            // Ê∑ªÂä†‰∏äÊ∏∏ÊúçÂä°Âô®ÂáΩÊï∞
            window.addUpstreamServer = function() {
                const list = document.getElementById('upstream-servers-list');
                const index = list.children.length;
                const selectedAlgo = document.querySelector('input[name="load_balance_algorithm"]:checked').value;
                const isWeighted = selectedAlgo === 'weighted';
                
                const div = document.createElement('div');
                div.className = 'upstream-server-item';
                div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                div.innerHTML = `
                    <input type="text" name="upstream_url_${index}" class="form-control" placeholder="‰æãÂ¶Ç: http://127.0.0.1:8080" style="flex: ${isWeighted ? '2' : '1'};" required>
                    <input type="number" name="upstream_weight_${index}" class="form-control" placeholder="ÊùÉÈáç" value="1" min="1" style="flex: 1; display: ${isWeighted ? 'block' : 'none'};" ${isWeighted ? 'required' : ''}>
                    <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">Âà†Èô§</button>
                `;
                list.appendChild(div);
            };

            // ËØÅ‰π¶Ê†áÁ≠æÈ°µÂàáÊç¢
            document.querySelectorAll('#cert-tabs .tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');

                    // Êõ¥Êñ∞Ê†áÁ≠æÁä∂ÊÄÅ
                    document.querySelectorAll('#cert-tabs .tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // ÊòæÁ§∫ÂØπÂ∫îÂÜÖÂÆπ
                    document.querySelectorAll('#https-options .tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabName}-cert-tab`).classList.add('active');
                });
            });

            // Ë°®ÂçïÊèê‰∫§
            document.getElementById('add-site-form').addEventListener('submit', function (e) {
                e.preventDefault();
                addSiteWithCertificate(new FormData(this));
            });

            showModal();
        }
        // ‰øÆÊîπÊ∑ªÂä†Á´ôÁÇπÂáΩÊï∞ÔºåÊîØÊåÅËØÅ‰π¶ÂíåË¥üËΩΩÂùáË°°
            async function addSiteWithCertificate(formData) {
                try {
                    const data = Object.fromEntries(formData);
                    data.enable_https = data.enable_https === 'true';
                    
                    // Â§ÑÁêÜ‰∏äÊ∏∏ÊúçÂä°Âô®
                    if (data.load_balance_algorithm && data.load_balance_algorithm !== '') {
                        data.upstream_servers = [];
                        let index = 0;
                        while (true) {
                            const urlKey = `upstream_url_${index}`;
                            const weightKey = `upstream_weight_${index}`;
                            if (data[urlKey]) {
                                data.upstream_servers.push({
                                    url: data[urlKey],
                                    weight: parseInt(data[weightKey]) || 1
                                });
                                delete data[urlKey];
                                delete data[weightKey];
                                index++;
                            } else {
                                break;
                            }
                        }
                    }

                    const response = await fetch('/api/site/add-with-cert', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        closeModal();
                        showMessage('Á´ôÁÇπÊ∑ªÂä†ÊàêÂäü', 'success');
                        loadSites();
                    } else {
                        const error = await response.text();
                        showMessage('Ê∑ªÂä†Â§±Ë¥•: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('Ê∑ªÂä†Á´ôÁÇπÈîôËØØ:', error);
                    showMessage('Ê∑ªÂä†Â§±Ë¥•', 'error');
                }
            }

        // Ê∑ªÂä†Á´ôÁÇπ
        async function addSite(formData) {
            try {
                const data = Object.fromEntries(formData);
                data.enable_https = data.enable_https === 'true';
                
                const response = await fetch('/api/site/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    showMessage('Á´ôÁÇπÊ∑ªÂä†ÊàêÂäü', 'success');
                    loadSites();
                } else {
                    const error = await response.text();
                    showMessage('Ê∑ªÂä†Â§±Ë¥•: ' + error, 'error');
                }
            } catch (error) {
                console.error('Ê∑ªÂä†Á´ôÁÇπÈîôËØØ:', error);
                showMessage('Ê∑ªÂä†Â§±Ë¥•', 'error');
            }
        }

        // ÁºñËæëÁ´ôÁÇπÊ®°ÊÄÅÊ°Ü
        async function showEditSiteModal(siteId) {
            try {
                const response = await fetch('/api/sites', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    showMessage('Âä†ËΩΩÁ´ôÁÇπ‰ø°ÊÅØÂ§±Ë¥•', 'error');
                    return;
                }

                const data = await response.json();
                const site = data.sites.find(s => s.id === siteId);
                
                if (!site) {
                    showMessage('Á´ôÁÇπ‰∏çÂ≠òÂú®', 'error');
                    return;
                }

                document.getElementById('modal-title').textContent = 'ÁºñËæëÁ´ôÁÇπ';
                document.getElementById('modal-body').innerHTML = `
        <form id="edit-site-form">
            <input type="hidden" name="id" value="${site.id}">
            <div class="form-group">
                <label class="form-label">Á´ôÁÇπÂêçÁß∞</label>
                <input type="text" name="name" class="form-control" placeholder="‰æãÂ¶Ç: ÊàëÁöÑÁΩëÁ´ô" value="${escapeHtml(site.name)}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">ÂüüÂêç</label>
                <input type="text" name="domain" class="form-control" placeholder="‰æãÂ¶Ç: example.com" value="${escapeHtml(site.domain)}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ë¥üËΩΩÂùáË°°ÁÆóÊ≥ï</label>
                <div>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="load_balance_algorithm" value="" ${!site.load_balance_algorithm ? 'checked' : ''}> ‰∏ç‰ΩøÁî®Ë¥üËΩΩÂùáË°°
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="load_balance_algorithm" value="round_robin" ${site.load_balance_algorithm === 'round_robin' ? 'checked' : ''}> ËΩÆËØ¢ÁÆóÊ≥ï
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="radio" name="load_balance_algorithm" value="weighted" ${site.load_balance_algorithm === 'weighted' ? 'checked' : ''}> ÊùÉÈáçÁÆóÊ≥ï
                    </label>
                </div>
            </div>
            
            <div class="form-group" id="target-url-group">
                <label class="form-label">ÁõÆÊ†áURL</label>
                <input type="text" name="target_url" class="form-control" placeholder="‰æãÂ¶Ç: http://127.0.0.1:8080" value="${escapeHtml(site.target_url)}">
                <small style="color: #666;">Êú™ÂêØÁî®Ë¥üËΩΩÂùáË°°Êó∂ÂøÖÂ°´</small>
            </div>
            
            <div class="form-group" id="upstream-servers-group" style="display: ${site.load_balance_algorithm ? 'block' : 'none'};">
                <label class="form-label">‰∏äÊ∏∏ÊúçÂä°Âô®ÂàóË°®</label>
                <div id="upstream-servers-list"></div>
                <button type="button" class="btn" style="margin-top: 10px;" onclick="addUpstreamServerEdit()">+ Ê∑ªÂä†‰∏äÊ∏∏ÊúçÂä°Âô®</button>
                <small style="color: #666; display: block; margin-top: 5px;">ÂêØÁî®Ë¥üËΩΩÂùáË°°Êó∂ÔºåÂøÖÈ°ªËá≥Â∞ëÈÖçÁΩÆ‰∏Ä‰∏™‰∏äÊ∏∏ÊúçÂä°Âô®</small>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button type="submit" class="btn">Êõ¥Êñ∞Á´ôÁÇπ</button>
            </div>
        </form>
    `;

                // Âä†ËΩΩÁé∞Êúâ‰∏äÊ∏∏ÊúçÂä°Âô®
                if (site.load_balance_algorithm && site.upstream_servers && site.upstream_servers.length > 0) {
                    const list = document.getElementById('upstream-servers-list');
                    site.upstream_servers.forEach((us, index) => {
                        const div = document.createElement('div');
                        div.className = 'upstream-server-item';
                        div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                        const isWeighted = site.load_balance_algorithm === 'weighted';
                        div.innerHTML = `
                            <input type="text" name="upstream_url_${index}" class="form-control" placeholder="‰æãÂ¶Ç: http://127.0.0.1:8080" style="flex: ${isWeighted ? '2' : '1'};" value="${escapeHtml(us.url)}" required>
                            <input type="number" name="upstream_weight_${index}" class="form-control" placeholder="ÊùÉÈáç" value="${us.weight}" min="1" style="flex: 1; display: ${isWeighted ? 'block' : 'none'};" ${isWeighted ? 'required' : ''}>
                            <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">Âà†Èô§</button>
                        `;
                        list.appendChild(div);
                    });
                }

                // ÊòæÁ§∫/ÈöêËóèË¥üËΩΩÂùáË°°Áõ∏ÂÖ≥ÈÄâÈ°π
                document.querySelectorAll('input[name="load_balance_algorithm"]').forEach(radio => {
                    radio.addEventListener('change', function () {
                        const useLB = this.value !== '';
                        document.getElementById('target-url-group').style.display = useLB ? 'none' : 'block';
                        document.getElementById('upstream-servers-group').style.display = useLB ? 'block' : 'none';
                        const targetUrlInput = document.querySelector('input[name="target_url"]');
                        if (useLB) {
                            targetUrlInput.removeAttribute('required');
                            updateUpstreamServerWeightsEdit();
                            if (document.getElementById('upstream-servers-list').children.length === 0) {
                                addUpstreamServerEdit();
                            }
                        } else {
                            targetUrlInput.setAttribute('required', 'required');
                        }
                    });
                });

                // Êõ¥Êñ∞Â∑≤ÊúâÊúçÂä°Âô®ÁöÑÊùÉÈáçÊòæÁ§∫
                function updateUpstreamServerWeightsEdit() {
                    const list = document.getElementById('upstream-servers-list');
                    const selectedAlgo = document.querySelector('input[name="load_balance_algorithm"]:checked').value;
                    const isWeighted = selectedAlgo === 'weighted';
                    
                    list.querySelectorAll('.upstream-server-item').forEach(item => {
                        const weightInput = item.querySelector('input[type="number"]');
                        if (weightInput) {
                            weightInput.style.display = isWeighted ? 'block' : 'none';
                            weightInput.required = isWeighted;
                        }
                    });
                }
                
                // Ê∑ªÂä†‰∏äÊ∏∏ÊúçÂä°Âô®ÂáΩÊï∞
                window.addUpstreamServerEdit = function() {
                    const list = document.getElementById('upstream-servers-list');
                    const index = list.children.length;
                    const selectedAlgo = document.querySelector('input[name="load_balance_algorithm"]:checked').value;
                    const isWeighted = selectedAlgo === 'weighted';
                    
                    const div = document.createElement('div');
                    div.className = 'upstream-server-item';
                    div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                    div.innerHTML = `
                        <input type="text" name="upstream_url_${index}" class="form-control" placeholder="‰æãÂ¶Ç: http://127.0.0.1:8080" style="flex: ${isWeighted ? '2' : '1'};" required>
                        <input type="number" name="upstream_weight_${index}" class="form-control" placeholder="ÊùÉÈáç" value="1" min="1" style="flex: 1; display: ${isWeighted ? 'block' : 'none'};" ${isWeighted ? 'required' : ''}>
                        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">Âà†Èô§</button>
                    `;
                    list.appendChild(div);
                };

                // Ë°®ÂçïÊèê‰∫§
                document.getElementById('edit-site-form').addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateSite(new FormData(this));
                });

                showModal();
            } catch (error) {
                console.error('Âä†ËΩΩÁ´ôÁÇπÈîôËØØ:', error);
                showMessage('Âä†ËΩΩÁ´ôÁÇπ‰ø°ÊÅØÂ§±Ë¥•', 'error');
            }
        }

        // Êõ¥Êñ∞Á´ôÁÇπÂáΩÊï∞
        async function updateSite(formData) {
            try {
                const data = Object.fromEntries(formData);
                
                // Â§ÑÁêÜ‰∏äÊ∏∏ÊúçÂä°Âô®
                if (data.load_balance_algorithm && data.load_balance_algorithm !== '') {
                    data.upstream_servers = [];
                    let index = 0;
                    while (true) {
                        const urlKey = `upstream_url_${index}`;
                        const weightKey = `upstream_weight_${index}`;
                        if (data[urlKey]) {
                            data.upstream_servers.push({
                                url: data[urlKey],
                                weight: parseInt(data[weightKey]) || 1
                            });
                            delete data[urlKey];
                            delete data[weightKey];
                            index++;
                        } else {
                            break;
                        }
                    }
                }

                const response = await fetch('/api/site/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    showMessage('Á´ôÁÇπÊõ¥Êñ∞ÊàêÂäü', 'success');
                    loadSites();
                } else {
                    const error = await response.text();
                    showMessage('Êõ¥Êñ∞Â§±Ë¥•: ' + error, 'error');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Á´ôÁÇπÈîôËØØ:', error);
                showMessage('Êõ¥Êñ∞Â§±Ë¥•', 'error');
            }
        }

        // Âà†Èô§Á´ôÁÇπ
        async function deleteSite(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á´ôÁÇπÂêóÔºü')) return;
            
            try {
                const response = await fetch('/api/site/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ id })
                });

                if (response.ok) {
                    showMessage('Á´ôÁÇπÂà†Èô§ÊàêÂäü', 'success');
                    loadSites();
                } else {
                    showMessage('Âà†Èô§Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âà†Èô§Á´ôÁÇπÈîôËØØ:', error);
                showMessage('Âà†Èô§Â§±Ë¥•', 'error');
            }
        }

        // Âä†ËΩΩÊîªÂáªÊó•Âøó
        async function loadAttackLogs(page) {
            try {
                currentLogsPage = page;
                
                const params = new URLSearchParams({
                    page: page,
                    page_size: currentLogsPageSize
                });
                
                // Ê∑ªÂä†Á≠õÈÄâÊù°‰ª∂
                const methodFilter = document.getElementById('log-method-filter');
                const ruleFilter = document.getElementById('log-rule-filter');
                const startDate = document.getElementById('log-start-date');
                const endDate = document.getElementById('log-end-date');
                
                if (methodFilter && methodFilter.value) params.append('method', methodFilter.value);
                if (ruleFilter && ruleFilter.value) params.append('rule_name', ruleFilter.value);
                if (startDate && startDate.value) params.append('start_time', startDate.value);
                if (endDate && endDate.value) params.append('end_time', endDate.value);
                
                const response = await fetch(`/api/attack/logs?${params}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayAttackLogs(data);
                } else {
                    document.getElementById('logs-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩÊîªÂáªÊó•ÂøóÂ§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊîªÂáªÊó•ÂøóÈîôËØØ:', error);
                document.getElementById('logs-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩÊîªÂáªÊó•ÂøóÂ§±Ë¥•</div>';
            }
        }

        // ÊòæÁ§∫ÊîªÂáªÊó•Âøó
function displayAttackLogs(data) {
    const container = document.getElementById('logs-container');
    currentLogsTotal = data.total;
    
    if (!data.logs || data.logs.length === 0) {
        container.innerHTML = '<div class="alert">ÊöÇÊó†ÊîªÂáªÊó•Âøó</div>';
        document.getElementById('logs-pagination').innerHTML = '';
        return;
    }
    
    // Ëé∑ÂèñÊñπÊ≥ïÊ†áÁ≠æÁöÑCSSÁ±ª
    
    
    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Êó∂Èó¥</th>
                        <th>ÊñπÊ≥ï</th>
                        <th>ËßÑÂàôÂêçÁß∞</th>
                        <th>ËßÑÂàôID</th>
                        <th>ÂåπÈÖçÂÜÖÂÆπ</th>
                        <th>URL</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.logs.forEach(log => {
        
        html += `
            <tr>
                <td>${log.created_at}</td>
                <td>${log.method}</td>
                <td title="${log.rule_name}">${log.rule_name.length > 15 ? log.rule_name.substring(0, 15) + '...' : log.rule_name}</td>
                <td>${log.rule_id}</td>
                <td title="${log.matched_value}">${log.matched_value.length > 20 ? log.matched_value.substring(0, 20) + '...' : log.matched_value}</td>
                <td title="${log.url}">${log.url.length > 20 ? log.url.substring(0, 20) + '...' : log.url}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn" onclick="showLogDetail(${log.id})">ËØ¶ÊÉÖ</button>
                        <button class="btn btn-secondary" onclick="disableRule('${log.rule_id}', '${log.rule_name}')">Á¶ÅÁî®ËßÑÂàô</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
    
    // ÊòæÁ§∫ÂàÜÈ°µ
    displayPagination(data.total, data.page_size, data.page);
}

// Á¶ÅÁî®ËßÑÂàô
async function disableRule(ruleId, ruleName) {
    if (!confirm(`Á°ÆÂÆöË¶ÅÁ¶ÅÁî®ËßÑÂàô "${ruleName}" (ID: ${ruleId}) ÂêóÔºü`)) return;
    
    try {
        const response = await fetch('/api/rules/status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                rule_id: ruleId,
                enable: false
            })
        });

        if (response.ok) {
            showMessage(`ËßÑÂàô "${ruleName}" Â∑≤Á¶ÅÁî®`, 'success');
            // Âà∑Êñ∞Ë¢´Á¶ÅÁî®ÁöÑËßÑÂàôÂàóË°®
            loadBlockedRules();
        } else {
            const error = await response.text();
            showMessage('Á¶ÅÁî®Â§±Ë¥•: ' + error, 'error');
        }
    } catch (error) {
        console.error('Á¶ÅÁî®ËßÑÂàôÈîôËØØ:', error);
        showMessage('Á¶ÅÁî®Â§±Ë¥•', 'error');
    }
}


        // ÊòæÁ§∫ÂàÜÈ°µ
        function displayPagination(total, pageSize, currentPage) {
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('logs-pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // ‰∏ä‰∏ÄÈ°µ
            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="loadAttackLogs(${currentPage - 1})">‰∏ä‰∏ÄÈ°µ</button>`;
            }
            
            // È°µÁ†Å
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    html += `<button class="page-btn active">${i}</button>`;
                } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="page-btn" onclick="loadAttackLogs(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span class="page-btn">...</span>`;
                }
            }
            
            // ‰∏ã‰∏ÄÈ°µ
            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="loadAttackLogs(${currentPage + 1})">‰∏ã‰∏ÄÈ°µ</button>`;
            }
            
            pagination.innerHTML = html;
        }

        // ÊòæÁ§∫Êó•ÂøóËØ¶ÊÉÖ
        async function showLogDetail(logId) {
            try {
                const response = await fetch(`/api/attack/log/${logId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Ëé∑ÂèñÊó•ÂøóËØ¶ÊÉÖÂ§±Ë¥•');
                }
                
                const log = await response.json();
                displayLogDetailModal(log);
            } catch (error) {
                console.error('Ëé∑ÂèñÊó•ÂøóËØ¶ÊÉÖÈîôËØØ:', error);
                showMessage('Ëé∑ÂèñÊó•ÂøóËØ¶ÊÉÖÂ§±Ë¥•', 'error');
            }
        }

        // ÂØºÂá∫Êó•Âøó
        function exportLogs() {
            // ÊûÑÂª∫ÂØºÂá∫URL
            const params = new URLSearchParams();
            
            const methodFilter = document.getElementById('log-method-filter');
            const ruleFilter = document.getElementById('log-rule-filter');
            const startDate = document.getElementById('log-start-date');
            const endDate = document.getElementById('log-end-date');
            
            if (methodFilter && methodFilter.value) params.append('method', methodFilter.value);
            if (ruleFilter && ruleFilter.value) params.append('rule_name', ruleFilter.value);
            if (startDate && startDate.value) params.append('start_time', startDate.value);
            if (endDate && endDate.value) params.append('end_time', endDate.value);
            
            window.open(`/api/attack/export?${params}`, '_blank');
        }

        // ÊòæÁ§∫Âà†Èô§Êó•ÂøóÊ®°ÊÄÅÊ°Ü
        function showDeleteLogsModal() {
            document.getElementById('modal-title').textContent = 'Âà†Èô§ÊîªÂáªÊó•Âøó';
            document.getElementById('modal-body').innerHTML = `
                <form id="delete-logs-form">
                    <div class="form-group">
                        <label class="form-label">Âà†Èô§ÊñπÂºè</label>
                        <div>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="radio" name="delete_type" value="all" checked> Âà†Èô§ÊâÄÊúâÊó•Âøó
                            </label>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="radio" name="delete_type" value="before"> Âà†Èô§ÊåáÂÆöÊó∂Èó¥‰πãÂâçÁöÑÊó•Âøó
                                <input type="date" name="before_date" class="form-control" style="margin-top: 5px;">
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                        <button type="submit" class="btn btn-danger">Âà†Èô§</button>
                    </div>
                </form>
            `;
            
            document.getElementById('delete-logs-form').addEventListener('submit', function(e) {
                e.preventDefault();
                deleteLogs(new FormData(this));
            });
            
            showModal();
        }

        // ÂàáÊç¢Á´ôÁÇπHTTPSÁä∂ÊÄÅ
async function toggleSiteHTTPS(siteId, enableHTTPS) {
    const action = enableHTTPS ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
    
    if (!confirm(`Á°ÆÂÆöË¶Å${action}Ëøô‰∏™Á´ôÁÇπÁöÑHTTPSÂêóÔºü`)) return;
    
    try {
        const requestData = {
            id: siteId,
            enable_https: enableHTTPS
        };
        
        // ÂêØÁî®HTTPSÊó∂‰∏çÂÜçÈúÄË¶ÅÊâãÂä®ËæìÂÖ•ËØÅ‰π¶IDÔºåÂêéÁ´Ø‰ºöËá™Âä®Â§ÑÁêÜ
        // Â¶ÇÊûúÁ´ôÁÇπÂ∑≤ÊúâËØÅ‰π¶‰ºö‰ΩøÁî®Áé∞ÊúâËØÅ‰π¶ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôËá™Âä®ÁîüÊàê
        
        const response = await fetch('/api/site/https', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            showMessage(`Á´ôÁÇπHTTPS${action}ÊàêÂäü`, 'success');
            loadSites();
        } else {
            const error = await response.text();
            showMessage(`${action}HTTPSÂ§±Ë¥•: ${error}`, 'error');
        }
    } catch (error) {
        console.error(`${action}Á´ôÁÇπHTTPSÈîôËØØ:`, error);
        showMessage(`${action}HTTPSÂ§±Ë¥•`, 'error');
    }
}

// ‰øÆÊîπ displayLogDetailModal ÂáΩÊï∞ÔºåÁ°Æ‰øùÊâÄÊúâÂ≠óÊÆµÈÉΩÊòØÂ≠óÁ¨¶‰∏≤
function displayLogDetailModal(log) {
    document.getElementById('modal-title').textContent = `ÊîªÂáªÊó•ÂøóËØ¶ÊÉÖ - ID: ${log.id}`;
    
    // Ê†ºÂºèÂåñÊó∂Èó¥
    const formattedTime = new Date(log.created_at).toLocaleString();
    
    // ÊûÑÂª∫Ê†ºÂºèÂåñÁöÑHTTPËØ∑Ê±Ç
    function formatHTTPRequest(log) {
        let request = '';
        
        // ËØ∑Ê±ÇË°å
        const method = String(log.method || 'GET');
        const url = String(log.url || '/');
        const httpVersion = 'HTTP/1.1';
        
        request += `${method} ${url} ${httpVersion}\n`;
        
        // Ëß£ÊûêËØ∑Ê±ÇÂ§¥
        if (log.headers && String(log.headers).trim()) {
            const headers = String(log.headers).split('\n');
            headers.forEach(header => {
                if (header.trim()) {
                    const trimmedHeader = header.trim();
                    if (trimmedHeader.includes(':')) {
                        const [name, ...valueParts] = trimmedHeader.split(':');
                        const value = valueParts.join(':').trim();
                        
                        const prettyName = name.toLowerCase()
                            .split('-')
                            .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                            .join('-');
                        
                        request += `${prettyName}: ${value}\n`;
                    } else {
                        request += `${trimmedHeader}\n`;
                    }
                }
            });
        } else {
            request += 'Host: unknown\n';
        }
        
        request += '\n';
        
        // ËØ∑Ê±Ç‰Ωì
        if (log.body && String(log.body).trim()) {
            request += String(log.body);
        }
        
        return request;
    }
    
    const formattedRequest = formatHTTPRequest(log);
    
    // ÊûÑÂª∫ËØ¶ÊÉÖÂÜÖÂÆπ
    document.getElementById('modal-body').innerHTML = `
        <div style="max-height: 70vh; overflow-y: auto;">
            <div class="card" style="margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px; color: #5210ed;">Âü∫Êú¨‰ø°ÊÅØ</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold; width: 120px;">Êó∂Èó¥</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${formattedTime}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ËØ∑Ê±ÇÊñπÊ≥ï</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <span class="status-indicator ${log.method === 'GET' ? 'status-active' : 'status-inactive'}">
                                ${String(log.method || 'Unknown')}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ËßÑÂàôÂêçÁß∞</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${String(log.rule_name || 'Unknown')}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ËßÑÂàôID</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${String(log.rule_id || 'Unknown')}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ÂåπÈÖçÂÜÖÂÆπ</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <code style="background: #f4f4f4; padding: 2px 4px; border-radius: 3px; word-break: break-all;">
                                ${escapeHtml(log.matched_value)}
                            </code>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ÂÆ¢Êà∑Á´ØIP</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${String(log.client_ip || 'Unknown')}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">Áî®Êà∑‰ª£ÁêÜ</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <code style="background: #f4f4f4; padding: 2px 4px; border-radius: 3px; word-break: break-all;">
                                ${escapeHtml(log.user_agent)}
                            </code>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <h4 style="margin-bottom: 10px; color: #5210ed;">HTTPËØ∑Ê±ÇËØ¶ÊÉÖ</h4>
                <div style="position: relative;">
                    <button type="button" class="btn" onclick="copyFormattedRequest()" 
                            style="position: absolute; top: 10px; right: 10px; z-index: 10; padding: 5px 10px; font-size: 12px;">
                        üìã Â§çÂà∂ËØ∑Ê±Ç
                    </button>
                    <pre id="formatted-request" class="code-container language-http" style="margin-top: 10px;"><code class="language-http">${escapeHtml(formattedRequest)}</code></pre>
                </div>
                
                ${log.url_decoded && String(log.url_decoded) !== String(log.url) ? `
                <div style="margin-top: 15px;">
                    <h5 style="color: #5210ed; margin-bottom: 8px;">Ëß£Á†ÅÂêéURL:</h5>
                    <pre class="code-container language-url"><code class="language-url">${escapeHtml(log.url_decoded)}</code></pre>
                </div>
                ` : ''}
                
                ${log.headers_decoded && String(log.headers_decoded) !== String(log.headers) ? `
                <div style="margin-top: 15px;">
                    <h5 style="color: #5210ed; margin-bottom: 8px;">Ëß£Á†ÅÂêéËØ∑Ê±ÇÂ§¥:</h5>
                    <pre class="code-container language-http"><code class="language-http">${escapeHtml(log.headers_decoded)}</code></pre>
                </div>
                ` : ''}
                
                ${log.body_decoded && String(log.body_decoded) !== String(log.body) ? `
                <div style="margin-top: 15px;">
                    <h5 style="color: #5210ed; margin-bottom: 8px;">Ëß£Á†ÅÂêéËØ∑Ê±Ç‰Ωì:</h5>
                    <pre class="code-container language-json"><code class="language-json">${escapeHtml(log.body_decoded)}</code></pre>
                </div>
                ` : ''}
            </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂÖ≥Èó≠</button>
            <button type="button" class="btn" onclick="copyLogDetails()">Â§çÂà∂ÂÖ®ÈÉ®ËØ¶ÊÉÖ</button>
        </div>
    `;
    
    showModal();
}


// HTMLËΩ¨‰πâÂáΩÊï∞
// ‰øÆÊîπ escapeHtml ÂáΩÊï∞ÔºåÊ∑ªÂä†Á±ªÂûãÊ£ÄÊü•
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    
    // Â¶ÇÊûúÊòØÂØπË±°ÔºåËΩ¨Êç¢‰∏∫ JSON Â≠óÁ¨¶‰∏≤
    if (typeof unsafe === 'object') {
        try {
            unsafe = JSON.stringify(unsafe, null, 2);
        } catch (e) {
            unsafe = String(unsafe);
        }
    }
    
    // Á°Æ‰øùÊòØÂ≠óÁ¨¶‰∏≤
    unsafe = String(unsafe);
    
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}


    // ÊõøÊç¢ copyFormattedRequest ÂáΩÊï∞
    function copyFormattedRequest() {
        const formattedRequest = document.getElementById('formatted-request').textContent;

        copyToClipboard(formattedRequest, 'HTTPËØ∑Ê±ÇÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
    }



// HTMLËΩ¨‰πâÂáΩÊï∞
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

    // ÊõøÊç¢ copyLogDetails ÂáΩÊï∞
    function copyLogDetails() {
        const modalBody = document.getElementById('modal-body');
        const text = modalBody.innerText;

        copyToClipboard(text, 'Êó•ÂøóËØ¶ÊÉÖÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
    }

    // ÈÄöÁî®ÁöÑÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÂáΩÊï∞
    function copyToClipboard(text, successMessage) {
        // ÊñπÊ≥ï1: ‰ΩøÁî®Áé∞‰ª£ Clipboard API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('Â§çÂà∂ÊàêÂäü', 'success');
            }).catch(err => {
                // Â¶ÇÊûú Clipboard API Â§±Ë¥•ÔºåÂõûÈÄÄÂà∞‰º†ÁªüÊñπÊ≥ï
                fallbackCopyToClipboard(text, successMessage);
            });
        } else {
            // ‰ΩøÁî®‰º†ÁªüÊñπÊ≥ï
            fallbackCopyToClipboard(text, successMessage);
        }
    }
    // ‰º†ÁªüÁöÑÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÊñπÊ≥ï
    function fallbackCopyToClipboard(text, successMessage) {
        // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑ textarea ÂÖÉÁ¥†
        const textArea = document.createElement('textarea');
        textArea.value = text;

        // ÈÅøÂÖçÂ±èÂπïÈó™ÁÉÅ
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);

        // ÈÄâÊã©ÂíåÂ§çÂà∂
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showMessage('Â§çÂà∂ÊàêÂäü', 'success');
            } else {
                showMessage('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®ÈÄâÊã©ÊñáÊú¨Â§çÂà∂', 'error');
            }
        } catch (err) {
            console.error('Â§çÂà∂Â§±Ë¥•:', err);
            showMessage('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®ÈÄâÊã©ÊñáÊú¨Â§çÂà∂', 'error');

            // Â¶ÇÊûúËøû‰º†ÁªüÊñπÊ≥ïÈÉΩÂ§±Ë¥•ÔºåËá™Âä®ÈÄâÊã©ÊñáÊú¨ËÆ©Áî®Êà∑ÊâãÂä®Â§çÂà∂
            textArea.style.position = 'static';
            textArea.style.left = 'auto';
            textArea.style.top = 'auto';
            textArea.focus();
            textArea.select();
        } finally {
            // Ê∏ÖÁêÜ
            document.body.removeChild(textArea);
        }
    }

// ÊòæÁ§∫Êó•ÂøóËØ¶ÊÉÖ
async function showLogDetail(logId) {
    try {
        const response = await fetch(`/api/attack/logs/${logId}`, {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            if (data.log) {
                displayLogDetailModal(data.log);
            } else {
                showMessage('Êó•ÂøóÊï∞ÊçÆÊ†ºÂºèÈîôËØØ', 'error');
            }
        } else {
            showMessage('Ëé∑ÂèñÊó•ÂøóËØ¶ÊÉÖÂ§±Ë¥•', 'error');
        }
    } catch (error) {
        console.error('Ëé∑ÂèñÊó•ÂøóËØ¶ÊÉÖÈîôËØØ:', error);
        showMessage('Ëé∑ÂèñÊó•ÂøóËØ¶ÊÉÖÂ§±Ë¥•: ' + error.message, 'error');
    }
}

        // Âà†Èô§Êó•Âøó
        async function deleteLogs(formData) {
            try {
                const data = Object.fromEntries(formData);
                let requestData = {};
                
                if (data.delete_type === 'all') {
                    requestData.all = true;
                } else if (data.delete_type === 'before' && data.before_date) {
                    requestData.before = data.before_date;
                } else {
                    showMessage('ËØ∑ÈÄâÊã©Âà†Èô§Êù°‰ª∂', 'error');
                    return;
                }
                
                const response = await fetch('/api/attack/logs', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    closeModal();
                    showMessage('ÊîªÂáªÊó•ÂøóÂà†Èô§ÊàêÂäü', 'success');
                    loadAttackLogs(1);
                } else {
                    const error = await response.text();
                    showMessage('Âà†Èô§Â§±Ë¥•: ' + error, 'error');
                }
            } catch (error) {
                console.error('Âà†Èô§Êó•ÂøóÈîôËØØ:', error);
                showMessage('Âà†Èô§Â§±Ë¥•', 'error');
            }
        }

        // Âä†ËΩΩËÆæÁΩÆ
            // Âä†ËΩΩËÆæÁΩÆ
                async function loadSettings() {
                    try {
                        const response = await fetch('/api/settings', {
                            method: 'GET',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const settings = data.settings;

                            // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
                            document.querySelector(`input[name="anti-devtools"][value="${settings.enable_anti_devtools}"]`).checked = true;

                            // Êñ∞Â¢ûÔºöJSÊ∑∑Ê∑ÜËÆæÁΩÆ
                            document.querySelector(`input[name="js-obfuscation"][value="${settings.enable_js_obfuscation}"]`).checked = true;

                            document.getElementById('rule-match-rate').value = settings.rule_match_rate;
                            document.getElementById('rule-match-rate-value').textContent = settings.rule_match_rate + '%';
                            document.getElementById('base64-depth').value = settings.base64_depth;
                            document.getElementById('url-depth').value = settings.url_depth;

                        } else {
                            console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩËÆæÁΩÆÈîôËØØ:', error);
                    }

                    // Ê∑ªÂä†ÊªëÂùó‰∫ã‰ª∂ÁõëÂê¨
                    document.getElementById('rule-match-rate').addEventListener('input', function () {
                        document.getElementById('rule-match-rate-value').textContent = this.value + '%';
                    });
                }

        // ‰øùÂ≠òËÆæÁΩÆ
            // ‰øùÂ≠òËÆæÁΩÆ
                async function saveSettings() {
                    try {
                        const settings = {
                            enable_anti_devtools: document.querySelector('input[name="anti-devtools"]:checked').value === 'true',
                            enable_js_obfuscation: document.querySelector('input[name="js-obfuscation"]:checked').value === 'true', // Êñ∞Â¢û
                            rule_match_rate: parseInt(document.getElementById('rule-match-rate').value),
                            base64_depth: parseInt(document.getElementById('base64-depth').value),
                            url_depth: parseInt(document.getElementById('url-depth').value)
                        };

                        // È™åËØÅËæìÂÖ•
                        if (settings.rule_match_rate < 0 || settings.rule_match_rate > 100) {
                            showMessage('ËßÑÂàôÂåπÈÖçÁéáÂøÖÈ°ªÂú®0-100‰πãÈó¥', 'error');
                            return;
                        }
                        if (settings.base64_depth < 0 || settings.base64_depth > 10) {
                            showMessage('Base64Ëß£Á†ÅÊ∑±Â∫¶ÂøÖÈ°ªÂú®0-10‰πãÈó¥', 'error');
                            return;
                        }
                        if (settings.url_depth < 0 || settings.url_depth > 10) {
                            showMessage('URLËß£Á†ÅÊ∑±Â∫¶ÂøÖÈ°ªÂú®0-10‰πãÈó¥', 'error');
                            return;
                        }

                        const response = await fetch('/api/settings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify(settings)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            showMessage(result.message || 'ËÆæÁΩÆ‰øùÂ≠òÊàêÂäü', 'success');
                        } else {
                            const error = await response.text();
                            showMessage('‰øùÂ≠òÂ§±Ë¥•: ' + error, 'error');
                        }
                    } catch (error) {
                        console.error('‰øùÂ≠òËÆæÁΩÆÈîôËØØ:', error);
                        showMessage('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
                    }
                }

        // Ê®°ÊÄÅÊ°ÜÂäüËÉΩ
        function showModal() {
            document.getElementById('modal').style.display = 'flex';
            // Á°Æ‰øùÂÖ≥Èó≠ÊåâÈíÆÂèØ‰ª•Â∑•‰Ωú
            const closeBtn = document.querySelector('.close-modal');
            if (closeBtn) {
                closeBtn.onclick = closeModal;
            }
        }

        // Âä†ËΩΩCCËßÑÂàô
            async function loadCCRules() {
                try {
                    const response = await fetch('/api/cc/rules', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        displayCCRules(data.rules);
                    } else {
                        document.getElementById('cc-rules-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩCCËßÑÂàôÂ§±Ë¥•</div>';
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩCCËßÑÂàôÈîôËØØ:', error);
                    document.getElementById('cc-rules-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩCCËßÑÂàôÂ§±Ë¥•</div>';
                }
            }

            // ÊòæÁ§∫CCËßÑÂàô
            function displayCCRules(rules) {
    const container = document.getElementById('cc-rules-container');

    if (!rules || rules.length === 0) {
        container.innerHTML = '<div class="alert">ÊöÇÊó†CCËßÑÂàô</div>';
        return;
    }

    // ÂàÜÈ°µÂ§ÑÁêÜ
    const pageSize = 10;
    const totalPages = Math.ceil(rules.length / pageSize);
    const currentPage = 1;
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const displayRules = rules.slice(startIndex, endIndex);

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ÂêçÁß∞</th>
                        <th>ÂüüÂêç</th>
                        <th>Ë∑ØÂæÑ</th>
                        <th>È¢ëÁéáÈôêÂà∂</th>
                        <th>Êó∂Èó¥Á™óÂè£</th>
                        <th>Âä®‰Ωú</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>ÊèèËø∞</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
    `;

    displayRules.forEach(rule => {
        html += `
            <tr>
                <td>${rule.id}</td>
                <td title="${rule.name}">${rule.name.length > 15 ? rule.name.substring(0, 15) + '...' : rule.name}</td>
                <td title="${rule.domain}">${rule.domain.length > 15 ? rule.domain.substring(0, 15) + '...' : rule.domain}</td>
                <td title="${rule.path || 'ÂÖ®ÈÉ®'}">${rule.path ? (rule.path.length > 15 ? rule.path.substring(0, 15) + '...' : rule.path) : 'ÂÖ®ÈÉ®'}</td>
                <td>${rule.rate_limit} Ê¨°</td>
                <td>${rule.time_window} Áßí</td>
                <td>
                    <span class="status-indicator ${rule.action === 'block' ? 'status-inactive' : 'status-active'}">
                        ${rule.action === 'block' ? 'Êã¶Êà™' : 'ÊåëÊàò'}
                    </span>
                </td>
                <td>
                    <span class="status-indicator ${rule.enabled ? 'status-active' : 'status-inactive'} clickable" 
                          onclick="toggleCCRuleStatus(${rule.id}, ${!rule.enabled})"
                          title="ÁÇπÂáªÂàáÊç¢Áä∂ÊÄÅ">
                        ${rule.enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
                    </span>
                </td>
                <td title="${rule.description || 'Êó†ÊèèËø∞'}">
                    ${rule.description ? (rule.description.length > 15 ? rule.description.substring(0, 15) + '...' : rule.description) : '-'}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn" onclick="showEditCCRuleModal(${rule.id})">ÁºñËæë</button>
                        <button class="btn btn-danger" onclick="deleteCCRule(${rule.id})">Âà†Èô§</button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            ÊòæÁ§∫ 1-${displayRules.length} Êù°ÔºåÂÖ± ${rules.length} Êù°CCËßÑÂàô
        </div>
    `;

    container.innerHTML = html;
}

            // ÊòæÁ§∫Ê∑ªÂä†CCËßÑÂàôÊ®°ÊÄÅÊ°Ü
            function showAddCCRuleModal() {
                document.getElementById('modal-title').textContent = 'Ê∑ªÂä†CCËßÑÂàô';
                document.getElementById('modal-body').innerHTML = `
        <form id="add-cc-form">
            <div class="form-group">
                <label class="form-label">ËßÑÂàôÂêçÁß∞</label>
                <input type="text" name="name" class="form-control" placeholder="‰æãÂ¶Ç: ÁôªÂΩïÊé•Âè£Èò≤Êä§" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Â∫îÁî®ÂüüÂêç</label>
                <input type="text" name="domain" class="form-control" placeholder="‰æãÂ¶Ç: example.com Êàñ * (ÂÖ®ÈÉ®ÂüüÂêç)" required>
                <small style="color: #666;">‰ΩøÁî® * Ë°®Á§∫ÊâÄÊúâÂüüÂêç</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ë∑ØÂæÑÊ®°Âºè</label>
                <input type="text" name="path" class="form-control" placeholder="‰æãÂ¶Ç: /login ÊàñÁïôÁ©∫Ë°®Á§∫ÂÖ®ÈÉ®Ë∑ØÂæÑ">
                <small style="color: #666;">‰ΩøÁî®ÈÄöÈÖçÁ¨¶ÂåπÈÖçË∑ØÂæÑÔºåÁïôÁ©∫Ë°®Á§∫ÊâÄÊúâË∑ØÂæÑ</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">È¢ëÁéáÈôêÂà∂</label>
                <input type="number" name="rate_limit" class="form-control" placeholder="‰æãÂ¶Ç: 10" min="1" required>
                <small style="color: #666;">Âú®Êó∂Èó¥Á™óÂè£ÂÜÖÂÖÅËÆ∏ÁöÑÊúÄÂ§ßËØ∑Ê±ÇÊ¨°Êï∞</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Êó∂Èó¥Á™óÂè£ (Áßí)</label>
                <input type="number" name="time_window" class="form-control" placeholder="‰æãÂ¶Ç: 60" min="1" required>
                <small style="color: #666;">ÁªüËÆ°ËØ∑Ê±ÇÊ¨°Êï∞ÁöÑÊó∂Èó¥Á™óÂè£</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Èò≤Êä§Âä®‰Ωú</label>
                <select name="action" class="form-control" required>
                    <option value="block">Êã¶Êà™ËØ∑Ê±Ç</option>
                    <option value="challenge">ÊåëÊàòÈ™åËØÅ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ËßÑÂàôÊèèËø∞</label>
                <textarea name="description" class="form-control" placeholder="ËßÑÂàôÊèèËø∞‰ø°ÊÅØ"></textarea>
            </div>
            
            <div class="form-group">
                <label style="display: inline-flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="enabled" checked> ÂêØÁî®ËßÑÂàô
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button type="submit" class="btn">Ê∑ªÂä†ËßÑÂàô</button>
            </div>
        </form>
    `;

                document.getElementById('add-cc-form').addEventListener('submit', function (e) {
                    e.preventDefault();
                    addCCRule(new FormData(this));
                });

                showModal();
            }

            // Ê∑ªÂä†CCËßÑÂàô
            async function addCCRule(formData) {
                try {
                    const data = Object.fromEntries(formData);
                    data.enabled = data.enabled === 'on';
                    data.rate_limit = parseInt(data.rate_limit);
                    data.time_window = parseInt(data.time_window);

                    const response = await fetch('/api/cc/rules', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        closeModal();
                        showMessage('CCËßÑÂàôÊ∑ªÂä†ÊàêÂäü', 'success');
                        loadCCRules();
                    } else {
                        const error = await response.text();
                        showMessage('Ê∑ªÂä†Â§±Ë¥•: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('Ê∑ªÂä†CCËßÑÂàôÈîôËØØ:', error);
                    showMessage('Ê∑ªÂä†Â§±Ë¥•', 'error');
                }
            }

            // ÊòæÁ§∫ÁºñËæëCCËßÑÂàôÊ®°ÊÄÅÊ°Ü
            async function showEditCCRuleModal(ruleId) {
                try {
                    const response = await fetch('/api/cc/rules', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const rule = data.rules.find(r => r.id === ruleId);

                        if (rule) {
                            document.getElementById('modal-title').textContent = 'ÁºñËæëCCËßÑÂàô';
                            document.getElementById('modal-body').innerHTML = `
                    <form id="edit-cc-form">
                        <input type="hidden" name="id" value="${rule.id}">
                        <div class="form-group">
                            <label class="form-label">ËßÑÂàôÂêçÁß∞</label>
                            <input type="text" name="name" class="form-control" value="${rule.name}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Â∫îÁî®ÂüüÂêç</label>
                            <input type="text" name="domain" class="form-control" value="${rule.domain}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ë∑ØÂæÑÊ®°Âºè</label>
                            <input type="text" name="path" class="form-control" value="${rule.path || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">È¢ëÁéáÈôêÂà∂</label>
                            <input type="number" name="rate_limit" class="form-control" value="${rule.rate_limit}" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Êó∂Èó¥Á™óÂè£ (Áßí)</label>
                            <input type="number" name="time_window" class="form-control" value="${rule.time_window}" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Èò≤Êä§Âä®‰Ωú</label>
                            <select name="action" class="form-control" required>
                                <option value="block" ${rule.action === 'block' ? 'selected' : ''}>Êã¶Êà™ËØ∑Ê±Ç</option>
                                <option value="challenge" ${rule.action === 'challenge' ? 'selected' : ''}>ÊåëÊàòÈ™åËØÅ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ËßÑÂàôÊèèËø∞</label>
                            <textarea name="description" class="form-control">${rule.description || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: inline-flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="enabled" ${rule.enabled ? 'checked' : ''}> ÂêØÁî®ËßÑÂàô
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                            <button type="submit" class="btn">Êõ¥Êñ∞ËßÑÂàô</button>
                        </div>
                    </form>
                `;

                            document.getElementById('edit-cc-form').addEventListener('submit', function (e) {
                                e.preventDefault();
                                updateCCRule(new FormData(this));
                            });

                            showModal();
                        } else {
                            showMessage('ËßÑÂàô‰∏çÂ≠òÂú®', 'error');
                        }
                    } else {
                        showMessage('Âä†ËΩΩËßÑÂàôÂ§±Ë¥•', 'error');
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩËßÑÂàôÈîôËØØ:', error);
                    showMessage('Âä†ËΩΩËßÑÂàôÂ§±Ë¥•', 'error');
                }
            }

            // Êõ¥Êñ∞CCËßÑÂàô
            async function updateCCRule(formData) {
                try {
                    const data = Object.fromEntries(formData);
                    data.enabled = data.enabled === 'on';
                    data.rate_limit = parseInt(data.rate_limit);
                    data.time_window = parseInt(data.time_window);

                    const response = await fetch(`/api/cc/rules/${data.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        closeModal();
                        showMessage('CCËßÑÂàôÊõ¥Êñ∞ÊàêÂäü', 'success');
                        loadCCRules();
                    } else {
                        const error = await response.text();
                        showMessage('Êõ¥Êñ∞Â§±Ë¥•: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('Êõ¥Êñ∞CCËßÑÂàôÈîôËØØ:', error);
                    showMessage('Êõ¥Êñ∞Â§±Ë¥•', 'error');
                }
            }

            // ÂàáÊç¢CCËßÑÂàôÁä∂ÊÄÅ
            async function toggleCCRuleStatus(ruleId, enabled) {
                const action = enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®';

                if (!confirm(`Á°ÆÂÆöË¶Å${action}ËøôÊù°CCËßÑÂàôÂêóÔºü`)) return;

                try {
                    // ËøôÈáåÈúÄË¶ÅÂÖàËé∑ÂèñËßÑÂàôËØ¶ÊÉÖÔºåÁÑ∂ÂêéÊõ¥Êñ∞Áä∂ÊÄÅ
                    const response = await fetch('/api/cc/rules', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const rule = data.rules.find(r => r.id === ruleId);

                        if (rule) {
                            const updateData = {
                                name: rule.name,
                                domain: rule.domain,
                                path: rule.path,
                                rate_limit: rule.rate_limit,
                                time_window: rule.time_window,
                                action: rule.action,
                                enabled: enabled,
                                description: rule.description
                            };

                            const updateResponse = await fetch(`/api/cc/rules/${ruleId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'include',
                                body: JSON.stringify(updateData)
                            });

                            if (updateResponse.ok) {
                                showMessage(`CCËßÑÂàô${action}ÊàêÂäü`, 'success');
                                loadCCRules();
                            } else {
                                showMessage(`${action}Â§±Ë¥•`, 'error');
                            }
                        }
                    }
                } catch (error) {
                    console.error(`${action}CCËßÑÂàôÈîôËØØ:`, error);
                    showMessage(`${action}Â§±Ë¥•`, 'error');
                }
            }

            // Âà†Èô§CCËßÑÂàô
            async function deleteCCRule(id) {
                if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°CCËßÑÂàôÂêóÔºü')) return;

                try {
                    const response = await fetch(`/api/cc/rules/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        showMessage('CCËßÑÂàôÂà†Èô§ÊàêÂäü', 'success');
                        loadCCRules();
                    } else {
                        showMessage('Âà†Èô§Â§±Ë¥•', 'error');
                    }
                } catch (error) {
                    console.error('Âà†Èô§CCËßÑÂàôÈîôËØØ:', error);
                    showMessage('Âà†Èô§Â§±Ë¥•', 'error');
                }
            }

            // Âä†ËΩΩCCÁªüËÆ°
            async function loadCCStats() {
                try {
                    const response = await fetch('/api/cc/stats', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const stats = await response.json();
                        displayCCStats(stats);
                    } else {
                        document.getElementById('cc-stats-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩCCÁªüËÆ°Â§±Ë¥•</div>';
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩCCÁªüËÆ°ÈîôËØØ:', error);
                    document.getElementById('cc-stats-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩCCÁªüËÆ°Â§±Ë¥•</div>';
                }
            }

            // ÊòæÁ§∫CCÁªüËÆ°
            function displayCCStats(stats) {
                const container = document.getElementById('cc-stats-container');

                container.innerHTML = `
        <div class="metric-row">
            <div class="metric-card">
                <div class="metric-icon">üö´</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.total_blocked}</div>
                    <div class="metric-label">ÊÄªÊã¶Êà™Ê¨°Êï∞</div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">üìÖ</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.today_blocked}</div>
                    <div class="metric-label">‰ªäÊó•Êã¶Êà™</div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">‚ö°</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.active_attacks}</div>
                    <div class="metric-label">Ê¥ªË∑ÉÊîªÂáª</div>
                </div>
            </div>
        </div>
        
        ${stats.top_blocked_ips && stats.top_blocked_ips.length > 0 ? `
        <div style="margin-top: 20px;">
            <h4 style="color: #5210ed; margin-bottom: 15px;">ÊúÄÂ∏∏Ë¢´Êã¶Êà™ÁöÑIP</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>IPÂú∞ÂùÄ</th>
                            <th>Êã¶Êà™Ê¨°Êï∞</th>
                            <th>ÊúÄÂêéÂá∫Áé∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.top_blocked_ips.map(ip => `
                            <tr>
                                <td>${ip.ip}</td>
                                <td>${ip.count}</td>
                                <td>${ip.last_seen}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        ` : ''}
        
        ${stats.rule_stats && stats.rule_stats.length > 0 ? `
        <div style="margin-top: 20px;">
            <h4 style="color: #5210ed; margin-bottom: 15px;">ËßÑÂàôÊã¶Êà™ÁªüËÆ°</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ËßÑÂàôÂêçÁß∞</th>
                            <th>ËßÑÂàôID</th>
                            <th>Êã¶Êà™Ê¨°Êï∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.rule_stats.map(rule => `
                            <tr>
                                <td>${rule.rule_name}</td>
                                <td>${rule.rule_id}</td>
                                <td>${rule.blocked}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        ` : ''}
    `;
            }

            // Âä†ËΩΩCCÊîªÂáªÊó•Âøó
            async function loadCCAttackLogs(page) {
                try {
                    currentCCLogsPage = page;

                    const params = new URLSearchParams({
                        page: page,
                        page_size: currentCCLogsPageSize
                    });

                    // Ê∑ªÂä†Á≠õÈÄâÊù°‰ª∂
                    const clientIP = document.getElementById('cc-client-ip-filter');
                    const domain = document.getElementById('cc-domain-filter');
                    const ruleId = document.getElementById('cc-rule-id-filter');
                    const startDate = document.getElementById('cc-start-date');
                    const endDate = document.getElementById('cc-end-date');

                    if (clientIP && clientIP.value) params.append('client_ip', clientIP.value);
                    if (domain && domain.value) params.append('domain', domain.value);
                    if (ruleId && ruleId.value) params.append('rule_id', ruleId.value);
                    if (startDate && startDate.value) params.append('start_time', startDate.value);
                    if (endDate && endDate.value) params.append('end_time', endDate.value);

                    const response = await fetch(`/api/cc/logs?${params}`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        displayCCAttackLogs(data);
                    } else {
                        document.getElementById('cc-logs-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩCCÊîªÂáªÊó•ÂøóÂ§±Ë¥•</div>';
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩCCÊîªÂáªÊó•ÂøóÈîôËØØ:', error);
                    document.getElementById('cc-logs-container').innerHTML = '<div class="alert alert-error">Âä†ËΩΩCCÊîªÂáªÊó•ÂøóÂ§±Ë¥•</div>';
                }
            }

            // ÊòæÁ§∫CCÊîªÂáªÊó•Âøó
            function displayCCAttackLogs(data) {
    const container = document.getElementById('cc-logs-container');
    currentCCLogsTotal = data.total;

    if (!data.logs || data.logs.length === 0) {
        container.innerHTML = '<div class="alert">ÊöÇÊó†CCÊîªÂáªÊó•Âøó</div>';
        document.getElementById('cc-logs-pagination').innerHTML = '';
        return;
    }

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>Êó∂Èó¥</th>
                        <th>ÂÆ¢Êà∑Á´ØIP</th>
                        <th>ÂüüÂêç</th>
                        <th>Ë∑ØÂæÑ</th>
                        <th>ËßÑÂàôÂêçÁß∞</th>
                        <th>ËØ∑Ê±ÇÊ¨°Êï∞</th>
                        <th>ÊâßË°åÂä®‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
    `;

    data.logs.forEach(log => {
        html += `
            <tr>
                <td>${log.created_at}</td>
                <td>${log.client_ip}</td>
                <td title="${log.domain}">${log.domain.length > 15 ? log.domain.substring(0, 15) + '...' : log.domain}</td>
                <td title="${log.path || 'ÂÖ®ÈÉ®'}">${log.path ? (log.path.length > 15 ? log.path.substring(0, 15) + '...' : log.path) : 'ÂÖ®ÈÉ®'}</td>
                <td title="${log.rule_name}">${log.rule_name.length > 15 ? log.rule_name.substring(0, 15) + '...' : log.rule_name}</td>
                <td>${log.count}</td>
                <td>
                    <span class="status-indicator ${log.action === 'block' ? 'status-inactive' : 'status-active'}">
                        ${log.action === 'block' ? 'Êã¶Êà™' : 'ÊåëÊàò'}
                    </span>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;

    // ÊòæÁ§∫ÂàÜÈ°µ
    displayCCPagination(data.total, data.page_size, data.page);
}

            // ÊòæÁ§∫CCÂàÜÈ°µ
            function displayCCPagination(total, pageSize, currentPage) {
                const totalPages = Math.ceil(total / pageSize);
                const pagination = document.getElementById('cc-logs-pagination');

                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let html = '';

                // ‰∏ä‰∏ÄÈ°µ
                if (currentPage > 1) {
                    html += `<button class="page-btn" onclick="loadCCAttackLogs(${currentPage - 1})">‰∏ä‰∏ÄÈ°µ</button>`;
                }

                // È°µÁ†Å
                for (let i = 1; i <= totalPages; i++) {
                    if (i === currentPage) {
                        html += `<button class="page-btn active">${i}</button>`;
                    } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        html += `<button class="page-btn" onclick="loadCCAttackLogs(${i})">${i}</button>`;
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        html += `<span class="page-btn">...</span>`;
                    }
                }

                // ‰∏ã‰∏ÄÈ°µ
                if (currentPage < totalPages) {
                    html += `<button class="page-btn" onclick="loadCCAttackLogs(${currentPage + 1})">‰∏ã‰∏ÄÈ°µ</button>`;
                }

                pagination.innerHTML = html;
            }

            // Ê∏ÖÁ©∫CCËÆ°Êï∞Âô®
            async function clearCCCounters() {
                if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâCCËÆ°Êï∞Âô®ÂêóÔºüËøôÂ∞ÜÈáçÁΩÆÊâÄÊúâIPÁöÑËØ∑Ê±ÇËÆ°Êï∞„ÄÇ')) return;

                try {
                    const response = await fetch('/api/cc/clear-counters', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        showMessage('CCËÆ°Êï∞Âô®Â∑≤Ê∏ÖÁ©∫', 'success');
                        loadCCStats();
                    } else {
                        showMessage('Ê∏ÖÁ©∫ËÆ°Êï∞Âô®Â§±Ë¥•', 'error');
                    }
                } catch (error) {
                    console.error('Ê∏ÖÁ©∫CCËÆ°Êï∞Âô®ÈîôËØØ:', error);
                    showMessage('Ê∏ÖÁ©∫ËÆ°Êï∞Âô®Â§±Ë¥•', 'error');
                }
            }

            // Âà∑Êñ∞CCÁªüËÆ°
            function refreshCCStats() {
                loadCCStats();
                loadCCAttackLogs(1);
            }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Ê∂àÊÅØÊèêÁ§∫ - Â∑¶‰∏ãËßíToastÈÄöÁü•
        function showMessage(message, type) {
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                // Â¶ÇÊûúÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÂõæÊ†á
            const icon = type === 'success' ? '‚úì' : '‚úï';
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;
            
            // ÁÇπÂáªÂÖ≥Èó≠
            toast.addEventListener('click', () => {
                toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            });
            
            toastContainer.appendChild(toast);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 3000);
        }

        // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (body.classList.contains('dark-theme')) {
                // ÂàáÊç¢Âà∞Êòé‰∫Æ‰∏ªÈ¢ò
                body.classList.remove('dark-theme');
                themeIcon.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                // ÂàáÊç¢Âà∞ÊöóÈªë‰∏ªÈ¢ò
                body.classList.add('dark-theme');
                themeIcon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme === 'dark') {
                body.classList.add('dark-theme');
                if (themeIcon) {
                    themeIcon.textContent = '‚òÄÔ∏è';
                }
            } else {
                body.classList.remove('dark-theme');
                if (themeIcon) {
                    themeIcon.textContent = 'üåô';
                }
            }
        }

        // ÂàùÂßãÂåñ
        // Âú®ÂàùÂßãÂåñÈÉ®ÂàÜ‰øÆÊîπÂÆöÊó∂Âà∑Êñ∞
document.addEventListener('DOMContentLoaded', function() {
    // Âä†ËΩΩ‰∏ªÈ¢òÔºàÂú®Ê£ÄÊü•ÁôªÂΩï‰πãÂâçÔºåÂõ†‰∏∫‰∏ªÈ¢òÂ∫îËØ•Âú®ÊâÄÊúâÈ°µÈù¢ÈÉΩÁîüÊïàÔºâ
    loadTheme();
    
    // Ê£ÄÊü•ÊòØÂê¶Âú®ÁôªÂΩïÈ°µÈù¢ÔºåÂ¶ÇÊûúÊòØÂàôË∑≥ËøáÂàùÂßãÂåñ
    if (window.location.pathname.includes('login') || document.querySelector('.login-box')) {
        return;
    }
    
    // ÂàùÂßãÂåñÊ®°ÊÄÅÊ°ÜÂÖ≥Èó≠ÂäüËÉΩ
    document.querySelector('.close-modal').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    // Âä†ËΩΩÁ¨¨‰∏Ä‰∏™È°µÈù¢
    loadPage('dashboard');

    // ÊØè3ÁßíËá™Âä®Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆÔºàÊï∞ÊçÆÊ¶ÇËßàÈ°µÈù¢Ôºâ
    setInterval(() => {
        if (currentPage === 'dashboard') {
            loadStats();
        }
    }, 3000);

    // ÂàùÂßãÂä†ËΩΩÂÅ•Â∫∑Áä∂ÊÄÅ
    console.log('ÂàùÂßãÂåñÔºöÂºÄÂßãÂä†ËΩΩÂÅ•Â∫∑Áä∂ÊÄÅ');
    loadSiteHealthStatus();
    console.log('ÂàùÂßãÂåñÔºöÂÅ•Â∫∑Áä∂ÊÄÅÂä†ËΩΩÂáΩÊï∞Â∑≤Ë∞ÉÁî®');
});

        // ÂÖ®Â±ÄÂèòÈáèÂ≠òÂÇ®‰∏ä‰∏ÄÊ¨°ÁöÑÊï∞ÊçÆ
            let previousStats = {
                    total_requests: 0,
                    blocked_requests: 0,
                    total_sites: 0,
                    alive_sites: 0
                };
            // CCËßÑÂàôÁÆ°ÁêÜÂáΩÊï∞
                let currentCCLogsPage = 1;
                let currentCCLogsPageSize = 20;
                let currentCCLogsTotal = 0;
            
            // Â≠òÂÇ®Â±ïÂºÄÁöÑ‰∏äÊ∏∏ÊúçÂä°Âô®ËØ¶ÊÉÖÁ´ôÁÇπID
            let expandedUpstreamSites = new Set();
    </script>
    
    <!-- ToastÈÄöÁü•ÂÆπÂô® -->
    <div id="toast-container"></div>
</body>

</html>