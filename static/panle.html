<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç‹ç‹¸æ§åˆ¶å°</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦Š</text></svg>">
    
    <!-- Prism.js è¯­æ³•é«˜äº®åº“ -->
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script> -->

    <link href="prism-tomorrow.min.css" rel="stylesheet" />
    <link href="prism-line-numbers.min.css" rel="stylesheet" />
    <script src="prism-core.min.js"></script>
    <script src="prism-autoloader.min.js"></script>
    <script src="prism-line-numbers.min.js"></script>
    <script src="prism-copy-to-clipboard.min.js"></script>
    <script>
        // åœ¨é¡µé¢åŠ è½½å‰ç«‹å³åº”ç”¨ä¸»é¢˜ï¼Œé¿å…é—ªçƒ
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-theme');
                document.body.classList.add('dark-theme');
            }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #c8f5f5 0%, #a8e6e6 25%, #88d7d7 50%, #68c8c8 75%, #48b9b9 100%);
            font-family: "Comic Sans MS", "Microsoft YaHei", sans-serif;
            color: #444;
            min-height: 100vh;
            display: flex;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, #dceafe, #c8e0fa);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-header .fox {
            font-size: 60px;
            margin-bottom: 10px;
            animation: bounce 0.8s infinite alternate;
        }

        .sidebar-header h1 {
            color: #5210ed;
            font-size: 20px;
            background: linear-gradient(45deg, #5210ed, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            padding: 15px 25px;
            margin: 5px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #666;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: translateX(5px);
            color: #5210ed;
        }

        .nav-item.active {
            background: linear-gradient(45deg, #110d77, #5210ed);
            color: white;
            box-shadow: 0 4px 15px rgba(82, 16, 237, 0.3);
        }

        .nav-item .icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .nav-item .text {
            font-size: 16px;
            font-weight: 500;
        }

        /* ä¸»å†…å®¹åŒºæ ·å¼ */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            min-height: 100vh;
        }

        .content-header {
            background: linear-gradient(145deg, #dceafe, #c8e0fa);
            padding: 25px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .content-header h2 {
            color: #5210ed;
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #5210ed, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .content-body {
            background: linear-gradient(145deg, #dceafe, #c8e0fa);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            min-height: 500px;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-5px);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar-header h1,
            .nav-item .text {
                display: none;
            }

            .main-content {
                margin-left: 70px;
            }
        }

        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .metric-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
        }

        .metric-card.small {
            padding: 20px;
            text-align: center;
            justify-content: center;
        }
        
        /* ç«™ç‚¹è¡ŒèƒŒæ™¯é¢œè‰² */
        .row-alive {
            background-color: rgba(76, 175, 80, 0.15);
            transition: background-color 0.5s ease;
        }
        .row-alive:hover {
            background-color: rgba(76, 175, 80, 0.25);
        }
        .row-dead {
            background-color: rgba(244, 67, 54, 0.15);
            transition: background-color 0.5s ease;
        }
        .row-dead:hover {
            background-color: rgba(244, 67, 54, 0.25);
        }
        
        /* æ“ä½œæŒ‰é’®å®¹å™¨ */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .metric-icon {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            border-radius: 12px;
            color: white;
        }

        .metric-content {
            flex: 1;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #5210ed;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .refresh-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(82, 16, 237, 0.3);
        }

        .refresh-icon {
            font-size: 16px;
        }

        .last-update {
            font-size: 14px;
            color: #666;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        th {
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: rgba(82, 16, 237, 0.05);
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #5210ed;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(82, 16, 237, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #5210ed;
            box-shadow: 0 0 0 3px rgba(82, 16, 237, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #5210ed, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(82, 16, 237, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ed573, #7bed9f);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a4b0be, #747d8c);
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #5210ed;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom-color: #5210ed;
            color: #5210ed;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        .status-inactive {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .metric-row {
                grid-template-columns: 1fr;
            }
            
            .refresh-section {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .table-container {
                overflow-x: auto;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ¶ˆæ¯æç¤º */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
            border: 1px solid rgba(46, 213, 115, 0.3);
        }

        .alert-error {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle-btn {
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(82, 16, 237, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0;
        }

        .theme-toggle-btn:hover {
            background: rgba(82, 16, 237, 0.1);
            border-color: rgba(82, 16, 237, 0.5);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(82, 16, 237, 0.2);
        }

        .theme-toggle-btn:active {
            transform: scale(0.95);
        }

        /* æš—é»‘ä¸»é¢˜æ ·å¼ */
        body.dark-theme {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #0a2540 75%, #050816 100%);
            color: #e0e0e0;
        }

        body.dark-theme .sidebar {
            background: linear-gradient(145deg, #1e1e2e, #2a2a3e);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .sidebar-header {
            background: linear-gradient(145deg, #252538, #2f2f44);
        }

        body.dark-theme .nav-item {
            color: #d0d0d0;
        }

        body.dark-theme .nav-item:hover {
            background: rgba(82, 16, 237, 0.2);
            color: #fff;
        }

        body.dark-theme .nav-item.active {
            background: linear-gradient(145deg, #5210ed, #8b5cf6);
            color: #fff;
        }

        body.dark-theme .main-content {
            background: transparent;
        }

        body.dark-theme .content-header {
            background: linear-gradient(145deg, #2a2a3e, #3a3a4e);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .content-header h2 {
            color: #a78bfa;
        }

        body.dark-theme .content-header p {
            color: #b0b0b0;
        }

        body.dark-theme .card {
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        body.dark-theme .card-header {
            background: rgba(40, 40, 60, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .card-title {
            color: #a78bfa;
        }

        body.dark-theme .btn {
            background: linear-gradient(145deg, #5210ed, #8b5cf6);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark-theme .btn:hover {
            background: linear-gradient(145deg, #6d28d9, #9f7aea);
        }

        body.dark-theme .btn-secondary {
            background: rgba(60, 60, 80, 0.8);
            color: #e0e0e0;
        }

        body.dark-theme .metric-card {
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .metric-value {
            color: #a78bfa;
        }

        body.dark-theme .metric-label {
            color: #b0b0b0;
        }

        body.dark-theme .form-control,
        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background: rgba(40, 40, 60, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
        }

        body.dark-theme .form-control:focus,
        body.dark-theme input:focus,
        body.dark-theme select:focus,
        body.dark-theme textarea:focus {
            border-color: #8b5cf6;
            background: rgba(50, 50, 70, 0.8);
        }

        body.dark-theme .modal {
            background: rgba(0, 0, 0, 0.8);
        }

        body.dark-theme .modal-content {
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark-theme .modal-header {
            background: rgba(40, 40, 60, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .modal-title {
            color: #a78bfa;
        }

        body.dark-theme .code-container {
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .alert-success {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
            border: 1px solid rgba(46, 213, 115, 0.3);
        }

        body.dark-theme .alert-error {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        body.dark-theme .theme-toggle-btn {
            background: rgba(82, 16, 237, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
        }

        body.dark-theme .theme-toggle-btn:hover {
            background: rgba(82, 16, 237, 0.5);
            border-color: rgba(139, 92, 246, 0.7);
        }

        body.dark-theme table {
            background: rgba(30, 30, 46, 0.8);
            color: #e0e0e0;
        }

        body.dark-theme table th {
            background: rgba(40, 40, 60, 0.8);
            color: #a78bfa;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme table td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.dark-theme table tr:hover {
            background: rgba(82, 16, 237, 0.1);
        }

        body.dark-theme .table-container {
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .loading {
            color: #b0b0b0;
        }

        body.dark-theme h3,
        body.dark-theme h4,
        body.dark-theme h5 {
            color: #a78bfa;
        }

        body.dark-theme p {
            color: #b0b0b0;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #5210ed;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid rgba(82, 16, 237, 0.2);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn.active {
            background: #5210ed;
            color: white;
        }

        .page-btn:hover:not(.active) {
            background: rgba(82, 16, 237, 0.1);
        }
        /* åœ¨ç°æœ‰çš„CSSä¸­æ·»åŠ ä»¥ä¸‹æ ·å¼ */
        .status-indicator.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .status-indicator.clickable:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .status-indicator.clickable:active {
            transform: scale(0.95);
        }

        /* åœ¨ç°æœ‰çš„CSSä¸­æ·»åŠ  */
.code-block {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    border: 1px solid #e9ecef;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-section h4 {
    color: #5210ed;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid #5210ed;
}
/* åœ¨ç°æœ‰çš„CSSä¸­æ·»åŠ ä»¥ä¸‹æ ·å¼ */
.http-request {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.4;
    font-size: 13px;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 10px;
}

.http-request-line {
    color: #d63384;
    font-weight: bold;
}

.http-header {
    color: #0d6efd;
}

.http-body {
    color: #198754;
    margin-top: 10px;
}

.copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    padding: 5px 10px;
    font-size: 12px;
    background: rgba(82, 16, 237, 0.1);
    border: 1px solid rgba(82, 16, 237, 0.2);
}

.copy-btn:hover {
    background: rgba(82, 16, 237, 0.2);
}

/* åœ¨ç°æœ‰çš„CSSä¸­æ·»åŠ ä»¥ä¸‹æ ·å¼ */
.http-request {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.4;
    font-size: 13px;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 10px;
}

.http-request-line {
    color: #d63384;
    font-weight: bold;
}

.http-header {
    color: #0d6efd;
}

.http-body {
    color: #198754;
    margin-top: 10px;
}

.copy-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    padding: 5px 10px;
    font-size: 12px;
    background: rgba(82, 16, 237, 0.1);
    border: 1px solid rgba(82, 16, 237, 0.2);
}

.copy-btn:hover {
    background: rgba(82, 16, 237, 0.2);
}

/* ä»ªè¡¨ç›˜æ ·å¼ */
.dashboard-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.chart-container {
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.3);
    text-align: center;
}

.chart-title {
    font-size: 16px;
    font-weight: 600;
    color: #5210ed;
    margin-bottom: 15px;
}


.gauge-background {
    width: 100%;
    height: 60px;
    background: linear-gradient(90deg, 
        #ff4757 0%, 
        #ffa502 25%, 
        #2ed573 50%, 
        #1e90ff 75%, 
        #5352ed 100%);
    border-radius: 100px 100px 0 0;
    position: relative;
    overflow: hidden;
}

.gauge-fill {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.3);
    transform-origin: bottom center;
    transform: rotate(0deg);
    transition: transform 1s ease-in-out;
}

.gauge-needle {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 4px;
    height: 90px;
    background: #5210ed;
    transform-origin: bottom center;
    transform: translateX(-50%) rotate(0deg);
    transition: transform 1s ease-in-out;
    border-radius: 2px 2px 0 0;
}

.gauge-needle::after {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    background: #5210ed;
    border-radius: 50%;
}

.gauge-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 12px;
    color: #666;
}

.gauge-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    font-weight: bold;
    color: #5210ed;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}


.sites-gauge-circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        #2ed573 0% var(--alive-percent), 
        #ff4757 var(--alive-percent) 100%
    );
    position: relative;
}

.sites-gauge-inner {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    bottom: 20px;
    background: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.sites-gauge-value {
    font-size: 24px;
    font-weight: bold;
    color: #5210ed;
}

.sites-gauge-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.sites-gauge-legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: #666;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.legend-alive {
    background: #2ed573;
}

.legend-dead {
    background: #ff4757;
}



.value-changing {
    animation: valueChange 0.5s ease-in-out;
}

/* ä»ªè¡¨ç›˜æ ·å¼ */
.dashboard-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.chart-container {
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.3);
    text-align: center;
}

.chart-title {
    font-size: 16px;
    font-weight: 600;
    color: #5210ed;
    margin-bottom: 15px;
}

.gauge-chart {
    width: 200px;
    height: 120px;
    margin: 0 auto;
    position: relative;
}







.gauge-needle::after {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    background: #5210ed;
    border-radius: 50%;
}

.gauge-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 12px;
    color: #666;
}

.gauge-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    font-weight: bold;
    color: #5210ed;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ç«™ç‚¹çŠ¶æ€ä»ªè¡¨ç›˜ */
.sites-gauge {
    width: 200px;
    height: 200px;
    margin: 0 auto;
    position: relative;
}

.sites-gauge-circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        #2ed573 0% var(--alive-percent), 
        #ff4757 var(--alive-percent) 100%
    );
    position: relative;
}

.sites-gauge-inner {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    bottom: 20px;
    background: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.sites-gauge-value {
    font-size: 24px;
    font-weight: bold;
    color: #5210ed;
}

.sites-gauge-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.sites-gauge-legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: #666;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.legend-alive {
    background: #2ed573;
}

.legend-dead {
    background: #ff4757;
}

/* è¡¨æ ¼æ»šåŠ¨å®¹å™¨æ ·å¼ */
.table-scroll-container {
    max-height: 500px;
    overflow-y: auto;
    margin-bottom: 15px;
    border-radius: 12px;
    border: 1px solid rgba(82, 16, 237, 0.1);
}

/* ç¾åŒ–æ»šåŠ¨æ¡ */
.table-scroll-container::-webkit-scrollbar {
    width: 8px;
}

.table-scroll-container::-webkit-scrollbar-track {
    background: rgba(82, 16, 237, 0.05);
    border-radius: 4px;
}

.table-scroll-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    border-radius: 4px;
}

.table-scroll-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #4510c5, #7a52e0);
}

/* è¡¨æ ¼å¤´éƒ¨å›ºå®š */
.table-scroll-container table thead {
    position: sticky;
    top: 0;
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    z-index: 10;
}

/* è¡¨æ ¼æ ·å¼è°ƒæ•´ */
.table-scroll-container table {
    margin-bottom: 0;
}

.table-scroll-container table th {
    position: relative;
}

/* åˆ†é¡µä¿¡æ¯æ ·å¼ */
.pagination-info {
    text-align: center;
    margin: 10px 0;
    color: #666;
    font-size: 14px;
}

/* ç³»ç»Ÿç›‘æ§å¡ç‰‡æ ·å¼ */
.system-monitor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.monitor-card {
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.3);
    text-align: center;
}

.monitor-value {
    font-size: 28px;
    font-weight: bold;
    color: #5210ed;
    margin-bottom: 5px;
}

.monitor-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
}

.monitor-details {
    font-size: 12px;
    color: #888;
    margin-top: 10px;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .system-monitor-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard-charts {
        grid-template-columns: 1fr;
    }
}

/* ä»£ç é«˜äº®å’Œæ—¥å¿—æ˜¾ç¤ºæ ·å¼ */
.code-container {
    background: #2d3748;
    border-radius: 8px;
    padding: 0;
    margin: 15px 0;
    overflow: hidden;
    border: 1px solid #4a5568;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.code-header {
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    color: white;
    padding: 10px 15px;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.code-content {
    max-height: 400px;
    overflow-y: auto;
    background: #2d3748;
}

.code-content pre {
    margin: 0 !important;
    background: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    padding: 15px !important;
    font-size: 13px;
    line-height: 1.5;
}

.code-content code {
    background: transparent !important;
    color: #e2e8f0 !important;
    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace !important;
}

/* æ—¥å¿—è¯¦æƒ…æ ·å¼ */
.log-detail-container {
    background: #f8f9fa;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e9ecef;
    margin: 15px 0;
}

.log-detail-header {
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    color: white;
    padding: 15px 20px;
    font-weight: 600;
}

.log-detail-content {
    padding: 20px;
}

.log-field {
    display: flex;
    margin-bottom: 12px;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 8px;
}

.log-field-label {
    font-weight: 600;
    color: #495057;
    min-width: 120px;
    margin-right: 15px;
}

.log-field-value {
    flex: 1;
    color: #6c757d;
    word-break: break-all;
    font-family: 'Monaco', 'Consolas', monospace;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

.log-field-value.highlight {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

/* æ”»å‡»æ—¥å¿—è¡¨æ ¼ç¾åŒ– */
.attack-logs-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.attack-logs-table th {
    background: linear-gradient(135deg, #5210ed, #8b5cf6);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 15px 10px;
    border: none;
}

.attack-logs-table td {
    padding: 12px 10px;
    border-bottom: 1px solid #f1f3f4;
    vertical-align: middle;
}

.attack-logs-table tr:hover {
    background: rgba(82, 16, 237, 0.05);
}

.log-method-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.log-method-get { background: #d4edda; color: #155724; }
.log-method-post { background: #cce5ff; color: #004085; }
.log-method-put { background: #fff3cd; color: #856404; }
.log-method-delete { background: #f8d7da; color: #721c24; }
.log-method-default { background: #e2e3e5; color: #383d41; }

.log-rule-name {
    font-weight: 600;
    color: #5210ed;
}

.log-matched-content {
    font-family: 'Monaco', 'Consolas', monospace;
    background: #f8f9fa;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 12px;
    border: 1px solid #e9ecef;
}

/* ç¼“å­˜æ–‡ä»¶å†…å®¹æ ·å¼ */
.cache-file-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
}

.cache-file-info table {
    width: 100%;
    border-collapse: collapse;
}

.cache-file-info td {
    padding: 8px;
    border-bottom: 1px solid #e9ecef;
}

.cache-file-info td:first-child {
    font-weight: 600;
    color: #495057;
    width: 120px;
}

/* Prism.js ä¸»é¢˜è¦†ç›– */
pre[class*="language-"] {
    background: #2d3748 !important;
    border: none !important;
    border-radius: 0 !important;
}

code[class*="language-"] {
    color: #e2e8f0 !important;
    background: transparent !important;
}

.token.comment { color: #718096 !important; }
.token.string { color: #68d391 !important; }
.token.number { color: #f6ad55 !important; }
.token.keyword { color: #9f7aea !important; }
.token.operator { color: #4fd1c7 !important; }
.token.punctuation { color: #a0aec0 !important; }




    </style>
</head>

<body>
    <!-- ä¾§è¾¹å¯¼èˆªæ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="fox">ğŸ¦Š</div>
            <h1>å°ç‹ç‹¸æ§åˆ¶å°</h1>
        </div>

        <div class="nav-menu">
            <a href="javascript:void(0)" class="nav-item active" data-page="dashboard">
                <span class="icon">ğŸ“Š</span>
                <span class="text">æ•°æ®æ¦‚è§ˆ</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="acl">
                <span class="icon">ğŸ›¡ï¸</span>
                <span class="text">ACLè§„åˆ™</span>
            </a>
            <!-- åœ¨ç°æœ‰çš„å¯¼èˆªèœå•ä¸­æ·»åŠ  -->
            <a href="javascript:void(0)" class="nav-item" data-page="cc">
                <span class="icon">ğŸš«</span>
                <span class="text">CCæ‹¦æˆª</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="cache">
                <span class="icon">âš¡</span>
                <span class="text">ç¼“å­˜ç®¡ç†</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="sites">
                <span class="icon">ğŸŒ</span>
                <span class="text">ç«™ç‚¹ç®¡ç†</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="logs">
                <span class="icon">ğŸ“</span>
                <span class="text">æ”»å‡»æ—¥å¿—</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" data-page="blocked_rules">
        <span class="icon">ğŸš«</span>
        <span class="text">è¢«ç¦ç”¨çš„è§„åˆ™</span>
            </a>
            <!-- åœ¨ç°æœ‰çš„å¯¼èˆªèœå•ä¸­æ·»åŠ  -->
<a href="javascript:void(0)" class="nav-item" data-page="custom_rules">
    <span class="icon">ğŸ“</span>
    <span class="text">è§„åˆ™ç®¡ç†</span>
</a>
            <a href="javascript:void(0)" class="nav-item" data-page="settings">
                <span class="icon">âš™ï¸</span>
                <span class="text">ç³»ç»Ÿè®¾ç½®</span>
            </a>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <div class="content-header">
            <div>
                <h2 id="page-title">æ•°æ®æ¦‚è§ˆ</h2>
                <p id="page-description">æ¬¢è¿æ¥åˆ°å°ç‹ç‹¸WAFæ§åˆ¶å°</p>
            </div>
            <button id="theme-toggle" class="theme-toggle-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <span id="theme-icon">ğŸŒ™</span>
            </button>
        </div>

        <div class="content-body" id="content-container">
            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">æ¨¡æ€æ¡†æ ‡é¢˜</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="modal-body">
                <!-- æ¨¡æ€æ¡†å†…å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 'dashboard';
        let currentLogsPage = 1;
        let currentLogsPageSize = 20;
        let currentLogsTotal = 0;

        // é¡µé¢å†…å®¹å®šä¹‰
        const pageContents = {
            dashboard: {
    title: "æ•°æ®æ¦‚è§ˆ",
    description: "ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯",
    content: `
        <div class="dashboard-grid">
            <div class="metric-row">
                <div class="metric-card">
                    <div class="metric-icon">ğŸŒ</div>
                    <div class="metric-content">
                        <div class="metric-value" id="total-requests">0</div>
                        <div class="metric-label">æ€»è¯·æ±‚æ•°</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">ğŸ›¡ï¸</div>
                    <div class="metric-content">
                        <div class="metric-value" id="blocked-requests">0</div>
                        <div class="metric-label">æ‹¦æˆªæ”»å‡»</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">ğŸŒ</div>
                    <div class="metric-content">
                        <div class="metric-value" id="total-sites">0</div>
                        <div class="metric-label">æ€»ç«™ç‚¹æ•°</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">âœ…</div>
                    <div class="metric-content">
                        <div class="metric-value" id="alive-sites">0</div>
                        <div class="metric-label">å­˜æ´»ç«™ç‚¹</div>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢ï¼šç³»ç»Ÿç›‘æ§ä»ªè¡¨ç›˜ -->
            <div class="dashboard-charts">
                <div class="chart-container">
                    <div class="chart-title">ğŸ“Š ç«¯å£è¯·æ±‚é€Ÿç‡</div>
                    <div id="port-stats-container">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">ğŸ’» CPUä½¿ç”¨ç‡</div>
                    <div id="cpu-stats-container">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">ğŸ’¾ å†…å­˜ä½¿ç”¨ç‡</div>
                    <div id="memory-stats-container">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>

            
            
            <div class="refresh-section">
                <button class="refresh-btn" onclick="refreshAllStats()">
                    <span class="refresh-icon">ğŸ”„</span> åˆ·æ–°æ•°æ®
                </button>
                <div class="last-update">
                    æœ€åæ›´æ–°: <span id="last-update">${new Date().toLocaleTimeString()}</span>
                </div>
            </div>
        </div>
    `
},
            acl: {
                title: "ACLè§„åˆ™ç®¡ç†",
                description: "è®¿é—®æ§åˆ¶åˆ—è¡¨è§„åˆ™é…ç½®",
                content: `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ›¡ï¸ ACLè§„åˆ™åˆ—è¡¨</h3>
                            <button class="btn" onclick="showAddACLModal()">
                                <span>+</span> æ·»åŠ è§„åˆ™
                            </button>
                        </div>
                        <div id="acl-rules-container">
                            <div class="loading">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                `
            },
            // åœ¨ pageContents å¯¹è±¡ä¸­æ·»åŠ 
            cc: {
                title: "CCæ”»å‡»æ‹¦æˆª",
                description: "CCæ”»å‡»é˜²æŠ¤è§„åˆ™é…ç½®å’Œç»Ÿè®¡",
                content: `
                <div class="card">
            <div class="card-header">
                <h3 class="card-title">ğŸ“Š CCæ”»å‡»ç»Ÿè®¡</h3>
                <button class="btn" onclick="refreshCCStats()">
                    <span>ğŸ”„</span> åˆ·æ–°
                </button>
            </div>
            <div id="cc-stats-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ğŸš« CCè§„åˆ™åˆ—è¡¨</h3>
                <button class="btn" onclick="showAddCCRuleModal()">
                    <span>+</span> æ·»åŠ è§„åˆ™
                </button>
            </div>
            <div id="cc-rules-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ğŸ“ CCæ”»å‡»æ—¥å¿—</h3>
                <button class="btn" onclick="clearCCCounters()">
                    <span>ğŸ—‘ï¸</span> æ¸…ç©ºè®¡æ•°å™¨
                </button>
            </div>
            
            <div class="form-group">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="cc-client-ip-filter" class="form-control" placeholder="å®¢æˆ·ç«¯IP" style="width: 150px;">
                    <input type="text" id="cc-domain-filter" class="form-control" placeholder="åŸŸå" style="width: 150px;">
                    <input type="text" id="cc-rule-id-filter" class="form-control" placeholder="è§„åˆ™ID" style="width: 120px;">
                    <input type="date" id="cc-start-date" class="form-control" style="width: 150px;">
                    <input type="date" id="cc-end-date" class="form-control" style="width: 150px;">
                    <button class="btn" onclick="loadCCAttackLogs(1)">
                        <span>ğŸ”</span> æœç´¢
                    </button>
                </div>
            </div>
            
            <div id="cc-logs-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            
            <div id="cc-logs-pagination" class="pagination"></div>
        </div>
    `
            },
            // ä¿®æ”¹ç¼“å­˜ç®¡ç†é¡µé¢å†…å®¹
            cache: {
    title: "ç¼“å­˜ç®¡ç†",
    description: "é™æ€ç¼“å­˜é…ç½®å’Œç»Ÿè®¡",
    content: `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">âš¡ ç¼“å­˜ç»Ÿè®¡</h3>
                <div>
                    <button class="btn btn-secondary" onclick="clearCache()">
                        <span>ğŸ—‘ï¸</span> æ¸…ç©ºç¼“å­˜
                    </button>
                    <button class="btn" onclick="refreshCacheStats()">
                        <span>ğŸ”„</span> åˆ·æ–°
                    </button>
                </div>
            </div>
            <div id="cache-stats-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ğŸ“ ç¼“å­˜æ–‡ä»¶åˆ—è¡¨</h3>
            </div>
            <div id="cache-files-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <!-- æ·»åŠ åˆ†é¡µå®¹å™¨ -->
            <div id="cache-files-pagination" class="pagination"></div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">âš™ï¸ ç¼“å­˜é…ç½®</h3>
            </div>
            <div id="cache-config-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    `
},
            sites: {
                title: "ç«™ç‚¹ç®¡ç†",
                description: "åå‘ä»£ç†ç«™ç‚¹é…ç½®",
                content: `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸŒ ç«™ç‚¹åˆ—è¡¨</h3>
                            <button class="btn" onclick="showAddSiteModal()">
                                <span>+</span> æ·»åŠ ç«™ç‚¹
                            </button>
                        </div>
                        <div id="sites-container">
                            <div class="loading">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                `
            },
            logs: {
                title: "æ”»å‡»æ—¥å¿—",
                description: "æŸ¥çœ‹å’Œåˆ†ææ”»å‡»è®°å½•",
                content: `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“ æ”»å‡»æ—¥å¿—</h3>
                            <div>
                                <button class="btn btn-secondary" onclick="exportLogs()">
                                    <span>ğŸ“¤</span> å¯¼å‡ºæ—¥å¿—
                                </button>
                                <button class="btn btn-danger" onclick="showDeleteLogsModal()">
                                    <span>ğŸ—‘ï¸</span> åˆ é™¤æ—¥å¿—
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select id="log-method-filter" class="form-control" style="width: 150px;">
                                    <option value="">æ‰€æœ‰æ–¹æ³•</option>
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                                <input type="text" id="log-rule-filter" class="form-control" placeholder="è§„åˆ™åç§°" style="width: 200px;">
                                <input type="date" id="log-start-date" class="form-control" style="width: 150px;">
                                <input type="date" id="log-end-date" class="form-control" style="width: 150px;">
                                <button class="btn" onclick="loadAttackLogs(1)">
                                    <span>ğŸ”</span> æœç´¢
                                </button>
                            </div>
                        </div>
                        
                        <div id="logs-container">
                            <div class="loading">åŠ è½½ä¸­...</div>
                        </div>
                        
                        <div id="logs-pagination" class="pagination"></div>
                    </div>
                `
            },
            settings: {
                title: "ç³»ç»Ÿè®¾ç½®",
                description: "ç³»ç»Ÿé…ç½®å’Œå‚æ•°è°ƒæ•´",
                content: `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
            </div>
            
            <div id="settings-message"></div>
            
            <form id="settings-form">
                <div class="form-group">
                    <label class="form-label">é˜²å¼€å‘è€…å·¥å…·</label>
                    <div>
                        <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                            <input type="radio" name="anti-devtools" value="true"> å¯ç”¨
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 8px;">
                            <input type="radio" name="anti-devtools" value="false"> ç¦ç”¨
                        </label>
                    </div>
                </div>
                
                <!-- æ–°å¢ï¼šJSæ··æ·†å¼€å…³ -->
                <div class="form-group">
                    <label class="form-label">JSæ··æ·†</label>
                    <div>
                        <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                            <input type="radio" name="js-obfuscation" value="true"> å¯ç”¨
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 8px;">
                            <input type="radio" name="js-obfuscation" value="false"> ç¦ç”¨
                        </label>
                    </div>
                    <small style="color: #666;">å¯ç”¨åä¼šå¯¹å‰ç«¯JavaScriptä»£ç è¿›è¡Œæ··æ·†ï¼Œå¢å¼ºå®‰å…¨æ€§</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è§„åˆ™åŒ¹é…ç‡ (%)</label>
                    <input type="range" id="rule-match-rate" min="0" max="100" value="100" class="form-control">
                    <div id="rule-match-rate-value" style="text-align: center; margin-top: 5px;">100%</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Base64 è§£ç æ·±åº¦</label>
                    <input type="number" id="base64-depth" min="0" max="10" value="2" class="form-control">
                    <small style="color: #666;">è®¾ç½®Base64è§£ç çš„æœ€å¤§æ·±åº¦ï¼Œ0è¡¨ç¤ºç¦ç”¨Base64è§£ç </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">URL è§£ç æ·±åº¦</label>
                    <input type="number" id="url-depth" min="0" max="10" value="2" class="form-control">
                    <small style="color: #666;">è®¾ç½®URLè§£ç çš„æœ€å¤§æ·±åº¦ï¼Œ0è¡¨ç¤ºç¦ç”¨URLè§£ç </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è§„åˆ™ç®¡ç†</label>
                    <div>
                        <button type="button" class="btn btn-secondary" onclick="reloadCustomRules()" style="margin-right: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 15px 0 rgba(116, 75, 162, 0.3); transition: all 0.3s ease; position: relative; overflow: hidden;">
                            <span style="font-size: 16px; margin-right: 8px;">ğŸ”„</span> é‡æ–°åŠ è½½è§„åˆ™
                        </button>
                        <button type="button" class="btn" onclick="saveSettings()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 15px 0 rgba(245, 87, 108, 0.3); transition: all 0.3s ease;">
                            <span style="font-size: 16px; margin-right: 8px;">ğŸ’¾</span> ä¿å­˜è®¾ç½®
                        </button>
                    </div>
                    <small style="color: #666;">ç‚¹å‡»"é‡æ–°åŠ è½½è§„åˆ™"æŒ‰é’®å¯ä»¥é‡æ–°åŠ è½½æ‰€æœ‰è§„åˆ™æ–‡ä»¶</small>
                </div>
                
                <style>
                .btn.btn-secondary:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 25px 0 rgba(116, 75, 162, 0.5);
                }
                
                .btn:not(.btn-secondary):hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 25px 0 rgba(245, 87, 108, 0.5);
                }
                </style>
            </form>
        </div>
    `
            },
            blocked_rules: {
        title: "è¢«ç¦ç”¨çš„è§„åˆ™",
        description: "æŸ¥çœ‹å’Œç®¡ç†è¢«ç¦ç”¨çš„é˜²æŠ¤è§„åˆ™",
        content: `
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸš« è¢«ç¦ç”¨çš„è§„åˆ™åˆ—è¡¨</h3>
                    <button class="btn" onclick="loadBlockedRules()">
                        <span>ğŸ”„</span> åˆ·æ–°
                    </button>
                </div>
                <div id="blocked-rules-container">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        `
    },
    // åœ¨ pageContents å¯¹è±¡ä¸­æ·»åŠ 
custom_rules: {
    title: "è‡ªå®šä¹‰è§„åˆ™ç®¡ç†",
    description: "ç®¡ç†ç”¨æˆ·è‡ªå®šä¹‰çš„WAFé˜²æŠ¤è§„åˆ™",
    content: `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ğŸ“ è‡ªå®šä¹‰è§„åˆ™åˆ—è¡¨</h3>
                <div>
                    <button class="btn btn-secondary" onclick="exportCustomRules()">
                        <span>ğŸ“¤</span> å¯¼å‡ºè§„åˆ™
                    </button>
                    <button class="btn btn-secondary" onclick="showImportRulesModal()">
                        <span>ğŸ“¥</span> å¯¼å…¥è§„åˆ™
                    </button>
                    <button class="btn" onclick="showAddCustomRuleModal()">
                        <span>+</span> æ·»åŠ è§„åˆ™
                    </button>
                </div>
            </div>
            <div id="custom-rules-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">â„¹ï¸ è§„åˆ™è¯´æ˜</h3>
            </div>
            <div style="padding: 20px;">
                <h4 style="color: #5210ed; margin-bottom: 15px;">è§„åˆ™é…ç½®è¯´æ˜</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5>ä½ç½® (Position):</h5>
                        <ul style="color: #666; line-height: 1.6;">
                            <li><strong>uri</strong> - è¯·æ±‚URLè·¯å¾„</li>
                            <li><strong>request_header</strong> - è¯·æ±‚å¤´</li>
                            <li><strong>request_body</strong> - è¯·æ±‚ä½“</li>
                            <li><strong>parameter_value</strong> - URLå‚æ•°å€¼</li>
                            <li><strong>form_values</strong> - è¡¨å•å€¼</li>
                        </ul>
                    </div>
                    <div>
                        <h5>åŒ¹é…æ–¹å¼:</h5>
                        <ul style="color: #666; line-height: 1.6;">
                            <li><strong>Content</strong> - ç®€å•å­—ç¬¦ä¸²åŒ¹é…</li>
                            <li><strong>Rix (æ­£åˆ™)</strong> - æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</li>
                            <li><strong>Action</strong> - "is" åŒ¹é… / "not" ä¸åŒ¹é…</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `
}
        }

        // æ˜¾ç¤ºè¢«ç¦ç”¨çš„è§„åˆ™
// æ”¹è¿›çš„æ˜¾ç¤ºè¢«ç¦ç”¨è§„åˆ™å‡½æ•°
async function displayBlockedRules(blockedRuleIds) {
    const container = document.getElementById('blocked-rules-container');

    if (!blockedRuleIds || blockedRuleIds.length === 0) {
        container.innerHTML = '<div class="alert">æš‚æ— è¢«ç¦ç”¨çš„è§„åˆ™</div>';
        return;
    }

    // åˆ†é¡µå¤„ç†
    const pageSize = 10;
    const totalPages = Math.ceil(blockedRuleIds.length / pageSize);
    const currentPage = 1;
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const displayRules = blockedRuleIds.slice(startIndex, endIndex);

    // è·å–æ‰€æœ‰è§„åˆ™æ¥æ˜¾ç¤ºåç§°ï¼ˆè¿™é‡Œéœ€è¦ä½ æä¾›è·å–æ‰€æœ‰è§„åˆ™çš„æ¥å£ï¼‰
    const allRules = await getAllRules();
    
    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>è§„åˆ™ID</th>
                        <th>è§„åˆ™åç§°</th>
                        <th>è§„åˆ™æ–¹æ³•</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;

    displayRules.forEach(ruleId => {
        // åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä» allRules ä¸­æŸ¥æ‰¾è§„åˆ™åç§°
        const ruleName = `è§„åˆ™ ${ruleId}`; // ä¸´æ—¶æ˜¾ç¤º
        const ruleMethod = 'æœªçŸ¥'; // ä¸´æ—¶æ˜¾ç¤º
        
        html += `
            <tr>
                <td>${ruleId}</td>
                <td title="${ruleName}">${ruleName.length > 15 ? ruleName.substring(0, 15) + '...' : ruleName}</td>
                <td>${ruleMethod}</td>
                <td>
                    <span class="status-indicator status-inactive">
                        å·²ç¦ç”¨
                    </span>
                </td>
                <td>
                    <button class="btn btn-success" onclick="enableRule('${ruleId}')">
                        å¯ç”¨
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            æ˜¾ç¤º 1-${displayRules.length} æ¡ï¼Œå…± ${blockedRuleIds.length} æ¡è¢«ç¦ç”¨çš„è§„åˆ™
        </div>
    `;

    container.innerHTML = html;
}

// å¯ç”¨è§„åˆ™
async function enableRule(ruleId) {
    if (!confirm(`ç¡®å®šè¦å¯ç”¨è§„åˆ™ ID: ${ruleId} å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch('/api/rules/status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                rule_id: ruleId,
                enable: true
            })
        });

        if (response.ok) {
            showMessage(`è§„åˆ™ ${ruleId} å·²å¯ç”¨`, 'success');
            // åˆ·æ–°è¢«ç¦ç”¨çš„è§„åˆ™åˆ—è¡¨
            loadBlockedRules();
        } else {
            const error = await response.text();
            showMessage('å¯ç”¨å¤±è´¥: ' + error, 'error');
        }
    } catch (error) {
        console.error('å¯ç”¨è§„åˆ™é”™è¯¯:', error);
        showMessage('å¯ç”¨å¤±è´¥', 'error');
    }
}



        // åŠ è½½è¢«ç¦ç”¨çš„è§„åˆ™
async function loadBlockedRules() {
    try {
        const response = await fetch('/api/rule/blockRuleId', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            displayBlockedRules(data.id);
        } else {
            document.getElementById('blocked-rules-container').innerHTML = '<div class="alert alert-error">åŠ è½½è¢«ç¦ç”¨è§„åˆ™å¤±è´¥</div>';
        }
    } catch (error) {
        console.error('åŠ è½½è¢«ç¦ç”¨è§„åˆ™é”™è¯¯:', error);
        document.getElementById('blocked-rules-container').innerHTML = '<div class="alert alert-error">åŠ è½½è¢«ç¦ç”¨è§„åˆ™å¤±è´¥</div>';
    }
}

        // é¡µé¢åˆ‡æ¢åŠŸèƒ½
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                // æ·»åŠ å½“å‰activeç±»
                this.classList.add('active');
                
                // è·å–é¡µé¢æ ‡è¯†
                const pageId = this.getAttribute('data-page');
                loadPage(pageId);
            });
        });

        // ä¿®æ”¹é¡µé¢åŠ è½½å‡½æ•°ï¼Œåœ¨dashboardé¡µé¢åŠ è½½ç³»ç»Ÿç›‘æ§æ•°æ®
function loadPage(pageId) {
    currentPage = pageId;
    const page = pageContents[pageId];
    if (page) {
        document.getElementById('page-title').textContent = page.title;
        document.getElementById('page-description').textContent = page.description;
        document.getElementById('content-container').innerHTML = page.content;

        // åŠ è½½é¡µé¢ç‰¹å®šæ•°æ®
        switch (pageId) {
            case 'dashboard':
                loadStats(); // è¿™ä¼šåŒæ—¶åŠ è½½åŸºæœ¬ç»Ÿè®¡å’Œç³»ç»Ÿç›‘æ§
                break;
            case 'acl':
                loadACLRules();
                break;
            case 'cache':
                loadCacheStats();
                loadCacheConfig();
                loadCacheFiles(1);
                break;
            case 'sites':
                loadSites();
                // ç¡®ä¿å¥åº·çŠ¶æ€å·²åŠ è½½
                if (!window.siteHealthData || Object.keys(window.siteHealthData).length === 0) {
                    loadSiteHealthStatus();
                }
                break;
            case 'logs':
                loadAttackLogs(1);
                break;
            case 'settings':
                loadSettings();
                break;
            case 'cc':
                loadCCRules();
                loadCCStats();
                loadCCAttackLogs(1);
                break;
            case 'blocked_rules':
                loadBlockedRules();
                break;
            // åœ¨ loadPage å‡½æ•°çš„ switch è¯­å¥ä¸­æ·»åŠ 
            case 'custom_rules':
                loadCustomRules();
                break;
        }
    }
}

// åŠ è½½è‡ªå®šä¹‰è§„åˆ™
async function loadCustomRules() {
    try {
        const response = await fetch('/api/rules/reload', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            displayCustomRules(data.rules);
        } else {
            const container = document.getElementById('custom-rules-container');
            if (container) {
                container.innerHTML = '<div class="alert alert-error">åŠ è½½è‡ªå®šä¹‰è§„åˆ™å¤±è´¥</div>';
            }
        }
    } catch (error) {
        console.error('åŠ è½½è‡ªå®šä¹‰è§„åˆ™é”™è¯¯:', error);
        const container = document.getElementById('custom-rules-container');
        if (container) {
            container.innerHTML = '<div class="alert alert-error">åŠ è½½è‡ªå®šä¹‰è§„åˆ™å¤±è´¥</div>';
        }
    }
}

// æ˜¾ç¤ºè‡ªå®šä¹‰è§„åˆ™
function displayCustomRules(rules) {
    const container = document.getElementById('custom-rules-container');
    
    if (!container) {
        return;
    }

    if (!rules || rules.length === 0) {
        container.innerHTML = `
            <div class="alert" style="text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
                <h3 style="color: #5210ed; margin-bottom: 10px;">æš‚æ— è‡ªå®šä¹‰è§„åˆ™</h3>
                <p style="color: #666; margin-bottom: 20px;">å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€æ¡è‡ªå®šä¹‰è§„åˆ™æ¥å¢å¼ºWAFé˜²æŠ¤èƒ½åŠ›</p>
                <button class="btn" onclick="showAddCustomRuleModal()">
                    <span>+</span> åˆ›å»ºç¬¬ä¸€æ¡è§„åˆ™
                </button>
            </div>
        `;
        return;
    }

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åç§°</th>
                        <th>æ–¹æ³•</th>
                        <th>å…³ç³»</th>
                        <th>åˆ¤æ–­æ¡ä»¶</th>
                        <th>çŠ¶æ€</th>
                        <th>æè¿°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;

    rules.forEach(rule => {
        const judgesText = rule.Judges.map(judge => {
            let text = `${judge.Position}: `;
            if (judge.Rix) {
                text += `æ­£åˆ™(${judge.Rix.length > 10 ? judge.Rix.substring(0, 10) + '...' : judge.Rix})`;
            } else if (judge.Content) {
                text += `å†…å®¹(${judge.Content.length > 10 ? judge.Content.substring(0, 10) + '...' : judge.Content})`;
            }
            if (judge.Action) {
                text += ` [${judge.Action}]`;
            }
            return text;
        }).join('; ');

        html += `
        <tr>
            <td>${rule.ID}</td>
            <td title="${rule.Name}">${rule.Name.length > 15 ? rule.Name.substring(0, 15) + '...' : rule.Name}</td>
            <td>
                <span class="status-indicator ${rule.Method === 'any' ? 'status-active' : 'status-inactive'}">
                    ${rule.Method}
                </span>
            </td>
            <td>${rule.Relation || 'and'}</td>
            <td title="${judgesText}">${judgesText.length > 20 ? judgesText.substring(0, 20) + '...' : judgesText}</td>
            <td>
                <span class="status-indicator ${rule.Enabled ? 'status-active' : 'status-inactive'} clickable" 
                      onclick="toggleCustomRuleStatus('${rule.ID}', ${!rule.Enabled})"
                      title="ç‚¹å‡»åˆ‡æ¢çŠ¶æ€">
                    ${rule.Enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                </span>
            </td>
            <td title="${rule.Description || 'æ— æè¿°'}">
                ${rule.Description ? (rule.Description.length > 15 ? rule.Description.substring(0, 15) + '...' : rule.Description) : '-'}
            </td>
            <td>
                <div class="action-buttons">
                    <button class="btn" onclick="showEditCustomRuleModal('${rule.ID}')">ç¼–è¾‘</button>
                    <button class="btn btn-danger" onclick="deleteCustomRule('${rule.ID}')">åˆ é™¤</button>
                </div>
            </td>
        </tr>
    `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            å…± ${rules.length} æ¡è‡ªå®šä¹‰è§„åˆ™
        </div>
    `;

    container.innerHTML = html;
}

// æ˜¾ç¤ºæ·»åŠ è‡ªå®šä¹‰è§„åˆ™æ¨¡æ€æ¡†
function showAddCustomRuleModal() {
    document.getElementById('modal-title').textContent = 'æ·»åŠ è‡ªå®šä¹‰è§„åˆ™';
    document.getElementById('modal-body').innerHTML = `
        <form id="add-custom-rule-form">
            <div class="form-group">
                <label class="form-label">è§„åˆ™åç§°</label>
                <input type="text" name="name" class="form-control" placeholder="ä¾‹å¦‚: SQLæ³¨å…¥é˜²æŠ¤" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">HTTPæ–¹æ³•</label>
                <select name="method" class="form-control" required>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="any">ä»»æ„æ–¹æ³• (any)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ¡ä»¶å…³ç³»</label>
                <select name="relation" class="form-control" required>
                    <option value="and">AND (æ‰€æœ‰æ¡ä»¶éƒ½è¦æ»¡è¶³)</option>
                    <option value="or">OR (ä»»æ„æ¡ä»¶æ»¡è¶³)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">è§„åˆ™æè¿°</label>
                <textarea name="description" class="form-control" placeholder="è§„åˆ™æè¿°ä¿¡æ¯"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">åˆ¤æ–­æ¡ä»¶</label>
                <div id="judges-container">
                    <div class="judge-item" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <select name="position" class="form-control" required>
                                <option value="uri">URI</option>
                                <option value="request_header">è¯·æ±‚å¤´</option>
                                <option value="request_body">è¯·æ±‚ä½“</option>
                                <option value="parameter_value">å‚æ•°å€¼</option>
                                <option value="form_values">è¡¨å•å€¼</option>
                            </select>
                            <input type="text" name="content" class="form-control" placeholder="åŒ¹é…å†…å®¹ (å¯é€‰)">
                            <input type="text" name="rix" class="form-control" placeholder="æ­£åˆ™è¡¨è¾¾å¼ (å¯é€‰)">
                            <select name="action" class="form-control">
                                <option value="is">åŒ¹é… (is)</option>
                                <option value="not">ä¸åŒ¹é… (not)</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removeJudge(this)" style="padding: 5px 10px; font-size: 12px;">åˆ é™¤æ¡ä»¶</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addJudge()" style="margin-top: 10px;">
                    <span>+</span> æ·»åŠ æ¡ä»¶
                </button>
            </div>
            
            <div class="form-group">
                <label style="display: inline-flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="enabled" checked> å¯ç”¨è§„åˆ™
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn">æ·»åŠ è§„åˆ™</button>
            </div>
        </form>
    `;

    document.getElementById('add-custom-rule-form').addEventListener('submit', function(e) {
        e.preventDefault();
        addCustomRule(new FormData(this));
    });

    showModal();
    
    // è§¦å‘ä»£ç é«˜äº®
    setTimeout(() => {
        if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
        }
    }, 100);
}

// ä¿®æ”¹æ·»åŠ åˆ¤æ–­æ¡ä»¶çš„HTMLï¼Œç¡®ä¿é»˜è®¤å€¼æ­£ç¡®
function addJudge() {
    const container = document.getElementById('judges-container');
    const judgeItem = document.createElement('div');
    judgeItem.className = 'judge-item';
    judgeItem.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;';
    
    judgeItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <select name="position" class="form-control" required>
                <option value="uri">URI</option>
                <option value="request_header">è¯·æ±‚å¤´</option>
                <option value="request_body">è¯·æ±‚ä½“</option>
                <option value="parameter_value">å‚æ•°å€¼</option>
                <option value="form_values">è¡¨å•å€¼</option>
            </select>
            <input type="text" name="content" class="form-control" placeholder="åŒ¹é…å†…å®¹ (ä¸æ­£åˆ™äºŒé€‰ä¸€)">
            <input type="text" name="rix" class="form-control" placeholder="æ­£åˆ™è¡¨è¾¾å¼ (ä¸å†…å®¹äºŒé€‰ä¸€)">
            <select name="action" class="form-control">
                <option value="is">åŒ¹é… (is)</option>
                <option value="not">ä¸åŒ¹é… (not)</option>
            </select>
        </div>
        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
            <strong>æç¤º:</strong> å†…å®¹å’Œæ­£åˆ™è¡¨è¾¾å¼è‡³å°‘å¡«å†™ä¸€ä¸ª
        </div>
        <button type="button" class="btn btn-danger" onclick="removeJudge(this)" style="padding: 5px 10px; font-size: 12px;">åˆ é™¤æ¡ä»¶</button>
    `;
    
    container.appendChild(judgeItem);
}


// åˆ é™¤åˆ¤æ–­æ¡ä»¶
function removeJudge(button) {
    const judgeItem = button.closest('.judge-item');
    if (document.querySelectorAll('.judge-item').length > 1) {
        judgeItem.remove();
    } else {
        showMessage('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶', 'error');
    }
}

// ä¿®æ”¹æ·»åŠ è‡ªå®šä¹‰è§„åˆ™å‡½æ•°
async function addCustomRule(formData) {
    try {
        const data = Object.fromEntries(formData);
        
        // å¤„ç†åˆ¤æ–­æ¡ä»¶
        const judges = [];
        const judgeItems = document.querySelectorAll('.judge-item');
        
        judgeItems.forEach(item => {
            const judge = {
                position: item.querySelector('select[name="position"]').value,
                content: item.querySelector('input[name="content"]').value,
                rix: item.querySelector('input[name="rix"]').value,
                action: item.querySelector('select[name="action"]').value || 'is' // é»˜è®¤å€¼
            };
            
            // å¦‚æœå†…å®¹å’Œæ­£åˆ™éƒ½ä¸ºç©ºï¼Œè·³è¿‡è¿™ä¸ªæ¡ä»¶
            if (!judge.content && !judge.rix) {
                return;
            }
            
            // å¦‚æœæ­£åˆ™è¡¨è¾¾å¼ä¸ä¸ºç©ºï¼ŒéªŒè¯æ­£åˆ™æ ¼å¼
            if (judge.rix) {
                try {
                    new RegExp(judge.rix);
                } catch (e) {
                    showMessage(`æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯: ${judge.rix}`, 'error');
                    throw new Error('æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯');
                }
            }
            
            judges.push(judge);
        });
        
        if (judges.length === 0) {
            showMessage('è‡³å°‘éœ€è¦é…ç½®ä¸€ä¸ªæœ‰æ•ˆçš„åˆ¤æ–­æ¡ä»¶', 'error');
            return;
        }
        
        // æ„å»ºæ­£ç¡®çš„è¯·æ±‚æ•°æ®
        const requestData = {
            name: data.name,
            description: data.description || '',
            method: data.method,
            relation: data.relation || 'and',
            judges: judges,
            enabled: data.enabled === 'on'
        };

        console.log('å‘é€çš„æ•°æ®:', requestData); // è°ƒè¯•ç”¨

        const response = await fetch('/api/custom-rules', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const result = await response.json();
            closeModal();
            showMessage('è‡ªå®šä¹‰è§„åˆ™æ·»åŠ æˆåŠŸ', 'success');
            loadCustomRules();
        } else {
            const errorText = await response.text();
            let errorMessage = 'æ·»åŠ å¤±è´¥';
            try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorText;
            } catch {
                errorMessage = errorText;
            }
            showMessage('æ·»åŠ å¤±è´¥: ' + errorMessage, 'error');
        }
    } catch (error) {
        console.error('æ·»åŠ è‡ªå®šä¹‰è§„åˆ™é”™è¯¯:', error);
        if (error.message !== 'æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯') {
            showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
        }
    }
}

// æ˜¾ç¤ºç¼–è¾‘è‡ªå®šä¹‰è§„åˆ™æ¨¡æ€æ¡†
async function showEditCustomRuleModal(ruleId) {
    try {
        const response = await fetch('/api/custom-rules', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            const rule = data.rules.find(r => r.ID === ruleId);

            if (rule) {
                document.getElementById('modal-title').textContent = 'ç¼–è¾‘è‡ªå®šä¹‰è§„åˆ™';
                document.getElementById('modal-body').innerHTML = `
                    <form id="edit-custom-rule-form">
                        <input type="hidden" name="id" value="${rule.ID}">
                        <div class="form-group">
                            <label class="form-label">è§„åˆ™åç§°</label>
                            <input type="text" name="name" class="form-control" value="${rule.Name}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">HTTPæ–¹æ³•</label>
                            <select name="method" class="form-control" required>
                                <option value="GET" ${rule.Method === 'GET' ? 'selected' : ''}>GET</option>
                                <option value="POST" ${rule.Method === 'POST' ? 'selected' : ''}>POST</option>
                                <option value="PUT" ${rule.Method === 'PUT' ? 'selected' : ''}>PUT</option>
                                <option value="DELETE" ${rule.Method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                <option value="any" ${rule.Method === 'any' ? 'selected' : ''}>ä»»æ„æ–¹æ³• (any)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">æ¡ä»¶å…³ç³»</label>
                            <select name="relation" class="form-control" required>
                                <option value="and" ${rule.Relation === 'and' ? 'selected' : ''}>AND (æ‰€æœ‰æ¡ä»¶éƒ½è¦æ»¡è¶³)</option>
                                <option value="or" ${rule.Relation === 'or' ? 'selected' : ''}>OR (ä»»æ„æ¡ä»¶æ»¡è¶³)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">è§„åˆ™æè¿°</label>
                            <textarea name="description" class="form-control">${rule.Description || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">åˆ¤æ–­æ¡ä»¶</label>
                            <div id="edit-judges-container">
                                ${rule.Judges.map((judge, index) => `
                                    <div class="judge-item" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                            <select name="position" class="form-control" required>
                                                <option value="uri" ${judge.Position === 'uri' ? 'selected' : ''}>URI</option>
                                                <option value="request_header" ${judge.Position === 'request_header' ? 'selected' : ''}>è¯·æ±‚å¤´</option>
                                                <option value="request_body" ${judge.Position === 'request_body' ? 'selected' : ''}>è¯·æ±‚ä½“</option>
                                                <option value="parameter_value" ${judge.Position === 'parameter_value' ? 'selected' : ''}>å‚æ•°å€¼</option>
                                                <option value="form_values" ${judge.Position === 'form_values' ? 'selected' : ''}>è¡¨å•å€¼</option>
                                            </select>
                                            <input type="text" name="content" class="form-control" value="${judge.Content || ''}" placeholder="åŒ¹é…å†…å®¹ (å¯é€‰)">
                                            <input type="text" name="rix" class="form-control" value="${judge.Rix || ''}" placeholder="æ­£åˆ™è¡¨è¾¾å¼ (å¯é€‰)">
                                            <select name="action" class="form-control">
                                                <option value="is" ${judge.Action === 'is' ? 'selected' : ''}>åŒ¹é… (is)</option>
                                                <option value="not" ${judge.Action === 'not' ? 'selected' : ''}>ä¸åŒ¹é… (not)</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-danger" onclick="removeJudge(this)" style="padding: 5px 10px; font-size: 12px;">åˆ é™¤æ¡ä»¶</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addEditJudge()" style="margin-top: 10px;">
                                <span>+</span> æ·»åŠ æ¡ä»¶
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: inline-flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="enabled" ${rule.Enabled ? 'checked' : ''}> å¯ç”¨è§„åˆ™
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                            <button type="submit" class="btn">æ›´æ–°è§„åˆ™</button>
                        </div>
                    </form>
                `;

                document.getElementById('edit-custom-rule-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    updateCustomRule(new FormData(this));
                });

                showModal();
            } else {
                showMessage('è§„åˆ™ä¸å­˜åœ¨', 'error');
            }
        } else {
            showMessage('åŠ è½½è§„åˆ™å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åŠ è½½è§„åˆ™é”™è¯¯:', error);
        showMessage('åŠ è½½è§„åˆ™å¤±è´¥', 'error');
    }
}

// åŒæ ·ä¿®æ”¹ç¼–è¾‘æ¨¡æ€æ¡†çš„æ·»åŠ æ¡ä»¶å‡½æ•°
function addEditJudge() {
    const container = document.getElementById('edit-judges-container');
    const judgeItem = document.createElement('div');
    judgeItem.className = 'judge-item';
    judgeItem.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;';
    
    judgeItem.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <select name="position" class="form-control" required>
                <option value="uri">URI</option>
                <option value="request_header">è¯·æ±‚å¤´</option>
                <option value="request_body">è¯·æ±‚ä½“</option>
                <option value="parameter_value">å‚æ•°å€¼</option>
                <option value="form_values">è¡¨å•å€¼</option>
            </select>
            <input type="text" name="content" class="form-control" placeholder="åŒ¹é…å†…å®¹ (ä¸æ­£åˆ™äºŒé€‰ä¸€)">
            <input type="text" name="rix" class="form-control" placeholder="æ­£åˆ™è¡¨è¾¾å¼ (ä¸å†…å®¹äºŒé€‰ä¸€)">
            <select name="action" class="form-control">
                <option value="is">åŒ¹é… (is)</option>
                <option value="not">ä¸åŒ¹é… (not)</option>
            </select>
        </div>
        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
            <strong>æç¤º:</strong> å†…å®¹å’Œæ­£åˆ™è¡¨è¾¾å¼è‡³å°‘å¡«å†™ä¸€ä¸ª
        </div>
        <button type="button" class="btn btn-danger" onclick="removeJudge(this)" style="padding: 5px 10px; font-size: 12px;">åˆ é™¤æ¡ä»¶</button>
    `;
    
    container.appendChild(judgeItem);
}


// ä¿®æ”¹æ›´æ–°è‡ªå®šä¹‰è§„åˆ™å‡½æ•°
// ä¿®æ”¹æ›´æ–°è‡ªå®šä¹‰è§„åˆ™å‡½æ•°
async function updateCustomRule(formData) {
    try {
        const data = Object.fromEntries(formData);
        
        // å¤„ç†åˆ¤æ–­æ¡ä»¶ - ç¡®ä¿å­—æ®µåç§°æ­£ç¡®
        const judges = [];
        const judgeItems = document.querySelectorAll('#edit-judges-container .judge-item');
        
        judgeItems.forEach(item => {
            const judge = {
                position: item.querySelector('select[name="position"]').value,
                content: item.querySelector('input[name="content"]').value,
                rix: item.querySelector('input[name="rix"]').value,
                action: item.querySelector('select[name="action"]').value || 'is'
            };
            
            if (!judge.content && !judge.rix) {
                return;
            }
            
            if (judge.rix) {
                try {
                    new RegExp(judge.rix);
                } catch (e) {
                    showMessage(`æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯: ${judge.rix}`, 'error');
                    throw new Error('æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯');
                }
            }
            
            judges.push(judge);
        });
        
        if (judges.length === 0) {
            showMessage('è‡³å°‘éœ€è¦é…ç½®ä¸€ä¸ªæœ‰æ•ˆçš„åˆ¤æ–­æ¡ä»¶', 'error');
            return;
        }
        
        // æ„å»ºæ­£ç¡®çš„è¯·æ±‚æ•°æ® - ä½¿ç”¨ judges è€Œä¸æ˜¯ judge
        const requestData = {
            name: data.name,
            description: data.description || '',
            method: data.method,
            relation: data.relation || 'and',
            judges: judges,  // å…³é”®ä¿®å¤ï¼šä½¿ç”¨ judges è€Œä¸æ˜¯ judge
            enabled: data.enabled === 'on'
        };

        const response = await fetch(`/api/custom-rules/${data.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            closeModal();
            showMessage('è‡ªå®šä¹‰è§„åˆ™æ›´æ–°æˆåŠŸ', 'success');
            loadCustomRules();
        } else {
            const errorText = await response.text();
            let errorMessage = 'æ›´æ–°å¤±è´¥';
            try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorText;
            } catch {
                errorMessage = errorText;
            }
            showMessage('æ›´æ–°å¤±è´¥: ' + errorMessage, 'error');
        }
    } catch (error) {
        console.error('æ›´æ–°è‡ªå®šä¹‰è§„åˆ™é”™è¯¯:', error);
        if (error.message !== 'æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯') {
            showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
        }
    }
}

// åˆ‡æ¢è‡ªå®šä¹‰è§„åˆ™çŠ¶æ€
// åˆ‡æ¢è‡ªå®šä¹‰è§„åˆ™çŠ¶æ€
async function toggleCustomRuleStatus(ruleId, enabled) {
    const action = enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
    
    if (!confirm(`ç¡®å®šè¦${action}è¿™æ¡è§„åˆ™å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch(`/api/custom-rules/${ruleId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ enabled })
        });

        if (response.ok) {
            showMessage(`è§„åˆ™${action}æˆåŠŸ`, 'success');
            loadCustomRules();
        } else {
            const error = await response.text();
            showMessage(`${action}å¤±è´¥: ${error}`, 'error');
        }
    } catch (error) {
        console.error(`${action}è§„åˆ™é”™è¯¯:`, error);
        showMessage(`${action}å¤±è´¥`, 'error');
    }
}

// åˆ é™¤è‡ªå®šä¹‰è§„åˆ™
async function deleteCustomRule(ruleId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
    
    try {
        const response = await fetch(`/api/custom-rules/${ruleId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            showMessage('è§„åˆ™åˆ é™¤æˆåŠŸ', 'success');
            loadCustomRules();
        } else {
            showMessage('åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åˆ é™¤è§„åˆ™é”™è¯¯:', error);
        showMessage('åˆ é™¤å¤±è´¥', 'error');
    }
}

// å¯¼å‡ºè§„åˆ™
function exportCustomRules() {
    window.open('/api/custom-rules/export', '_blank');
}

// æ˜¾ç¤ºå¯¼å…¥è§„åˆ™æ¨¡æ€æ¡†
function showImportRulesModal() {
    document.getElementById('modal-title').textContent = 'å¯¼å…¥è‡ªå®šä¹‰è§„åˆ™';
    document.getElementById('modal-body').innerHTML = `
        <form id="import-rules-form" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label">é€‰æ‹©è§„åˆ™æ–‡ä»¶</label>
                <input type="file" name="file" class="form-control" accept=".zip" required>
                <small style="color: #666;">è¯·é€‰æ‹©ä¹‹å‰å¯¼å‡ºçš„ZIPæ ¼å¼è§„åˆ™æ–‡ä»¶</small>
            </div>
            
            <div class="alert alert-success">
                <strong>å¯¼å…¥è¯´æ˜:</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li>ä»…æ”¯æŒZIPæ ¼å¼çš„è§„åˆ™å¤‡ä»½æ–‡ä»¶</li>
                    <li>å¯¼å…¥çš„è§„åˆ™ä¼šè¦†ç›–åŒIDçš„ç°æœ‰è§„åˆ™</li>
                    <li>å»ºè®®åœ¨å¯¼å…¥å‰å…ˆå¯¼å‡ºå½“å‰è§„åˆ™ä½œä¸ºå¤‡ä»½</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn">å¯¼å…¥è§„åˆ™</button>
            </div>
        </form>
    `;

    document.getElementById('import-rules-form').addEventListener('submit', function(e) {
        e.preventDefault();
        importCustomRules(new FormData(this));
    });

    showModal();
}

// å¯¼å…¥è§„åˆ™
async function importCustomRules(formData) {
    try {
        const response = await fetch('/api/custom-rules/import', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            closeModal();
            showMessage(`è§„åˆ™å¯¼å…¥æˆåŠŸï¼Œå…±å¯¼å…¥ ${result.imported_count} æ¡è§„åˆ™`, 'success');
            loadCustomRules();
        } else {
            const error = await response.text();
            showMessage('å¯¼å…¥å¤±è´¥: ' + error, 'error');
        }
    } catch (error) {
        console.error('å¯¼å…¥è§„åˆ™é”™è¯¯:', error);
        showMessage('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
    }
}

// é‡æ–°åŠ è½½è‡ªå®šä¹‰è§„åˆ™
async function reloadCustomRules() {
    try {
        const response = await fetch('/api/custom-rules/reload', {
            method: 'POST',
            credentials: 'include'
        });

        if (response.ok) {
            const result = await response.json();
            showMessage(`è§„åˆ™é‡æ–°åŠ è½½æˆåŠŸï¼Œå…±åŠ è½½ ${result.count} æ¡è§„åˆ™`, 'success');
            loadCustomRules();
        } else {
            showMessage('é‡æ–°åŠ è½½å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('é‡æ–°åŠ è½½è§„åˆ™é”™è¯¯:', error);
        showMessage('é‡æ–°åŠ è½½å¤±è´¥', 'error');
    }
}

            // è·å–æ‰€æœ‰è§„åˆ™ç”¨äºæ˜¾ç¤ºåç§°
async function getAllRules() {
    try {
        // è¿™é‡Œéœ€è¦è°ƒç”¨è·å–æ‰€æœ‰è§„åˆ™çš„æ¥å£
        // æš‚æ—¶è¿”å›ç©ºå¯¹è±¡ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦å®ç°è¿™ä¸ªæ¥å£
        return {};
    } catch (error) {
        console.error('è·å–è§„åˆ™åˆ—è¡¨é”™è¯¯:', error);
        return {};
    }
}

// åŠ è½½ç³»ç»Ÿç›‘æ§æ•°æ®
async function loadSystemMonitor() {
    try {
        const response = await fetch('/api/monitor/system', {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            displaySystemMonitor(data);
        } else {
            console.error('è·å–ç³»ç»Ÿç›‘æ§æ•°æ®å¤±è´¥:', response.status);
            displaySystemMonitorError();
        }
    } catch (error) {
        console.error('è·å–ç³»ç»Ÿç›‘æ§æ•°æ®é”™è¯¯:', error);
        displaySystemMonitorError();
    }
}

// æ˜¾ç¤ºç³»ç»Ÿç›‘æ§æ•°æ®
function displaySystemMonitor(data) {
    // æ˜¾ç¤ºç«¯å£ç»Ÿè®¡
    displayPortStats(data.port_stats);
    
    // æ˜¾ç¤ºCPUç»Ÿè®¡
    displayCPUStats(data.cpu_stats);
    
    // æ˜¾ç¤ºå†…å­˜ç»Ÿè®¡
    displayMemoryStats(data.memory_stats);
}

// æ˜¾ç¤ºç«¯å£ç»Ÿè®¡
function displayPortStats(portStats) {
    const container = document.getElementById('port-stats-container');
    
    container.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #5210ed; margin-bottom: 10px;">
                ${portStats.total_connections}
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                æ€»è¿æ¥æ•°
            </div>
            <div style="display: flex; justify-content: space-around; font-size: 12px;">
                <div>
                    <div style="color: #2ed573; font-size: 18px;font-weight: bold;">80ç«¯å£</div>
                    <div style="font-weight: bold; font-size: 20px;">${portStats.port_80_rate}</div>
                </div>
                <div>
                    <div style="color: #1e90ff;font-size: 18px;font-weight: bold;">443ç«¯å£</div>
                    <div style="font-weight: bold;bold; font-size: 20px;">${portStats.port_443_rate}</div>
                </div>
            </div>
        </div>
    `;
}

// æ˜¾ç¤ºCPUç»Ÿè®¡
function displayCPUStats(cpuStats) {
    const container = document.getElementById('cpu-stats-container');
    const usagePercent = parseFloat(cpuStats.usage_percent);
    
    container.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #5210ed; margin-bottom: 10px;">
                ${usagePercent.toFixed(1)}%
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                CPUä½¿ç”¨ç‡
            </div>
            <div style="font-size: 12px; color: #888;">
                è´Ÿè½½: ${cpuStats.load_average_1} | ${cpuStats.load_average_5} | ${cpuStats.load_average_15}
            </div>
            <div style="font-size: 11px; color: #888;">
                ${cpuStats.cores} æ ¸å¿ƒ
            </div>
        </div>
    `;
}

// æ˜¾ç¤ºå†…å­˜ç»Ÿè®¡
function displayMemoryStats(memoryStats) {
    const container = document.getElementById('memory-stats-container');
    const usagePercent = parseFloat(memoryStats.usage_percent);
    
    container.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #5210ed; margin-bottom: 10px;">
                ${usagePercent.toFixed(1)}%
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                å†…å­˜ä½¿ç”¨ç‡
            </div>
            <div style="font-size: 12px; color: #666;">
                å·²ç”¨: ${memoryStats.used}
            </div>
            <div style="font-size: 11px; color: #888;">
                æ€»å…±: ${memoryStats.total}
            </div>
        </div>
    `;
}

// æ˜¾ç¤ºç³»ç»Ÿç›‘æ§é”™è¯¯
function displaySystemMonitorError() {
    const errorHtml = '<div class="alert alert-error">ç³»ç»Ÿç›‘æ§æ•°æ®åŠ è½½å¤±è´¥</div>';
    
    document.getElementById('port-stats-container').innerHTML = errorHtml;
    document.getElementById('cpu-stats-container').innerHTML = errorHtml;
    document.getElementById('memory-stats-container').innerHTML = errorHtml;
}





            // è®¡ç®—å­˜æ´»ç«™ç‚¹æ•°é‡
                function calculateAliveSites() {
                        if (!window.siteHealthData) return 0;

                        let aliveCount = 0;
                        Object.values(window.siteHealthData).forEach(health => {
                            if (health.is_alive) {
                                aliveCount++;
                            }
                        });
                        return aliveCount;
                    }

                
                        


        // åŠ è½½ç»Ÿè®¡æ•°æ®
            // åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStats() {
    try {
        // å¹¶è¡ŒåŠ è½½åŸºæœ¬ç»Ÿè®¡å’Œç³»ç»Ÿç›‘æ§
        const [statsResponse, monitorResponse] = await Promise.all([
            fetch('/api/stats', { method: 'GET', credentials: 'include' }),
            fetch('/api/monitor/system', { method: 'GET', credentials: 'include' })
        ]);

        // å¤„ç†åŸºæœ¬ç»Ÿè®¡æ•°æ®
        if (statsResponse.ok) {
            const stats = await statsResponse.json();
            
            // è®¡ç®—å­˜æ´»ç«™ç‚¹æ•°é‡
            const aliveSites = calculateAliveSites();

            // æ£€æŸ¥æ•°æ®å˜åŒ–å¹¶æ·»åŠ åŠ¨ç”»
            checkAndAnimateValueChange('total-requests', stats.total_requests, previousStats.total_requests);
            checkAndAnimateValueChange('blocked-requests', stats.blocked_requests, previousStats.blocked_requests);
            checkAndAnimateValueChange('total-sites', stats.total_sites, previousStats.total_sites);
            checkAndAnimateValueChange('alive-sites', aliveSites, previousStats.alive_sites);

            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            document.getElementById('total-requests').textContent = stats.total_requests.toLocaleString();
            document.getElementById('blocked-requests').textContent = stats.blocked_requests.toLocaleString();
            document.getElementById('total-sites').textContent = stats.total_sites;
            document.getElementById('alive-sites').textContent = aliveSites;


            // ä¿å­˜å½“å‰æ•°æ®ç”¨äºä¸‹æ¬¡æ¯”è¾ƒ
            previousStats = {
                total_requests: stats.total_requests,
                blocked_requests: stats.blocked_requests,
                total_sites: stats.total_sites,
                alive_sites: aliveSites
            };
        } else {
            console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', statsResponse.status);
        }

        // å¤„ç†ç³»ç»Ÿç›‘æ§æ•°æ®
        if (monitorResponse.ok) {
            const monitorData = await monitorResponse.json();
            displaySystemMonitor(monitorData);
        } else {
            console.error('è·å–ç³»ç»Ÿç›‘æ§æ•°æ®å¤±è´¥:', monitorResponse.status);
            displaySystemMonitorError();
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

    } catch (error) {
        console.error('è·å–æ•°æ®é”™è¯¯:', error);
        displaySystemMonitorError();
    }
}
            // æ£€æŸ¥æ•°å€¼å˜åŒ–å¹¶æ·»åŠ åŠ¨ç”»
                function checkAndAnimateValueChange(elementId, newValue, oldValue) {
                        if (newValue !== oldValue) {
                            const element = document.getElementById(elementId);
                            if (element) {
                                element.classList.add('value-changing');

                                // åŠ¨ç”»ç»“æŸåç§»é™¤ç±»
                                setTimeout(() => {
                                    element.classList.remove('value-changing');
                                }, 500);
                            }
                        }
                    }

        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        function refreshStats() {
                loadStats();
                // åŒæ—¶åˆ·æ–°å¥åº·çŠ¶æ€ä»¥è·å–æœ€æ–°çš„ç«™ç‚¹å­˜æ´»æ•°æ®
                loadSiteHealthStatus();
            }

        // åŠ è½½ACLè§„åˆ™
        async function loadACLRules() {
            try {
                const response = await fetch('/api/acl/rules', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayACLRules(data.rules);
                } else {
                    document.getElementById('acl-rules-container').innerHTML = '<div class="alert alert-error">åŠ è½½ACLè§„åˆ™å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ACLè§„åˆ™é”™è¯¯:', error);
                document.getElementById('acl-rules-container').innerHTML = '<div class="alert alert-error">åŠ è½½ACLè§„åˆ™å¤±è´¥</div>';
            }
        }

        // æ˜¾ç¤ºACLè§„åˆ™
        function displayACLRules(rules) {
    const container = document.getElementById('acl-rules-container');
    
    if (!rules || rules.length === 0) {
        container.innerHTML = '<div class="alert">æš‚æ— ACLè§„åˆ™</div>';
        return;
    }
    
    // åˆ†é¡µå¤„ç†
    const pageSize = 10;
    const totalPages = Math.ceil(rules.length / pageSize);
    const currentPage = 1;
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const displayRules = rules.slice(startIndex, endIndex);
    
    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ç±»å‹</th>
                        <th>ä¸»æœº</th>
                        <th>è§„åˆ™ç±»å‹</th>
                        <th>æ¨¡å¼</th>
                        <th>åŠ¨ä½œ</th>
                        <th>æè¿°</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    displayRules.forEach(rule => {
        html += `
            <tr>
                <td>${rule.id}</td>
                <td>${rule.type}</td>
                <td>${rule.host || '-'}</td>
                <td>${rule.rule_type}</td>
                        <td title="${rule.pattern}">${rule.pattern.length > 20 ? rule.pattern.substring(0, 20) + '...' : rule.pattern}</td>
                <td>
                    <span class="status-indicator ${rule.action === 'allow' ? 'status-active' : 'status-inactive'}">
                        ${rule.action === 'allow' ? 'å…è®¸' : 'é˜»æ­¢'}
                    </span>
                </td>
                <td title="${rule.description || '-'}">${rule.description ? (rule.description.length > 15 ? rule.description.substring(0, 15) + '...' : rule.description) : '-'}</td>
                <td>
                    <span class="status-indicator ${rule.enabled ? 'status-active' : 'status-inactive'}">
                        ${rule.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-danger" onclick="deleteACLRule(${rule.id})">åˆ é™¤</button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            æ˜¾ç¤º 1-${displayRules.length} æ¡ï¼Œå…± ${rules.length} æ¡è§„åˆ™
        </div>
    `;
    
    container.innerHTML = html;
}

        // æ˜¾ç¤ºæ·»åŠ ACLè§„åˆ™æ¨¡æ€æ¡†
        function showAddACLModal() {
            document.getElementById('modal-title').textContent = 'æ·»åŠ ACLè§„åˆ™';
            document.getElementById('modal-body').innerHTML = `
                <form id="add-acl-form">
                    <div class="form-group">
                        <label class="form-label">è§„åˆ™ç±»å‹</label>
                        <select name="type" class="form-control" required>
                            <option value="global">å…¨å±€è§„åˆ™</option>
                            <option value="host">ä¸»æœºè§„åˆ™</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="host-field" style="display: none;">
                        <label class="form-label">ä¸»æœºå</label>
                        <input type="text" name="host" class="form-control" placeholder="ä¾‹å¦‚: example.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è§„åˆ™ç±»å‹</label>
                        <select name="rule_type" class="form-control" required>
                            <option value="ip">IPåœ°å€</option>
                            <option value="user_agent">User Agent</option>
                            <option value="referer">Referer</option>
                            <option value="path">è·¯å¾„</option>
                            <option value="country">å›½å®¶</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åŒ¹é…æ¨¡å¼</label>
                        <input type="text" name="pattern" class="form-control" placeholder="ä¾‹å¦‚: 192.168.1.* æˆ– ^/admin" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åŠ¨ä½œ</label>
                        <div>
                            <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                                <input type="radio" name="action" value="allow" checked> å…è®¸
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 8px;">
                                <input type="radio" name="action" value="block"> é˜»æ­¢
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æè¿°</label>
                        <textarea name="description" class="form-control" placeholder="è§„åˆ™æè¿°"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: inline-flex; align-items: center; gap: 8px;">
                            <input type="checkbox" name="enabled" checked> å¯ç”¨è§„åˆ™
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn">æ·»åŠ è§„åˆ™</button>
                    </div>
                </form>
            `;
            
            // æ˜¾ç¤º/éšè—ä¸»æœºå­—æ®µ
            document.querySelector('select[name="type"]').addEventListener('change', function() {
                document.getElementById('host-field').style.display = this.value === 'host' ? 'block' : 'none';
            });
            
            // è¡¨å•æäº¤
            document.getElementById('add-acl-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addACLRule(new FormData(this));
            });
            
            showModal();
        }

        // æ·»åŠ ACLè§„åˆ™
        async function addACLRule(formData) {
            try {
                const data = Object.fromEntries(formData);
                data.enabled = data.enabled === 'on';
                
                const response = await fetch('/api/acl/rules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    showMessage('ACLè§„åˆ™æ·»åŠ æˆåŠŸ', 'success');
                    loadACLRules();
                } else {
                    const error = await response.text();
                    showMessage('æ·»åŠ å¤±è´¥: ' + error, 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ ACLè§„åˆ™é”™è¯¯:', error);
                showMessage('æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ACLè§„åˆ™
        async function deleteACLRule(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ACLè§„åˆ™å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/acl/rules/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showMessage('ACLè§„åˆ™åˆ é™¤æˆåŠŸ', 'success');
                    loadACLRules();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ACLè§„åˆ™é”™è¯¯:', error);
                showMessage('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // åŠ è½½ç¼“å­˜ç»Ÿè®¡
        async function loadCacheStats() {
            try {
                const response = await fetch('/api/cache/stats', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const stats = await response.json();
                    displayCacheStats(stats);
                } else {
                    document.getElementById('cache-stats-container').innerHTML = '<div class="alert alert-error">åŠ è½½ç¼“å­˜ç»Ÿè®¡å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ç¼“å­˜ç»Ÿè®¡é”™è¯¯:', error);
                document.getElementById('cache-stats-container').innerHTML = '<div class="alert alert-error">åŠ è½½ç¼“å­˜ç»Ÿè®¡å¤±è´¥</div>';
            }
        }

        // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
        // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
            function displayCacheStats(stats) {
                const container = document.getElementById('cache-stats-container');

                container.innerHTML = `
        <div class="metric-row">
            <div class="metric-card">
                <div class="metric-icon">ğŸ“Š</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.cache_hits}</div>
                    <div class="metric-label">ç¼“å­˜å‘½ä¸­</div>
                </div>
            </div>
            
            <div class="metric-card clickable" onclick="loadCacheFiles()" style="cursor: pointer;">
                <div class="metric-icon">ğŸ“</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.cached_files}</div>
                    <div class="metric-label">ç¼“å­˜æ–‡ä»¶æ•°</div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">ğŸ”’</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.enable ? 'å¯ç”¨' : 'ç¦ç”¨'}</div>
                    <div class="metric-label">ç¼“å­˜çŠ¶æ€</div>
                </div>
            </div>
        </div>
        
        <div class="metric-row">
            <div class="metric-card small">
                <div class="metric-content">
                    <div class="metric-value">${stats.current_size}</div>
                    <div class="metric-label">ç¼“å­˜å¤§å°</div>
                </div>
            </div>
        </div>
    `;
            }

        // åŠ è½½ç¼“å­˜é…ç½®
        async function loadCacheConfig() {
            try {
                const response = await fetch('/api/cache/stats', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const stats = await response.json();
                    displayCacheConfig(stats);
                } else {
                    document.getElementById('cache-config-container').innerHTML = '<div class="alert alert-error">åŠ è½½ç¼“å­˜é…ç½®å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ç¼“å­˜é…ç½®é”™è¯¯:', error);
                document.getElementById('cache-config-container').innerHTML = '<div class="alert alert-error">åŠ è½½ç¼“å­˜é…ç½®å¤±è´¥</div>';
            }
        }

        // æ˜¾ç¤ºç¼“å­˜é…ç½®
        // ä¿®æ”¹æ˜¾ç¤ºç¼“å­˜é…ç½®å‡½æ•°
            function displayCacheConfig(stats) {
                const container = document.getElementById('cache-config-container');

                // ä¿®å¤ï¼šæ­£ç¡®è§£ææœ€å¤§ç¼“å­˜å¤§å°
                const maxSizeMB = stats.max_size ? parseInt(stats.max_size) : 100;

                container.innerHTML = `
        <form id="cache-config-form">
            <div class="form-group">
                <label class="form-label">å¯ç”¨ç¼“å­˜</label>
                <div>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="enable" value="true" ${stats.enable ? 'checked' : ''}> å¯ç”¨
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="radio" name="enable" value="false" ${!stats.enable ? 'checked' : ''}> ç¦ç”¨
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">æœ€å¤§ç¼“å­˜å¤§å° (MB)</label>
                <input type="number" name="max_size_mb" class="form-control" value="${maxSizeMB}">
            </div>
            
            <button type="submit" class="btn">ä¿å­˜é…ç½®</button>
        </form>
    `;

                document.getElementById('cache-config-form').addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateCacheConfig(new FormData(this));
                });
            }

        // æ›´æ–°ç¼“å­˜é…ç½®
        async function updateCacheConfig(formData) {
            try {
                const data = Object.fromEntries(formData);
                data.enable = data.enable === 'true';
                data.max_size_mb = parseInt(data.max_size_mb);
                
                const response = await fetch('/api/cache/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showMessage('ç¼“å­˜é…ç½®æ›´æ–°æˆåŠŸ', 'success');
                    loadCacheStats();
                    loadCacheConfig();
                } else {
                    showMessage('æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°ç¼“å­˜é…ç½®é”™è¯¯:', error);
                showMessage('æ›´æ–°å¤±è´¥', 'error');
            }
        }

        // æ¸…ç©ºç¼“å­˜
        async function clearCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/api/cache/clear', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    showMessage('ç¼“å­˜å·²æ¸…ç©º', 'success');
                    loadCacheStats();
                } else {
                    showMessage('æ¸…ç©ºç¼“å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¸…ç©ºç¼“å­˜é”™è¯¯:', error);
                showMessage('æ¸…ç©ºç¼“å­˜å¤±è´¥', 'error');
            }
        }

        // åˆ·æ–°ç¼“å­˜ç»Ÿè®¡
        function refreshCacheStats() {
            loadCacheStats();
            loadCacheConfig();
            loadCacheFiles(1); // åŒæ—¶åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        }

        // åˆ‡æ¢ç«™ç‚¹çŠ¶æ€
async function toggleSiteStatus(siteId, newStatus) {
    const action = newStatus === 1 ? 'å¯ç”¨' : 'ç¦ç”¨';
    
    if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªç«™ç‚¹å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch('/api/site/status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ 
                id: parseInt(siteId), 
                status: parseInt(newStatus)
            })
        });

        if (response.ok) {
            showMessage(`ç«™ç‚¹${action}æˆåŠŸ`, 'success');
            loadSites();
        } else {
            const error = await response.text();
            showMessage(`${action}å¤±è´¥: ${error}`, 'error');
        }
    } catch (error) {
        console.error(`${action}ç«™ç‚¹é”™è¯¯:`, error);
        showMessage(`${action}å¤±è´¥`, 'error');
    }
}

        // åŠ è½½ç«™ç‚¹åˆ—è¡¨
        async function loadSites() {
            try {
                const response = await fetch('/api/sites', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySites(data.sites);
                } else {
                    document.getElementById('sites-container').innerHTML = '<div class="alert alert-error">åŠ è½½ç«™ç‚¹åˆ—è¡¨å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ç«™ç‚¹åˆ—è¡¨é”™è¯¯:', error);
                document.getElementById('sites-container').innerHTML = '<div class="alert alert-error">åŠ è½½ç«™ç‚¹åˆ—è¡¨å¤±è´¥</div>';
            }
        }

        // æ˜¾ç¤ºç«™ç‚¹åˆ—è¡¨
    // ä¿®æ”¹displaySiteså‡½æ•°ï¼Œæ˜¾ç¤ºè¯ä¹¦ä¿¡æ¯
    function displaySites(sites) {
    const container = document.getElementById('sites-container');

    if (!sites || sites.length === 0) {
        container.innerHTML = '<div class="alert">æš‚æ— ç«™ç‚¹</div>';
        return;
    }

    // åˆ†é¡µå¤„ç†
    const pageSize = 10;
    const totalPages = Math.ceil(sites.length / pageSize);
    const currentPage = 1;
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const displaySites = sites.slice(startIndex, endIndex);

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åç§°</th>
                        <th>åŸŸå</th>
                        <th>ç›®æ ‡URL/è´Ÿè½½å‡è¡¡</th>
                        <th>HTTPS</th>
                        <th>è¯ä¹¦çŠ¶æ€</th>
                        <th>ç«™ç‚¹çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;

    displaySites.forEach(site => {
        // è·å–ç«™ç‚¹å¥åº·çŠ¶æ€
        const isTargetAlive = window.siteHealthData && window.siteHealthData[site.id] ? window.siteHealthData[site.id].is_alive : false;
        const rowClass = isTargetAlive ? 'row-alive' : 'row-dead';

        // è¯ä¹¦çŠ¶æ€
        let certStatus = '';
        if (site.enable_https) {
            if (site.cert_id) {
                certStatus = '<span class="status-indicator status-active" title="å·²é…ç½®è¯ä¹¦">âœ… å·²é…ç½®</span>';
            } else {
                certStatus = '<span class="status-indicator status-inactive" title="æœªé…ç½®è¯ä¹¦">âŒ æ— è¯ä¹¦</span>';
            }
        } else {
            certStatus = '<span class="status-indicator">-</span>';
        }
        
        // è´Ÿè½½å‡è¡¡ä¿¡æ¯ - æ˜¾ç¤ºä¸Šæ¸¸æœåŠ¡å™¨åˆ—è¡¨
        let targetInfo = '';
        let upstreamDetails = '';
        
        if (site.load_balance_algorithm) {
            const algoText = site.load_balance_algorithm === 'round_robin' ? 'è½®è¯¢' : 'æƒé‡';
            const serverCount = site.upstream_servers ? site.upstream_servers.length : 0;
            
            // è·å–ä¸Šæ¸¸æœåŠ¡å™¨å¥åº·çŠ¶æ€
            const upstreamHealth = window.siteHealthData && window.siteHealthData[site.id] && window.siteHealthData[site.id].upstream_server_health ? 
                                   window.siteHealthData[site.id].upstream_server_health : [];
            
            // æ£€æŸ¥æ˜¯å¦å·²å±•å¼€
            const isExpanded = expandedUpstreamSites.has(site.id);
            const arrowIcon = isExpanded ? 'â–²' : 'â–¼';
            
            targetInfo = `<span class="clickable" onclick="toggleUpstreamDetails(${site.id})" style="cursor: pointer;">âš–ï¸ ${algoText} (${serverCount}) ${arrowIcon}</span>`;
            
            // æ„å»ºå¯æŠ˜å çš„ä¸Šæ¸¸æœåŠ¡å™¨è¯¦æƒ…
            if (serverCount > 0) {
                let upstreamList = '';
                if (upstreamHealth.length > 0) {
                    // æœ‰å¥åº·çŠ¶æ€æ•°æ®ï¼Œæ˜¾ç¤ºå¥åº·çŠ¶æ€
                    upstreamList = upstreamHealth.map(us => {
                        const statusClass = us.is_alive ? 'status-active' : 'status-inactive';
                        const statusText = us.is_alive ? 'æ­£å¸¸' : 'å¼‚å¸¸';
                        const latency = us.latency ? `${us.latency}ms` : 'N/A';
                        const weightDisplay = site.load_balance_algorithm === 'weighted' ? `(${us.weight})` : '';
                        return `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            ${us.url} ${weightDisplay}
                                        </div>
                                        <span class="status-indicator ${statusClass}" title="å»¶è¿Ÿ: ${latency}">
                                            ${statusText} (${latency})
                                        </span>
                                    </div>
                                </div>`;
                    }).join('');
                } else {
                    // æ²¡æœ‰å¥åº·çŠ¶æ€æ•°æ®ï¼Œä»…æ˜¾ç¤ºä¸Šæ¸¸æœåŠ¡å™¨URL
                    upstreamList = site.upstream_servers.map(us => {
                        const weightDisplay = site.load_balance_algorithm === 'weighted' ? `(${us.weight})` : '';
                        return `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            ${us.url} ${weightDisplay}
                                        </div>
                                        <span class="status-indicator">åŠ è½½ä¸­...</span>
                                    </div>
                                </div>`;
                    }).join('');
                }
                
                // æ ¹æ®å±•å¼€çŠ¶æ€è®¾ç½®åˆå§‹æ˜¾ç¤º
                const initialDisplay = isExpanded ? 'table-row' : 'none';
                
                upstreamDetails = `
                    <tr id="upstream-details-${site.id}" style="display: ${initialDisplay};">
                        <td colspan="8">
                            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 10px 0;">
                                <strong>ä¸Šæ¸¸æœåŠ¡å™¨è¯¦æƒ…:</strong>
                                <div style="margin-top: 10px;">
                                    ${upstreamList}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        } else {
            // æ™®é€šç«™ç‚¹æ˜¾ç¤ºå¥åº·çŠ¶æ€
            const health = window.siteHealthData && window.siteHealthData[site.id] ? window.siteHealthData[site.id] : null;
            if (health) {
                const statusClass = health.is_alive ? 'status-active' : 'status-inactive';
                const statusText = health.is_alive ? 'æ­£å¸¸' : 'å¼‚å¸¸';
                const latency = health.latency ? `${health.latency}ms` : 'N/A';
                targetInfo = `
                    <span title="${site.target_url}">${site.target_url.length > 20 ? site.target_url.substring(0, 20) + '...' : site.target_url}</span>
                    <span class="status-indicator ${statusClass}" title="å»¶è¿Ÿ: ${latency}" style="margin-left: 8px;">
                        ${statusText} (${latency})
                    </span>
                `;
            } else {
                targetInfo = `<span title="${site.target_url}">${site.target_url.length > 20 ? site.target_url.substring(0, 20) + '...' : site.target_url}</span>`;
            }
        }

        html += `
            <tr class="${rowClass}">
                <td>${site.id}</td>
                <td title="${site.name}">${site.name.length > 15 ? site.name.substring(0, 15) + '...' : site.name}</td>
                <td title="${site.domain}">${site.domain.length > 15 ? site.domain.substring(0, 15) + '...' : site.domain}</td>
                <td>${targetInfo}</td>
                <td>
                    <span class="status-indicator ${site.enable_https ? 'status-active' : 'status-inactive'} clickable" 
                          onclick="toggleSiteHTTPS(${site.id}, ${!site.enable_https})"
                          title="ç‚¹å‡»åˆ‡æ¢HTTPSçŠ¶æ€">
                        ${site.enable_https ? 'å¯ç”¨' : 'ç¦ç”¨'}
                    </span>
                </td>
                <td>${certStatus}</td>
                <td>
                    <span class="status-indicator ${site.status === 1 ? 'status-active' : 'status-inactive'} clickable" 
                          onclick="toggleSiteStatus(${site.id}, ${site.status === 1 ? 0 : 1})"
                          title="ç‚¹å‡»åˆ‡æ¢ç«™ç‚¹çŠ¶æ€">
                        ${site.status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨'}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn" onclick="showEditSiteModal(${site.id})" title="ç¼–è¾‘">âœï¸</button>
                        ${site.enable_https ? `
                            <button class="btn" onclick="manageSiteCertificate(${site.id}, '${site.domain}')" title="ç®¡ç†è¯ä¹¦">ğŸ“œ</button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="deleteSite(${site.id})">åˆ é™¤</button>
                    </div>
                </td>
            </tr>
            ${upstreamDetails}
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            æ˜¾ç¤º 1-${displaySites.length} æ¡ï¼Œå…± ${sites.length} ä¸ªç«™ç‚¹
        </div>
    `;

    container.innerHTML = html;
    
    // æ¢å¤å±•å¼€çš„ä¸Šæ¸¸æœåŠ¡å™¨è¯¦æƒ…
    setTimeout(() => {
        restoreExpandedUpstreamDetails();
    }, 0);
}

// åˆ·æ–°æ‰€æœ‰ç»Ÿè®¡æ•°æ®
function refreshAllStats() {
    loadStats();
    loadSiteHealthStatus();
}
    // ç®¡ç†ç«™ç‚¹è¯ä¹¦
        function manageSiteCertificate(siteId, domain) {
            document.getElementById('modal-title').textContent = `ç®¡ç†è¯ä¹¦ - ${domain}`;
            document.getElementById('modal-body').innerHTML = `
        <div style="margin-bottom: 20px;">
            <h4>å½“å‰è¯ä¹¦ä¿¡æ¯</h4>
            <div id="current-cert-info">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="renew">æ›´æ–°è¯ä¹¦</div>
            <div class="tab" data-tab="replace">æ›¿æ¢è¯ä¹¦</div>
        </div>
        
        <div id="renew-tab" class="tab-content active">
            <form id="renew-cert-form">
                <div class="form-group">
                    <label class="form-label">æ–°çš„æœ‰æ•ˆæœŸ (å¤©)</label>
                    <input type="number" name="valid_days" class="form-control" value="365" min="1" max="3650">
                </div>
                <button type="submit" class="btn">é‡æ–°ç”Ÿæˆè¯ä¹¦</button>
            </form>
        </div>
        
        <div id="replace-tab" class="tab-content">
            <form id="replace-cert-form">
                <div class="form-group">
                    <label class="form-label">æ–°çš„è¯ä¹¦å†…å®¹ (PEMæ ¼å¼)</label>
                    <textarea name="cert_text" class="form-control" rows="6" placeholder="-----BEGIN CERTIFICATE----- ..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ–°çš„ç§é’¥å†…å®¹ (PEMæ ¼å¼)</label>
                    <textarea name="key_text" class="form-control" rows="6" placeholder="-----BEGIN PRIVATE KEY----- ..." required></textarea>
                </div>
                <button type="submit" class="btn">æ›¿æ¢è¯ä¹¦</button>
            </form>
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
            <button class="btn btn-danger" onclick="removeSiteCertificate(${siteId})">
                <span>ğŸ—‘ï¸</span> ç§»é™¤è¯ä¹¦ï¼ˆç¦ç”¨HTTPSï¼‰
            </button>
        </div>
    `;

            // åŠ è½½å½“å‰è¯ä¹¦ä¿¡æ¯
            loadCurrentCertificateInfo(siteId);

            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');

                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });

            // è¡¨å•æäº¤
            document.getElementById('renew-cert-form').addEventListener('submit', function (e) {
                e.preventDefault();
                renewSiteCertificate(siteId, new FormData(this));
            });

            document.getElementById('replace-cert-form').addEventListener('submit', function (e) {
                e.preventDefault();
                replaceSiteCertificate(siteId, new FormData(this));
            });

            showModal();
        }



        // åŠ è½½å½“å‰è¯ä¹¦ä¿¡æ¯
        async function loadCurrentCertificateInfo(siteId) {
                try {
                    const response = await fetch(`/api/site/${siteId}/certificate`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        displayCurrentCertificateInfo(data.certificate);
                    } else {
                        document.getElementById('current-cert-info').innerHTML =
                            '<div class="alert alert-error">åŠ è½½è¯ä¹¦ä¿¡æ¯å¤±è´¥</div>';
                    }
                } catch (error) {
                    console.error('åŠ è½½è¯ä¹¦ä¿¡æ¯é”™è¯¯:', error);
                    document.getElementById('current-cert-info').innerHTML =
                        '<div class="alert alert-error">åŠ è½½è¯ä¹¦ä¿¡æ¯å¤±è´¥</div>';
                }
            }

       // æ˜¾ç¤ºå½“å‰è¯ä¹¦ä¿¡æ¯
        function displayCurrentCertificateInfo(certInfo) {
            const container = document.getElementById('current-cert-info');

            if (!certInfo || !certInfo.exists) {
                container.innerHTML = '<div class="alert">è¯¥ç«™ç‚¹æœªé…ç½®è¯ä¹¦</div>';
                return;
            }

            let html = `
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold; width: 120px;">åŸŸå</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${certInfo.domain}</td>
            </tr>
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">æœ‰æ•ˆæœŸ</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${certInfo.valid_from} è‡³ ${certInfo.valid_to}</td>
            </tr>
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ç­¾å‘è€…</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${certInfo.issuer}</td>
            </tr>
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">è¯ä¹¦ç±»å‹</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${certInfo.is_self_signed ? 'è‡ªç­¾åè¯ä¹¦' : 'CAç­¾å‘è¯ä¹¦'}</td>
            </tr>
        </table>
    `;

            container.innerHTML = html;
        }

        // é‡æ–°ç”Ÿæˆè¯ä¹¦
            async function renewSiteCertificate(siteId, formData) {
                try {
                    const data = Object.fromEntries(formData);
                    data.valid_days = parseInt(data.valid_days) || 365;

                    const response = await fetch(`/api/site/${siteId}/renew-certificate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        showMessage('è¯ä¹¦é‡æ–°ç”ŸæˆæˆåŠŸ', 'success');
                        loadCurrentCertificateInfo(siteId);
                    } else {
                        const error = await response.text();
                        showMessage('é‡æ–°ç”Ÿæˆå¤±è´¥: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('é‡æ–°ç”Ÿæˆè¯ä¹¦é”™è¯¯:', error);
                    showMessage('é‡æ–°ç”Ÿæˆå¤±è´¥', 'error');
                }
            }

        // æ›¿æ¢è¯ä¹¦
        async function replaceSiteCertificate(siteId, formData) {
                try {
                    const data = Object.fromEntries(formData);

                    const response = await fetch(`/api/site/${siteId}/replace-certificate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        showMessage('è¯ä¹¦æ›¿æ¢æˆåŠŸ', 'success');
                        loadCurrentCertificateInfo(siteId);
                    } else {
                        const error = await response.text();
                        showMessage('æ›¿æ¢å¤±è´¥: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('æ›¿æ¢è¯ä¹¦é”™è¯¯:', error);
                    showMessage('æ›¿æ¢å¤±è´¥', 'error');
                }
            }
            

        // ç§»é™¤è¯ä¹¦ï¼ˆç¦ç”¨HTTPSï¼‰
        // ç§»é™¤è¯ä¹¦ï¼ˆç¦ç”¨HTTPSï¼‰
            async function removeSiteCertificate(siteId) {
                if (!confirm('ç¡®å®šè¦ç§»é™¤è¯ä¹¦å¹¶ç¦ç”¨HTTPSå—ï¼Ÿ')) return;

                try {
                    const response = await fetch(`/api/site/${siteId}/remove-certificate`, {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        closeModal();
                        showMessage('è¯ä¹¦å·²ç§»é™¤ï¼ŒHTTPSå·²ç¦ç”¨', 'success');
                        loadSites();
                    } else {
                        const error = await response.text();
                        showMessage('ç§»é™¤å¤±è´¥: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('ç§»é™¤è¯ä¹¦é”™è¯¯:', error);
                    showMessage('ç§»é™¤å¤±è´¥', 'error');
                }
            }

// åŠ è½½ç«™ç‚¹å¥åº·çŠ¶æ€
async function loadSiteHealthStatus() {
    try {
        console.log('å¼€å§‹åŠ è½½å¥åº·çŠ¶æ€...');
        const response = await fetch('/api/health', {
            method: 'GET',
            credentials: 'include'
        });

        console.log('å¥åº·çŠ¶æ€å“åº”:', response.status, response.statusText);
        
        if (response.ok) {
            const data = await response.json();
            console.log('å¥åº·çŠ¶æ€æ•°æ®:', data);
            window.siteHealthData = data.health_status; // ä¿å­˜åˆ°å…¨å±€å˜é‡
            updateHealthStatusDisplay();
        } else {
            const errorText = await response.text();
            console.error('å¥åº·çŠ¶æ€è¯·æ±‚å¤±è´¥:', response.status, errorText);
        }
        
        // æ— è®ºæˆåŠŸå¤±è´¥éƒ½è®¾ç½®å®šæ—¶å™¨ç»§ç»­å°è¯•
        setTimeout(loadSiteHealthStatus, 3000); // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡
    } catch (error) {
        console.error('åŠ è½½å¥åº·çŠ¶æ€é”™è¯¯:', error);
        // å‡ºé”™æ—¶ä¹Ÿè®¾ç½®å®šæ—¶å™¨ï¼Œç¡®ä¿ç»§ç»­å°è¯•
        setTimeout(loadSiteHealthStatus, 30000);
    }
}

// è·å–ç«™ç‚¹å¥åº·çŠ¶æ€HTML
function getSiteHealthStatus(siteId) {
    if (!window.siteHealthData || !window.siteHealthData[siteId]) {
        return '<span class="status-indicator">æœªçŸ¥</span>';
    }
    
    const health = window.siteHealthData[siteId];
    const statusClass = health.is_alive ? 'status-active' : 'status-inactive';
    const statusText = health.is_alive ? 'æ­£å¸¸' : 'å¼‚å¸¸';
    const latency = health.latency ? `${health.latency}ms` : 'N/A';
    
    return `
        <span class="status-indicator ${statusClass}" title="å»¶è¿Ÿ: ${latency}">
            ${statusText} (${latency})
        </span>
    `;
}

    // åŠ è½½ç¼“å­˜æ–‡ä»¶åˆ—è¡¨
    // åŠ è½½ç¼“å­˜æ–‡ä»¶åˆ—è¡¨
    // åŠ è½½ç¼“å­˜æ–‡ä»¶åˆ—è¡¨
    async function loadCacheFiles(page = 1) {
        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const container = document.getElementById('cache-files-container');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            const params = new URLSearchParams({
                page: page,
                page_size: 10 // æ¯é¡µæ˜¾ç¤º10æ¡
            });

            const response = await fetch(`/api/cache/files?${params}`, {
                method: 'GET',
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                displayCacheFiles(data);
            } else {
                container.innerHTML = '<div class="alert alert-error">åŠ è½½ç¼“å­˜æ–‡ä»¶åˆ—è¡¨å¤±è´¥</div>';
            }
        } catch (error) {
            console.error('åŠ è½½ç¼“å­˜æ–‡ä»¶åˆ—è¡¨é”™è¯¯:', error);
            document.getElementById('cache-files-container').innerHTML = '<div class="alert alert-error">åŠ è½½ç¼“å­˜æ–‡ä»¶åˆ—è¡¨å¤±è´¥</div>';
        }
    }

    // æ˜¾ç¤ºç¼“å­˜æ–‡ä»¶åˆ—è¡¨
    function displayCCAttackLogs(data) {
    const container = document.getElementById('cc-logs-container');
    currentCCLogsTotal = data.total;

    if (!data.logs || data.logs.length === 0) {
        container.innerHTML = '<div class="alert">æš‚æ— CCæ”»å‡»æ—¥å¿—</div>';
        document.getElementById('cc-logs-pagination').innerHTML = '';
        return;
    }

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>å®¢æˆ·ç«¯IP</th>
                        <th>åŸŸå</th>
                        <th>è·¯å¾„</th>
                        <th>è§„åˆ™åç§°</th>
                        <th>è¯·æ±‚æ¬¡æ•°</th>
                        <th>æ‰§è¡ŒåŠ¨ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;

    data.logs.forEach(log => {
        html += `
            <tr>
                <td>${log.created_at}</td>
                <td>${log.client_ip}</td>
                <td title="${log.domain}">${log.domain.length > 15 ? log.domain.substring(0, 15) + '...' : log.domain}</td>
                <td title="${log.path || 'å…¨éƒ¨'}">${log.path ? (log.path.length > 15 ? log.path.substring(0, 15) + '...' : log.path) : 'å…¨éƒ¨'}</td>
                <td title="${log.rule_name}">${log.rule_name.length > 15 ? log.rule_name.substring(0, 15) + '...' : log.rule_name}</td>
                <td>${log.count}</td>
                <td>
                    <span class="status-indicator ${log.action === 'block' ? 'status-inactive' : 'status-active'}">
                        ${log.action === 'block' ? 'æ‹¦æˆª' : 'æŒ‘æˆ˜'}
                    </span>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;

    // æ˜¾ç¤ºåˆ†é¡µ
    displayCCPagination(data.total, data.page_size, data.page);
}

// æ˜¾ç¤ºç¼“å­˜æ–‡ä»¶åˆ—è¡¨
function displayCacheFiles(data) {
    const container = document.getElementById('cache-files-container');

    if (!data.files || data.files.length === 0) {
        container.innerHTML = '<div class="alert">æš‚æ— ç¼“å­˜æ–‡ä»¶</div>';
        document.getElementById('cache-files-pagination').innerHTML = '';
        return;
    }

    const files = data.files;
    const currentPage = data.page || 1;
    const pageSize = data.page_size || 10;
    const total = data.total || files.length;

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ç¼“å­˜é”®</th>
                        <th>ç±»å‹</th>
                        <th>å¤§å°</th>
                        <th>æœ€åä¿®æ”¹</th>
                        <th>è¿‡æœŸæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;

    files.forEach(file => {
        // ç®€åŒ–æ˜¾ç¤ºç¼“å­˜é”®
        const displayKey = file.key.length > 25 ? file.key.substring(0, 25) + '...' : file.key;
        const displayType = file.content_type ? (file.content_type.length > 15 ? file.content_type.substring(0, 15) + '...' : file.content_type) : 'æœªçŸ¥';

        html += `
            <tr>
                <td title="${file.key}">${displayKey}</td>
                <td title="${file.content_type || 'æœªçŸ¥'}">${displayType}</td>
                <td>${file.size || 0}</td>
                <td>${file.last_modified || 'æœªçŸ¥'}</td>
                <td>${file.expire_at || 'æ°¸ä¸è¿‡æœŸ'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn" onclick="viewCacheFileContent('${file.key}')">æŸ¥çœ‹å†…å®¹</button>
                        <button class="btn btn-danger" onclick="deleteCacheFile('${file.key}')">åˆ é™¤</button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            æ˜¾ç¤º ${((currentPage - 1) * pageSize) + 1}-${Math.min(currentPage * pageSize, total)} ä¸ªï¼Œå…± ${total} ä¸ªç¼“å­˜æ–‡ä»¶
        </div>
    `;

    container.innerHTML = html;

    // æ˜¾ç¤ºåˆ†é¡µ
    displayCacheFilesPagination(total, pageSize, currentPage);
}

// æ˜¾ç¤ºç¼“å­˜æ–‡ä»¶åˆ†é¡µ
    // æ˜¾ç¤ºç¼“å­˜æ–‡ä»¶åˆ†é¡µ
    function displayCacheFilesPagination(total, pageSize, currentPage) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById('cache-files-pagination');

        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = '';

        // ä¸Šä¸€é¡µ
        if (currentPage > 1) {
            html += `<button class="page-btn" onclick="loadCacheFiles(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
        }

        // é¡µç 
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                html += `<button class="page-btn active">${i}</button>`;
            } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<button class="page-btn" onclick="loadCacheFiles(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<span class="page-btn">...</span>`;
            }
        }

        // ä¸‹ä¸€é¡µ
        if (currentPage < totalPages) {
            html += `<button class="page-btn" onclick="loadCacheFiles(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
        }

        pagination.innerHTML = html;
    }
// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// åˆ é™¤ç¼“å­˜æ–‡ä»¶
async function deleteCacheFile(cacheKey) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¼“å­˜æ–‡ä»¶ "${cacheKey}" å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch(`/api/cache/files/delete`, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json', // æ·»åŠ JSONå¤´
            },
            body: JSON.stringify({ // æ·»åŠ è¯·æ±‚ä½“
                file: cacheKey
            })
            
        });

        if (response.ok) {
            showMessage('ç¼“å­˜æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
            loadCacheFiles(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
        } else {
            const error = await response.text();
            showMessage('åˆ é™¤å¤±è´¥: ' + error, 'error');
        }
    } catch (error) {
        console.error('åˆ é™¤ç¼“å­˜æ–‡ä»¶é”™è¯¯:', error);
        showMessage('åˆ é™¤å¤±è´¥', 'error');
    }
}


    // æŸ¥çœ‹ç¼“å­˜æ–‡ä»¶å†…å®¹
    async function viewCacheFileContent(cacheKey) {
            try {
                const response = await fetch(`/api/cache/files`, {
                    method: 'POST',  // æ”¹ä¸ºPOST
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json', // æ·»åŠ JSONå¤´
                    },
                    body: JSON.stringify({ // æ·»åŠ è¯·æ±‚ä½“
                        file: cacheKey
                    })
                });

                if (response.ok) {
                    const fileContent = await response.json();
                    showCacheFileContentModal(fileContent);
                } else {
                    showMessage('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è·å–æ–‡ä»¶å†…å®¹é”™è¯¯:', error);
                showMessage('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥', 'error');
            }
        }

    // æ˜¾ç¤ºç¼“å­˜æ–‡ä»¶å†…å®¹æ¨¡æ€æ¡†
    function showCacheFileContentModal(fileContent) {
        document.getElementById('modal-title').textContent = `ç¼“å­˜æ–‡ä»¶å†…å®¹ - ${fileContent.key}`;

        // æ ¹æ®å†…å®¹ç±»å‹ç¡®å®šè¯­è¨€
        function getLanguageFromContentType(contentType) {
            if (contentType.includes('json')) return 'json';
            if (contentType.includes('javascript')) return 'javascript';
            if (contentType.includes('css')) return 'css';
            if (contentType.includes('html')) return 'html';
            if (contentType.includes('xml')) return 'xml';
            if (contentType.includes('yaml')) return 'yaml';
            if (contentType.includes('sql')) return 'sql';
            if (contentType.includes('python')) return 'python';
            if (contentType.includes('php')) return 'php';
            if (contentType.includes('java')) return 'java';
            if (contentType.includes('c++') || contentType.includes('cpp')) return 'cpp';
            if (contentType.includes('shell') || contentType.includes('bash')) return 'bash';
            return 'markup'; // é»˜è®¤è¯­è¨€
        }

        let contentDisplay = '';
        if (fileContent.content_type.startsWith('text/') ||
            fileContent.content_type.includes('json') ||
            fileContent.content_type.includes('javascript') ||
            fileContent.content_type.includes('css') ||
            fileContent.content_type.includes('html') ||
            fileContent.content_type.includes('xml') ||
            fileContent.content_type.includes('yaml')) {
            
            const language = getLanguageFromContentType(fileContent.content_type);
            
            // å¯¹äºæ–‡æœ¬å†…å®¹ï¼Œä½¿ç”¨ä»£ç é«˜äº®æ˜¾ç¤º
            contentDisplay = `
                <div style="position: relative;">
                    <button type="button" class="btn" onclick="copyFileContent()" 
                            style="position: absolute; top: 10px; right: 10px; z-index: 10; padding: 5px 10px; font-size: 12px;">
                        ğŸ“‹ å¤åˆ¶å†…å®¹
                    </button>
                    <pre class="code-container language-${language}"><code class="language-${language}">${escapeHtml(fileContent.content)}</code></pre>
                </div>
            `;
        } else {
            // å¯¹äºäºŒè¿›åˆ¶å†…å®¹ï¼Œæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
            contentDisplay = `
            <div class="alert">
                <p>æ–‡ä»¶ç±»å‹: ${fileContent.content_type}</p>
                <p>æ–‡ä»¶å¤§å°: ${fileContent.size}</p>
                <p>æ­¤ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— æ³•ç›´æ¥æ˜¾ç¤ºå†…å®¹ã€‚</p>
            </div>
        `;
        }

        document.getElementById('modal-body').innerHTML = `
        <div>
            <div style="margin-bottom: 15px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold; width: 100px;">ç¼“å­˜é”®</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; word-break: break-all;">${fileContent.key}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">å†…å®¹ç±»å‹</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${fileContent.content_type}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">æ–‡ä»¶å¤§å°</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${fileContent.size}</td>
                    </tr>
                </table>
            </div>
            
            <h4 style="margin-bottom: 10px; color: #5210ed;">æ–‡ä»¶å†…å®¹</h4>
            ${contentDisplay}
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
        </div>
    `;

        showModal();
        
        // è§¦å‘ä»£ç é«˜äº®
        setTimeout(() => {
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        }, 100);
    }

    // æ›¿æ¢ copyFileContent å‡½æ•°
        function copyFileContent() {
            const contentElement = document.querySelector('#modal-body pre code');
            if (contentElement) {
                const content = contentElement.textContent;
                copyToClipboard(content, 'æ–‡ä»¶å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }
        }


// æ›´æ–°å¥åº·çŠ¶æ€æ˜¾ç¤º
function updateHealthStatusDisplay() {
    if (currentPage === 'sites' && window.siteHealthData) {
        // é‡æ–°æ˜¾ç¤ºç«™ç‚¹åˆ—è¡¨ä»¥æ›´æ–°å¥åº·çŠ¶æ€
        loadSites();
    }
}

// åˆ‡æ¢ä¸Šæ¸¸æœåŠ¡å™¨è¯¦æƒ…æ˜¾ç¤º
function toggleUpstreamDetails(siteId) {
    const detailsRow = document.getElementById(`upstream-details-${siteId}`);
    const trigger = window.event ? window.event.target : (event ? event.target : null);
    
    if (detailsRow) {
        if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
            // å±•å¼€
            detailsRow.style.display = 'table-row';
            expandedUpstreamSites.add(siteId);
            if (trigger) {
                trigger.innerHTML = trigger.innerHTML.replace('â–¼', 'â–²');
            }
        } else {
            // å…³é—­
            detailsRow.style.display = 'none';
            expandedUpstreamSites.delete(siteId);
            if (trigger) {
                trigger.innerHTML = trigger.innerHTML.replace('â–²', 'â–¼');
            }
        }
    }
}

// æ¢å¤å±•å¼€çš„ä¸Šæ¸¸æœåŠ¡å™¨è¯¦æƒ…
function restoreExpandedUpstreamDetails() {
    expandedUpstreamSites.forEach(siteId => {
        const detailsRow = document.getElementById(`upstream-details-${siteId}`);
        const triggerSpan = document.querySelector(`span[onclick="toggleUpstreamDetails(${siteId})"]`);
        
        if (detailsRow) {
            detailsRow.style.display = 'table-row';
        }
        if (triggerSpan) {
            triggerSpan.innerHTML = triggerSpan.innerHTML.replace('â–¼', 'â–²');
        }
    });
}

// æ£€æŸ¥å•ä¸ªç«™ç‚¹å¥åº·çŠ¶æ€
async function checkSingleSiteHealth(siteId) {
    try {
        const response = await fetch(`/api/health/${siteId}`, {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            showMessage(`å¥åº·æ£€æŸ¥å®Œæˆ: ${data.health.is_alive ? 'æ­£å¸¸' : 'å¼‚å¸¸'} (${data.health.latency}ms)`, 'success');
            // åˆ·æ–°å¥åº·çŠ¶æ€æ˜¾ç¤º
            loadSiteHealthStatus();
        } else {
            showMessage('å¥åº·æ£€æŸ¥å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('å¥åº·æ£€æŸ¥é”™è¯¯:', error);
        showMessage('å¥åº·æ£€æŸ¥å¤±è´¥', 'error');
    }
}
       // ä¿®æ”¹showAddSiteModalå‡½æ•°
        function showAddSiteModal() {
            document.getElementById('modal-title').textContent = 'æ·»åŠ ç«™ç‚¹';
            document.getElementById('modal-body').innerHTML = `
        <form id="add-site-form">
            <div class="form-group">
                <label class="form-label">ç«™ç‚¹åç§°</label>
                <input type="text" name="name" class="form-control" placeholder="ä¾‹å¦‚: æˆ‘çš„ç½‘ç«™" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">åŸŸå</label>
                <input type="text" name="domain" class="form-control" placeholder="ä¾‹å¦‚: example.com" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">è´Ÿè½½å‡è¡¡ç®—æ³•</label>
                <div>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="load_balance_algorithm" value="" checked> ä¸ä½¿ç”¨è´Ÿè½½å‡è¡¡
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="load_balance_algorithm" value="round_robin"> è½®è¯¢ç®—æ³•
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="radio" name="load_balance_algorithm" value="weighted"> æƒé‡ç®—æ³•
                    </label>
                </div>
            </div>
            
            <div class="form-group" id="target-url-group">
                <label class="form-label">ç›®æ ‡URL</label>
                <input type="text" name="target_url" class="form-control" placeholder="ä¾‹å¦‚: http://127.0.0.1:8080">
                <small style="color: #666;">æœªå¯ç”¨è´Ÿè½½å‡è¡¡æ—¶å¿…å¡«</small>
            </div>
            
            <div class="form-group" id="upstream-servers-group" style="display: none;">
                <label class="form-label">ä¸Šæ¸¸æœåŠ¡å™¨åˆ—è¡¨</label>
                <div id="upstream-servers-list"></div>
                <button type="button" class="btn" style="margin-top: 10px;" onclick="addUpstreamServer()">+ æ·»åŠ ä¸Šæ¸¸æœåŠ¡å™¨</button>
                <small style="color: #666; display: block; margin-top: 5px;">å¯ç”¨è´Ÿè½½å‡è¡¡æ—¶ï¼Œå¿…é¡»è‡³å°‘é…ç½®ä¸€ä¸ªä¸Šæ¸¸æœåŠ¡å™¨</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">å¯ç”¨HTTPS</label>
                <div>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="enable_https" value="true"> å¯ç”¨
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="radio" name="enable_https" value="false" checked> ç¦ç”¨
                    </label>
                </div>
            </div>
            
            <div class="form-group" id="https-options" style="display: none;">
                <div class="tabs" id="cert-tabs">
                    <div class="tab active" data-tab="auto">è‡ªåŠ¨ç”Ÿæˆè¯ä¹¦</div>
                    <div class="tab" data-tab="upload">ä¸Šä¼ è¯ä¹¦</div>
                </div>
                
                <div id="auto-cert-tab" class="tab-content active">
                    <div class="form-group">
                        <label class="form-label">è¯ä¹¦æœ‰æ•ˆæœŸ (å¤©)</label>
                        <input type="number" name="valid_days" class="form-control" value="365" min="1" max="3650">
                        <small style="color: #666;">é»˜è®¤365å¤©ï¼Œæœ€é•¿10å¹´</small>
                    </div>
                </div>
                
                <div id="upload-cert-tab" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">è¯ä¹¦å†…å®¹ (PEMæ ¼å¼)</label>
                        <textarea name="cert_text" class="form-control" rows="6" placeholder="-----BEGIN CERTIFICATE----- ..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç§é’¥å†…å®¹ (PEMæ ¼å¼)</label>
                        <textarea name="key_text" class="form-control" rows="6" placeholder="-----BEGIN PRIVATE KEY----- ..."></textarea>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn">æ·»åŠ ç«™ç‚¹</button>
            </div>
        </form>
    `;

            // æ˜¾ç¤º/éšè—è´Ÿè½½å‡è¡¡ç›¸å…³é€‰é¡¹
            document.querySelectorAll('input[name="load_balance_algorithm"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const useLB = this.value !== '';
                    document.getElementById('target-url-group').style.display = useLB ? 'none' : 'block';
                    document.getElementById('upstream-servers-group').style.display = useLB ? 'block' : 'none';
                    const targetUrlInput = document.querySelector('input[name="target_url"]');
                    if (useLB) {
                        targetUrlInput.removeAttribute('required');
                        // æ›´æ–°ç°æœ‰æœåŠ¡å™¨çš„æƒé‡æ˜¾ç¤º
                        updateUpstreamServerWeights();
                        if (document.getElementById('upstream-servers-list').children.length === 0) {
                            addUpstreamServer();
                        }
                    } else {
                        targetUrlInput.setAttribute('required', 'required');
                    }
                });
            });

            // æ˜¾ç¤º/éšè—HTTPSé€‰é¡¹
            document.querySelectorAll('input[name="enable_https"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    document.getElementById('https-options').style.display = this.value === 'true' ? 'block' : 'none';
                });
            });
            
            // æ›´æ–°å·²æœ‰æœåŠ¡å™¨çš„æƒé‡æ˜¾ç¤º
            function updateUpstreamServerWeights() {
                const list = document.getElementById('upstream-servers-list');
                const selectedAlgo = document.querySelector('input[name="load_balance_algorithm"]:checked').value;
                const isWeighted = selectedAlgo === 'weighted';
                
                list.querySelectorAll('.upstream-server-item').forEach(item => {
                    const weightInput = item.querySelector('input[type="number"]');
                    if (weightInput) {
                        weightInput.style.display = isWeighted ? 'block' : 'none';
                        weightInput.required = isWeighted;
                    }
                });
            }
            
            // æ·»åŠ ä¸Šæ¸¸æœåŠ¡å™¨å‡½æ•°
            window.addUpstreamServer = function() {
                const list = document.getElementById('upstream-servers-list');
                const index = list.children.length;
                const selectedAlgo = document.querySelector('input[name="load_balance_algorithm"]:checked').value;
                const isWeighted = selectedAlgo === 'weighted';
                
                const div = document.createElement('div');
                div.className = 'upstream-server-item';
                div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                div.innerHTML = `
                    <input type="text" name="upstream_url_${index}" class="form-control" placeholder="ä¾‹å¦‚: http://127.0.0.1:8080" style="flex: ${isWeighted ? '2' : '1'};" required>
                    <input type="number" name="upstream_weight_${index}" class="form-control" placeholder="æƒé‡" value="1" min="1" style="flex: 1; display: ${isWeighted ? 'block' : 'none'};" ${isWeighted ? 'required' : ''}>
                    <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
                `;
                list.appendChild(div);
            };

            // è¯ä¹¦æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('#cert-tabs .tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');

                    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                    document.querySelectorAll('#cert-tabs .tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                    document.querySelectorAll('#https-options .tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabName}-cert-tab`).classList.add('active');
                });
            });

            // è¡¨å•æäº¤
            document.getElementById('add-site-form').addEventListener('submit', function (e) {
                e.preventDefault();
                addSiteWithCertificate(new FormData(this));
            });

            showModal();
        }
        // ä¿®æ”¹æ·»åŠ ç«™ç‚¹å‡½æ•°ï¼Œæ”¯æŒè¯ä¹¦å’Œè´Ÿè½½å‡è¡¡
            async function addSiteWithCertificate(formData) {
                try {
                    const data = Object.fromEntries(formData);
                    data.enable_https = data.enable_https === 'true';
                    
                    // å¤„ç†ä¸Šæ¸¸æœåŠ¡å™¨
                    if (data.load_balance_algorithm && data.load_balance_algorithm !== '') {
                        data.upstream_servers = [];
                        let index = 0;
                        while (true) {
                            const urlKey = `upstream_url_${index}`;
                            const weightKey = `upstream_weight_${index}`;
                            if (data[urlKey]) {
                                data.upstream_servers.push({
                                    url: data[urlKey],
                                    weight: parseInt(data[weightKey]) || 1
                                });
                                delete data[urlKey];
                                delete data[weightKey];
                                index++;
                            } else {
                                break;
                            }
                        }
                    }

                    const response = await fetch('/api/site/add-with-cert', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        closeModal();
                        showMessage('ç«™ç‚¹æ·»åŠ æˆåŠŸ', 'success');
                        loadSites();
                    } else {
                        const error = await response.text();
                        showMessage('æ·»åŠ å¤±è´¥: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('æ·»åŠ ç«™ç‚¹é”™è¯¯:', error);
                    showMessage('æ·»åŠ å¤±è´¥', 'error');
                }
            }

        // æ·»åŠ ç«™ç‚¹
        async function addSite(formData) {
            try {
                const data = Object.fromEntries(formData);
                data.enable_https = data.enable_https === 'true';
                
                const response = await fetch('/api/site/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    showMessage('ç«™ç‚¹æ·»åŠ æˆåŠŸ', 'success');
                    loadSites();
                } else {
                    const error = await response.text();
                    showMessage('æ·»åŠ å¤±è´¥: ' + error, 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ ç«™ç‚¹é”™è¯¯:', error);
                showMessage('æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // ç¼–è¾‘ç«™ç‚¹æ¨¡æ€æ¡†
        async function showEditSiteModal(siteId) {
            try {
                const response = await fetch('/api/sites', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    showMessage('åŠ è½½ç«™ç‚¹ä¿¡æ¯å¤±è´¥', 'error');
                    return;
                }

                const data = await response.json();
                const site = data.sites.find(s => s.id === siteId);
                
                if (!site) {
                    showMessage('ç«™ç‚¹ä¸å­˜åœ¨', 'error');
                    return;
                }

                document.getElementById('modal-title').textContent = 'ç¼–è¾‘ç«™ç‚¹';
                document.getElementById('modal-body').innerHTML = `
        <form id="edit-site-form">
            <input type="hidden" name="id" value="${site.id}">
            <div class="form-group">
                <label class="form-label">ç«™ç‚¹åç§°</label>
                <input type="text" name="name" class="form-control" placeholder="ä¾‹å¦‚: æˆ‘çš„ç½‘ç«™" value="${escapeHtml(site.name)}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">åŸŸå</label>
                <input type="text" name="domain" class="form-control" placeholder="ä¾‹å¦‚: example.com" value="${escapeHtml(site.domain)}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">è´Ÿè½½å‡è¡¡ç®—æ³•</label>
                <div>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="load_balance_algorithm" value="" ${!site.load_balance_algorithm ? 'checked' : ''}> ä¸ä½¿ç”¨è´Ÿè½½å‡è¡¡
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-right: 20px;">
                        <input type="radio" name="load_balance_algorithm" value="round_robin" ${site.load_balance_algorithm === 'round_robin' ? 'checked' : ''}> è½®è¯¢ç®—æ³•
                    </label>
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="radio" name="load_balance_algorithm" value="weighted" ${site.load_balance_algorithm === 'weighted' ? 'checked' : ''}> æƒé‡ç®—æ³•
                    </label>
                </div>
            </div>
            
            <div class="form-group" id="target-url-group">
                <label class="form-label">ç›®æ ‡URL</label>
                <input type="text" name="target_url" class="form-control" placeholder="ä¾‹å¦‚: http://127.0.0.1:8080" value="${escapeHtml(site.target_url)}">
                <small style="color: #666;">æœªå¯ç”¨è´Ÿè½½å‡è¡¡æ—¶å¿…å¡«</small>
            </div>
            
            <div class="form-group" id="upstream-servers-group" style="display: ${site.load_balance_algorithm ? 'block' : 'none'};">
                <label class="form-label">ä¸Šæ¸¸æœåŠ¡å™¨åˆ—è¡¨</label>
                <div id="upstream-servers-list"></div>
                <button type="button" class="btn" style="margin-top: 10px;" onclick="addUpstreamServerEdit()">+ æ·»åŠ ä¸Šæ¸¸æœåŠ¡å™¨</button>
                <small style="color: #666; display: block; margin-top: 5px;">å¯ç”¨è´Ÿè½½å‡è¡¡æ—¶ï¼Œå¿…é¡»è‡³å°‘é…ç½®ä¸€ä¸ªä¸Šæ¸¸æœåŠ¡å™¨</small>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn">æ›´æ–°ç«™ç‚¹</button>
            </div>
        </form>
    `;

                // åŠ è½½ç°æœ‰ä¸Šæ¸¸æœåŠ¡å™¨
                if (site.load_balance_algorithm && site.upstream_servers && site.upstream_servers.length > 0) {
                    const list = document.getElementById('upstream-servers-list');
                    site.upstream_servers.forEach((us, index) => {
                        const div = document.createElement('div');
                        div.className = 'upstream-server-item';
                        div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                        const isWeighted = site.load_balance_algorithm === 'weighted';
                        div.innerHTML = `
                            <input type="text" name="upstream_url_${index}" class="form-control" placeholder="ä¾‹å¦‚: http://127.0.0.1:8080" style="flex: ${isWeighted ? '2' : '1'};" value="${escapeHtml(us.url)}" required>
                            <input type="number" name="upstream_weight_${index}" class="form-control" placeholder="æƒé‡" value="${us.weight}" min="1" style="flex: 1; display: ${isWeighted ? 'block' : 'none'};" ${isWeighted ? 'required' : ''}>
                            <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
                        `;
                        list.appendChild(div);
                    });
                }

                // æ˜¾ç¤º/éšè—è´Ÿè½½å‡è¡¡ç›¸å…³é€‰é¡¹
                document.querySelectorAll('input[name="load_balance_algorithm"]').forEach(radio => {
                    radio.addEventListener('change', function () {
                        const useLB = this.value !== '';
                        document.getElementById('target-url-group').style.display = useLB ? 'none' : 'block';
                        document.getElementById('upstream-servers-group').style.display = useLB ? 'block' : 'none';
                        const targetUrlInput = document.querySelector('input[name="target_url"]');
                        if (useLB) {
                            targetUrlInput.removeAttribute('required');
                            updateUpstreamServerWeightsEdit();
                            if (document.getElementById('upstream-servers-list').children.length === 0) {
                                addUpstreamServerEdit();
                            }
                        } else {
                            targetUrlInput.setAttribute('required', 'required');
                        }
                    });
                });

                // æ›´æ–°å·²æœ‰æœåŠ¡å™¨çš„æƒé‡æ˜¾ç¤º
                function updateUpstreamServerWeightsEdit() {
                    const list = document.getElementById('upstream-servers-list');
                    const selectedAlgo = document.querySelector('input[name="load_balance_algorithm"]:checked').value;
                    const isWeighted = selectedAlgo === 'weighted';
                    
                    list.querySelectorAll('.upstream-server-item').forEach(item => {
                        const weightInput = item.querySelector('input[type="number"]');
                        if (weightInput) {
                            weightInput.style.display = isWeighted ? 'block' : 'none';
                            weightInput.required = isWeighted;
                        }
                    });
                }
                
                // æ·»åŠ ä¸Šæ¸¸æœåŠ¡å™¨å‡½æ•°
                window.addUpstreamServerEdit = function() {
                    const list = document.getElementById('upstream-servers-list');
                    const index = list.children.length;
                    const selectedAlgo = document.querySelector('input[name="load_balance_algorithm"]:checked').value;
                    const isWeighted = selectedAlgo === 'weighted';
                    
                    const div = document.createElement('div');
                    div.className = 'upstream-server-item';
                    div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                    div.innerHTML = `
                        <input type="text" name="upstream_url_${index}" class="form-control" placeholder="ä¾‹å¦‚: http://127.0.0.1:8080" style="flex: ${isWeighted ? '2' : '1'};" required>
                        <input type="number" name="upstream_weight_${index}" class="form-control" placeholder="æƒé‡" value="1" min="1" style="flex: 1; display: ${isWeighted ? 'block' : 'none'};" ${isWeighted ? 'required' : ''}>
                        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
                    `;
                    list.appendChild(div);
                };

                // è¡¨å•æäº¤
                document.getElementById('edit-site-form').addEventListener('submit', function (e) {
                    e.preventDefault();
                    updateSite(new FormData(this));
                });

                showModal();
            } catch (error) {
                console.error('åŠ è½½ç«™ç‚¹é”™è¯¯:', error);
                showMessage('åŠ è½½ç«™ç‚¹ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°ç«™ç‚¹å‡½æ•°
        async function updateSite(formData) {
            try {
                const data = Object.fromEntries(formData);
                
                // å¤„ç†ä¸Šæ¸¸æœåŠ¡å™¨
                if (data.load_balance_algorithm && data.load_balance_algorithm !== '') {
                    data.upstream_servers = [];
                    let index = 0;
                    while (true) {
                        const urlKey = `upstream_url_${index}`;
                        const weightKey = `upstream_weight_${index}`;
                        if (data[urlKey]) {
                            data.upstream_servers.push({
                                url: data[urlKey],
                                weight: parseInt(data[weightKey]) || 1
                            });
                            delete data[urlKey];
                            delete data[weightKey];
                            index++;
                        } else {
                            break;
                        }
                    }
                }

                const response = await fetch('/api/site/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    showMessage('ç«™ç‚¹æ›´æ–°æˆåŠŸ', 'success');
                    loadSites();
                } else {
                    const error = await response.text();
                    showMessage('æ›´æ–°å¤±è´¥: ' + error, 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°ç«™ç‚¹é”™è¯¯:', error);
                showMessage('æ›´æ–°å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ç«™ç‚¹
        async function deleteSite(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç«™ç‚¹å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/api/site/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ id })
                });

                if (response.ok) {
                    showMessage('ç«™ç‚¹åˆ é™¤æˆåŠŸ', 'success');
                    loadSites();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ç«™ç‚¹é”™è¯¯:', error);
                showMessage('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // åŠ è½½æ”»å‡»æ—¥å¿—
        async function loadAttackLogs(page) {
            try {
                currentLogsPage = page;
                
                const params = new URLSearchParams({
                    page: page,
                    page_size: currentLogsPageSize
                });
                
                // æ·»åŠ ç­›é€‰æ¡ä»¶
                const methodFilter = document.getElementById('log-method-filter');
                const ruleFilter = document.getElementById('log-rule-filter');
                const startDate = document.getElementById('log-start-date');
                const endDate = document.getElementById('log-end-date');
                
                if (methodFilter && methodFilter.value) params.append('method', methodFilter.value);
                if (ruleFilter && ruleFilter.value) params.append('rule_name', ruleFilter.value);
                if (startDate && startDate.value) params.append('start_time', startDate.value);
                if (endDate && endDate.value) params.append('end_time', endDate.value);
                
                const response = await fetch(`/api/attack/logs?${params}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayAttackLogs(data);
                } else {
                    document.getElementById('logs-container').innerHTML = '<div class="alert alert-error">åŠ è½½æ”»å‡»æ—¥å¿—å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½æ”»å‡»æ—¥å¿—é”™è¯¯:', error);
                document.getElementById('logs-container').innerHTML = '<div class="alert alert-error">åŠ è½½æ”»å‡»æ—¥å¿—å¤±è´¥</div>';
            }
        }

        // æ˜¾ç¤ºæ”»å‡»æ—¥å¿—
function displayAttackLogs(data) {
    const container = document.getElementById('logs-container');
    currentLogsTotal = data.total;
    
    if (!data.logs || data.logs.length === 0) {
        container.innerHTML = '<div class="alert">æš‚æ— æ”»å‡»æ—¥å¿—</div>';
        document.getElementById('logs-pagination').innerHTML = '';
        return;
    }
    
    // è·å–æ–¹æ³•æ ‡ç­¾çš„CSSç±»
    
    
    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>æ–¹æ³•</th>
                        <th>è§„åˆ™åç§°</th>
                        <th>è§„åˆ™ID</th>
                        <th>åŒ¹é…å†…å®¹</th>
                        <th>URL</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.logs.forEach(log => {
        
        html += `
            <tr>
                <td>${log.created_at}</td>
                <td>${log.method}</td>
                <td title="${log.rule_name}">${log.rule_name.length > 15 ? log.rule_name.substring(0, 15) + '...' : log.rule_name}</td>
                <td>${log.rule_id}</td>
                <td title="${log.matched_value}">${log.matched_value.length > 20 ? log.matched_value.substring(0, 20) + '...' : log.matched_value}</td>
                <td title="${log.url}">${log.url.length > 20 ? log.url.substring(0, 20) + '...' : log.url}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn" onclick="showLogDetail(${log.id})">è¯¦æƒ…</button>
                        <button class="btn btn-secondary" onclick="disableRule('${log.rule_id}', '${log.rule_name}')">ç¦ç”¨è§„åˆ™</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
    
    // æ˜¾ç¤ºåˆ†é¡µ
    displayPagination(data.total, data.page_size, data.page);
}

// ç¦ç”¨è§„åˆ™
async function disableRule(ruleId, ruleName) {
    if (!confirm(`ç¡®å®šè¦ç¦ç”¨è§„åˆ™ "${ruleName}" (ID: ${ruleId}) å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch('/api/rules/status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                rule_id: ruleId,
                enable: false
            })
        });

        if (response.ok) {
            showMessage(`è§„åˆ™ "${ruleName}" å·²ç¦ç”¨`, 'success');
            // åˆ·æ–°è¢«ç¦ç”¨çš„è§„åˆ™åˆ—è¡¨
            loadBlockedRules();
        } else {
            const error = await response.text();
            showMessage('ç¦ç”¨å¤±è´¥: ' + error, 'error');
        }
    } catch (error) {
        console.error('ç¦ç”¨è§„åˆ™é”™è¯¯:', error);
        showMessage('ç¦ç”¨å¤±è´¥', 'error');
    }
}


        // æ˜¾ç¤ºåˆ†é¡µ
        function displayPagination(total, pageSize, currentPage) {
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('logs-pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // ä¸Šä¸€é¡µ
            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="loadAttackLogs(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç 
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    html += `<button class="page-btn active">${i}</button>`;
                } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="page-btn" onclick="loadAttackLogs(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span class="page-btn">...</span>`;
                }
            }
            
            // ä¸‹ä¸€é¡µ
            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="loadAttackLogs(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            }
            
            pagination.innerHTML = html;
        }

        // æ˜¾ç¤ºæ—¥å¿—è¯¦æƒ…
        async function showLogDetail(logId) {
            try {
                const response = await fetch(`/api/attack/log/${logId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('è·å–æ—¥å¿—è¯¦æƒ…å¤±è´¥');
                }
                
                const log = await response.json();
                displayLogDetailModal(log);
            } catch (error) {
                console.error('è·å–æ—¥å¿—è¯¦æƒ…é”™è¯¯:', error);
                showMessage('è·å–æ—¥å¿—è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            // æ„å»ºå¯¼å‡ºURL
            const params = new URLSearchParams();
            
            const methodFilter = document.getElementById('log-method-filter');
            const ruleFilter = document.getElementById('log-rule-filter');
            const startDate = document.getElementById('log-start-date');
            const endDate = document.getElementById('log-end-date');
            
            if (methodFilter && methodFilter.value) params.append('method', methodFilter.value);
            if (ruleFilter && ruleFilter.value) params.append('rule_name', ruleFilter.value);
            if (startDate && startDate.value) params.append('start_time', startDate.value);
            if (endDate && endDate.value) params.append('end_time', endDate.value);
            
            window.open(`/api/attack/export?${params}`, '_blank');
        }

        // æ˜¾ç¤ºåˆ é™¤æ—¥å¿—æ¨¡æ€æ¡†
        function showDeleteLogsModal() {
            document.getElementById('modal-title').textContent = 'åˆ é™¤æ”»å‡»æ—¥å¿—';
            document.getElementById('modal-body').innerHTML = `
                <form id="delete-logs-form">
                    <div class="form-group">
                        <label class="form-label">åˆ é™¤æ–¹å¼</label>
                        <div>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="radio" name="delete_type" value="all" checked> åˆ é™¤æ‰€æœ‰æ—¥å¿—
                            </label>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="radio" name="delete_type" value="before"> åˆ é™¤æŒ‡å®šæ—¶é—´ä¹‹å‰çš„æ—¥å¿—
                                <input type="date" name="before_date" class="form-control" style="margin-top: 5px;">
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-danger">åˆ é™¤</button>
                    </div>
                </form>
            `;
            
            document.getElementById('delete-logs-form').addEventListener('submit', function(e) {
                e.preventDefault();
                deleteLogs(new FormData(this));
            });
            
            showModal();
        }

        // åˆ‡æ¢ç«™ç‚¹HTTPSçŠ¶æ€
async function toggleSiteHTTPS(siteId, enableHTTPS) {
    const action = enableHTTPS ? 'å¯ç”¨' : 'ç¦ç”¨';
    
    if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªç«™ç‚¹çš„HTTPSå—ï¼Ÿ`)) return;
    
    try {
        const requestData = {
            id: siteId,
            enable_https: enableHTTPS
        };
        
        // å¯ç”¨HTTPSæ—¶ä¸å†éœ€è¦æ‰‹åŠ¨è¾“å…¥è¯ä¹¦IDï¼Œåç«¯ä¼šè‡ªåŠ¨å¤„ç†
        // å¦‚æœç«™ç‚¹å·²æœ‰è¯ä¹¦ä¼šä½¿ç”¨ç°æœ‰è¯ä¹¦ï¼Œå¦‚æœæ²¡æœ‰åˆ™è‡ªåŠ¨ç”Ÿæˆ
        
        const response = await fetch('/api/site/https', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            showMessage(`ç«™ç‚¹HTTPS${action}æˆåŠŸ`, 'success');
            loadSites();
        } else {
            const error = await response.text();
            showMessage(`${action}HTTPSå¤±è´¥: ${error}`, 'error');
        }
    } catch (error) {
        console.error(`${action}ç«™ç‚¹HTTPSé”™è¯¯:`, error);
        showMessage(`${action}HTTPSå¤±è´¥`, 'error');
    }
}

// ä¿®æ”¹ displayLogDetailModal å‡½æ•°ï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æ˜¯å­—ç¬¦ä¸²
function displayLogDetailModal(log) {
    document.getElementById('modal-title').textContent = `æ”»å‡»æ—¥å¿—è¯¦æƒ… - ID: ${log.id}`;
    
    // æ ¼å¼åŒ–æ—¶é—´
    const formattedTime = new Date(log.created_at).toLocaleString();
    
    // æ„å»ºæ ¼å¼åŒ–çš„HTTPè¯·æ±‚
    function formatHTTPRequest(log) {
        let request = '';
        
        // è¯·æ±‚è¡Œ
        const method = String(log.method || 'GET');
        const url = String(log.url || '/');
        const httpVersion = 'HTTP/1.1';
        
        request += `${method} ${url} ${httpVersion}\n`;
        
        // è§£æè¯·æ±‚å¤´
        if (log.headers && String(log.headers).trim()) {
            const headers = String(log.headers).split('\n');
            headers.forEach(header => {
                if (header.trim()) {
                    const trimmedHeader = header.trim();
                    if (trimmedHeader.includes(':')) {
                        const [name, ...valueParts] = trimmedHeader.split(':');
                        const value = valueParts.join(':').trim();
                        
                        const prettyName = name.toLowerCase()
                            .split('-')
                            .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                            .join('-');
                        
                        request += `${prettyName}: ${value}\n`;
                    } else {
                        request += `${trimmedHeader}\n`;
                    }
                }
            });
        } else {
            request += 'Host: unknown\n';
        }
        
        request += '\n';
        
        // è¯·æ±‚ä½“
        if (log.body && String(log.body).trim()) {
            request += String(log.body);
        }
        
        return request;
    }
    
    const formattedRequest = formatHTTPRequest(log);
    
    // æ„å»ºè¯¦æƒ…å†…å®¹
    document.getElementById('modal-body').innerHTML = `
        <div style="max-height: 70vh; overflow-y: auto;">
            <div class="card" style="margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px; color: #5210ed;">åŸºæœ¬ä¿¡æ¯</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold; width: 120px;">æ—¶é—´</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${formattedTime}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">è¯·æ±‚æ–¹æ³•</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <span class="status-indicator ${log.method === 'GET' ? 'status-active' : 'status-inactive'}">
                                ${String(log.method || 'Unknown')}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">è§„åˆ™åç§°</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${String(log.rule_name || 'Unknown')}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">è§„åˆ™ID</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${String(log.rule_id || 'Unknown')}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">åŒ¹é…å†…å®¹</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <code style="background: #f4f4f4; padding: 2px 4px; border-radius: 3px; word-break: break-all;">
                                ${escapeHtml(log.matched_value)}
                            </code>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">å®¢æˆ·ç«¯IP</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${String(log.client_ip || 'Unknown')}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">ç”¨æˆ·ä»£ç†</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <code style="background: #f4f4f4; padding: 2px 4px; border-radius: 3px; word-break: break-all;">
                                ${escapeHtml(log.user_agent)}
                            </code>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <h4 style="margin-bottom: 10px; color: #5210ed;">HTTPè¯·æ±‚è¯¦æƒ…</h4>
                <div style="position: relative;">
                    <button type="button" class="btn" onclick="copyFormattedRequest()" 
                            style="position: absolute; top: 10px; right: 10px; z-index: 10; padding: 5px 10px; font-size: 12px;">
                        ğŸ“‹ å¤åˆ¶è¯·æ±‚
                    </button>
                    <pre id="formatted-request" class="code-container language-http" style="margin-top: 10px;"><code class="language-http">${escapeHtml(formattedRequest)}</code></pre>
                </div>
                
                ${log.url_decoded && String(log.url_decoded) !== String(log.url) ? `
                <div style="margin-top: 15px;">
                    <h5 style="color: #5210ed; margin-bottom: 8px;">è§£ç åURL:</h5>
                    <pre class="code-container language-url"><code class="language-url">${escapeHtml(log.url_decoded)}</code></pre>
                </div>
                ` : ''}
                
                ${log.headers_decoded && String(log.headers_decoded) !== String(log.headers) ? `
                <div style="margin-top: 15px;">
                    <h5 style="color: #5210ed; margin-bottom: 8px;">è§£ç åè¯·æ±‚å¤´:</h5>
                    <pre class="code-container language-http"><code class="language-http">${escapeHtml(log.headers_decoded)}</code></pre>
                </div>
                ` : ''}
                
                ${log.body_decoded && String(log.body_decoded) !== String(log.body) ? `
                <div style="margin-top: 15px;">
                    <h5 style="color: #5210ed; margin-bottom: 8px;">è§£ç åè¯·æ±‚ä½“:</h5>
                    <pre class="code-container language-json"><code class="language-json">${escapeHtml(log.body_decoded)}</code></pre>
                </div>
                ` : ''}
            </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
            <button type="button" class="btn" onclick="copyLogDetails()">å¤åˆ¶å…¨éƒ¨è¯¦æƒ…</button>
        </div>
    `;
    
    showModal();
}


// HTMLè½¬ä¹‰å‡½æ•°
// ä¿®æ”¹ escapeHtml å‡½æ•°ï¼Œæ·»åŠ ç±»å‹æ£€æŸ¥
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    
    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
    if (typeof unsafe === 'object') {
        try {
            unsafe = JSON.stringify(unsafe, null, 2);
        } catch (e) {
            unsafe = String(unsafe);
        }
    }
    
    // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
    unsafe = String(unsafe);
    
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}


    // æ›¿æ¢ copyFormattedRequest å‡½æ•°
    function copyFormattedRequest() {
        const formattedRequest = document.getElementById('formatted-request').textContent;

        copyToClipboard(formattedRequest, 'HTTPè¯·æ±‚å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }



// HTMLè½¬ä¹‰å‡½æ•°
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

    // æ›¿æ¢ copyLogDetails å‡½æ•°
    function copyLogDetails() {
        const modalBody = document.getElementById('modal-body');
        const text = modalBody.innerText;

        copyToClipboard(text, 'æ—¥å¿—è¯¦æƒ…å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }

    // é€šç”¨çš„å¤åˆ¶åˆ°å‰ªè´´æ¿å‡½æ•°
    function copyToClipboard(text, successMessage) {
        // æ–¹æ³•1: ä½¿ç”¨ç°ä»£ Clipboard API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('å¤åˆ¶æˆåŠŸ', 'success');
            }).catch(err => {
                // å¦‚æœ Clipboard API å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyToClipboard(text, successMessage);
            });
        } else {
            // ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
            fallbackCopyToClipboard(text, successMessage);
        }
    }
    // ä¼ ç»Ÿçš„å¤åˆ¶åˆ°å‰ªè´´æ¿æ–¹æ³•
    function fallbackCopyToClipboard(text, successMessage) {
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ textarea å…ƒç´ 
        const textArea = document.createElement('textarea');
        textArea.value = text;

        // é¿å…å±å¹•é—ªçƒ
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);

        // é€‰æ‹©å’Œå¤åˆ¶
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showMessage('å¤åˆ¶æˆåŠŸ', 'success');
            } else {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
            }
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');

            // å¦‚æœè¿ä¼ ç»Ÿæ–¹æ³•éƒ½å¤±è´¥ï¼Œè‡ªåŠ¨é€‰æ‹©æ–‡æœ¬è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
            textArea.style.position = 'static';
            textArea.style.left = 'auto';
            textArea.style.top = 'auto';
            textArea.focus();
            textArea.select();
        } finally {
            // æ¸…ç†
            document.body.removeChild(textArea);
        }
    }

// æ˜¾ç¤ºæ—¥å¿—è¯¦æƒ…
async function showLogDetail(logId) {
    try {
        const response = await fetch(`/api/attack/logs/${logId}`, {
            method: 'GET',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            if (data.log) {
                displayLogDetailModal(data.log);
            } else {
                showMessage('æ—¥å¿—æ•°æ®æ ¼å¼é”™è¯¯', 'error');
            }
        } else {
            showMessage('è·å–æ—¥å¿—è¯¦æƒ…å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('è·å–æ—¥å¿—è¯¦æƒ…é”™è¯¯:', error);
        showMessage('è·å–æ—¥å¿—è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
    }
}

        // åˆ é™¤æ—¥å¿—
        async function deleteLogs(formData) {
            try {
                const data = Object.fromEntries(formData);
                let requestData = {};
                
                if (data.delete_type === 'all') {
                    requestData.all = true;
                } else if (data.delete_type === 'before' && data.before_date) {
                    requestData.before = data.before_date;
                } else {
                    showMessage('è¯·é€‰æ‹©åˆ é™¤æ¡ä»¶', 'error');
                    return;
                }
                
                const response = await fetch('/api/attack/logs', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    closeModal();
                    showMessage('æ”»å‡»æ—¥å¿—åˆ é™¤æˆåŠŸ', 'success');
                    loadAttackLogs(1);
                } else {
                    const error = await response.text();
                    showMessage('åˆ é™¤å¤±è´¥: ' + error, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ—¥å¿—é”™è¯¯:', error);
                showMessage('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // åŠ è½½è®¾ç½®
            // åŠ è½½è®¾ç½®
                async function loadSettings() {
                    try {
                        const response = await fetch('/api/settings', {
                            method: 'GET',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const settings = data.settings;

                            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                            document.querySelector(`input[name="anti-devtools"][value="${settings.enable_anti_devtools}"]`).checked = true;

                            // æ–°å¢ï¼šJSæ··æ·†è®¾ç½®
                            document.querySelector(`input[name="js-obfuscation"][value="${settings.enable_js_obfuscation}"]`).checked = true;

                            document.getElementById('rule-match-rate').value = settings.rule_match_rate;
                            document.getElementById('rule-match-rate-value').textContent = settings.rule_match_rate + '%';
                            document.getElementById('base64-depth').value = settings.base64_depth;
                            document.getElementById('url-depth').value = settings.url_depth;

                        } else {
                            console.error('åŠ è½½è®¾ç½®å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åŠ è½½è®¾ç½®é”™è¯¯:', error);
                    }

                    // æ·»åŠ æ»‘å—äº‹ä»¶ç›‘å¬
                    document.getElementById('rule-match-rate').addEventListener('input', function () {
                        document.getElementById('rule-match-rate-value').textContent = this.value + '%';
                    });
                }

        // ä¿å­˜è®¾ç½®
            // ä¿å­˜è®¾ç½®
                async function saveSettings() {
                    try {
                        const settings = {
                            enable_anti_devtools: document.querySelector('input[name="anti-devtools"]:checked').value === 'true',
                            enable_js_obfuscation: document.querySelector('input[name="js-obfuscation"]:checked').value === 'true', // æ–°å¢
                            rule_match_rate: parseInt(document.getElementById('rule-match-rate').value),
                            base64_depth: parseInt(document.getElementById('base64-depth').value),
                            url_depth: parseInt(document.getElementById('url-depth').value)
                        };

                        // éªŒè¯è¾“å…¥
                        if (settings.rule_match_rate < 0 || settings.rule_match_rate > 100) {
                            showMessage('è§„åˆ™åŒ¹é…ç‡å¿…é¡»åœ¨0-100ä¹‹é—´', 'error');
                            return;
                        }
                        if (settings.base64_depth < 0 || settings.base64_depth > 10) {
                            showMessage('Base64è§£ç æ·±åº¦å¿…é¡»åœ¨0-10ä¹‹é—´', 'error');
                            return;
                        }
                        if (settings.url_depth < 0 || settings.url_depth > 10) {
                            showMessage('URLè§£ç æ·±åº¦å¿…é¡»åœ¨0-10ä¹‹é—´', 'error');
                            return;
                        }

                        const response = await fetch('/api/settings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify(settings)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            showMessage(result.message || 'è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
                        } else {
                            const error = await response.text();
                            showMessage('ä¿å­˜å¤±è´¥: ' + error, 'error');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜è®¾ç½®é”™è¯¯:', error);
                        showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    }
                }

        // æ¨¡æ€æ¡†åŠŸèƒ½
        function showModal() {
            document.getElementById('modal').style.display = 'flex';
            // ç¡®ä¿å…³é—­æŒ‰é’®å¯ä»¥å·¥ä½œ
            const closeBtn = document.querySelector('.close-modal');
            if (closeBtn) {
                closeBtn.onclick = closeModal;
            }
        }

        // åŠ è½½CCè§„åˆ™
            async function loadCCRules() {
                try {
                    const response = await fetch('/api/cc/rules', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        displayCCRules(data.rules);
                    } else {
                        document.getElementById('cc-rules-container').innerHTML = '<div class="alert alert-error">åŠ è½½CCè§„åˆ™å¤±è´¥</div>';
                    }
                } catch (error) {
                    console.error('åŠ è½½CCè§„åˆ™é”™è¯¯:', error);
                    document.getElementById('cc-rules-container').innerHTML = '<div class="alert alert-error">åŠ è½½CCè§„åˆ™å¤±è´¥</div>';
                }
            }

            // æ˜¾ç¤ºCCè§„åˆ™
            function displayCCRules(rules) {
    const container = document.getElementById('cc-rules-container');

    if (!rules || rules.length === 0) {
        container.innerHTML = '<div class="alert">æš‚æ— CCè§„åˆ™</div>';
        return;
    }

    // åˆ†é¡µå¤„ç†
    const pageSize = 10;
    const totalPages = Math.ceil(rules.length / pageSize);
    const currentPage = 1;
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const displayRules = rules.slice(startIndex, endIndex);

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åç§°</th>
                        <th>åŸŸå</th>
                        <th>è·¯å¾„</th>
                        <th>é¢‘ç‡é™åˆ¶</th>
                        <th>æ—¶é—´çª—å£</th>
                        <th>åŠ¨ä½œ</th>
                        <th>çŠ¶æ€</th>
                        <th>æè¿°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;

    displayRules.forEach(rule => {
        html += `
            <tr>
                <td>${rule.id}</td>
                <td title="${rule.name}">${rule.name.length > 15 ? rule.name.substring(0, 15) + '...' : rule.name}</td>
                <td title="${rule.domain}">${rule.domain.length > 15 ? rule.domain.substring(0, 15) + '...' : rule.domain}</td>
                <td title="${rule.path || 'å…¨éƒ¨'}">${rule.path ? (rule.path.length > 15 ? rule.path.substring(0, 15) + '...' : rule.path) : 'å…¨éƒ¨'}</td>
                <td>${rule.rate_limit} æ¬¡</td>
                <td>${rule.time_window} ç§’</td>
                <td>
                    <span class="status-indicator ${rule.action === 'block' ? 'status-inactive' : 'status-active'}">
                        ${rule.action === 'block' ? 'æ‹¦æˆª' : 'æŒ‘æˆ˜'}
                    </span>
                </td>
                <td>
                    <span class="status-indicator ${rule.enabled ? 'status-active' : 'status-inactive'} clickable" 
                          onclick="toggleCCRuleStatus(${rule.id}, ${!rule.enabled})"
                          title="ç‚¹å‡»åˆ‡æ¢çŠ¶æ€">
                        ${rule.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                    </span>
                </td>
                <td title="${rule.description || 'æ— æè¿°'}">
                    ${rule.description ? (rule.description.length > 15 ? rule.description.substring(0, 15) + '...' : rule.description) : '-'}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn" onclick="showEditCCRuleModal(${rule.id})">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteCCRule(${rule.id})">åˆ é™¤</button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="pagination-info">
            æ˜¾ç¤º 1-${displayRules.length} æ¡ï¼Œå…± ${rules.length} æ¡CCè§„åˆ™
        </div>
    `;

    container.innerHTML = html;
}

            // æ˜¾ç¤ºæ·»åŠ CCè§„åˆ™æ¨¡æ€æ¡†
            function showAddCCRuleModal() {
                document.getElementById('modal-title').textContent = 'æ·»åŠ CCè§„åˆ™';
                document.getElementById('modal-body').innerHTML = `
        <form id="add-cc-form">
            <div class="form-group">
                <label class="form-label">è§„åˆ™åç§°</label>
                <input type="text" name="name" class="form-control" placeholder="ä¾‹å¦‚: ç™»å½•æ¥å£é˜²æŠ¤" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">åº”ç”¨åŸŸå</label>
                <input type="text" name="domain" class="form-control" placeholder="ä¾‹å¦‚: example.com æˆ– * (å…¨éƒ¨åŸŸå)" required>
                <small style="color: #666;">ä½¿ç”¨ * è¡¨ç¤ºæ‰€æœ‰åŸŸå</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">è·¯å¾„æ¨¡å¼</label>
                <input type="text" name="path" class="form-control" placeholder="ä¾‹å¦‚: /login æˆ–ç•™ç©ºè¡¨ç¤ºå…¨éƒ¨è·¯å¾„">
                <small style="color: #666;">ä½¿ç”¨é€šé…ç¬¦åŒ¹é…è·¯å¾„ï¼Œç•™ç©ºè¡¨ç¤ºæ‰€æœ‰è·¯å¾„</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">é¢‘ç‡é™åˆ¶</label>
                <input type="number" name="rate_limit" class="form-control" placeholder="ä¾‹å¦‚: 10" min="1" required>
                <small style="color: #666;">åœ¨æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ¬¡æ•°</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ—¶é—´çª—å£ (ç§’)</label>
                <input type="number" name="time_window" class="form-control" placeholder="ä¾‹å¦‚: 60" min="1" required>
                <small style="color: #666;">ç»Ÿè®¡è¯·æ±‚æ¬¡æ•°çš„æ—¶é—´çª—å£</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">é˜²æŠ¤åŠ¨ä½œ</label>
                <select name="action" class="form-control" required>
                    <option value="block">æ‹¦æˆªè¯·æ±‚</option>
                    <option value="challenge">æŒ‘æˆ˜éªŒè¯</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">è§„åˆ™æè¿°</label>
                <textarea name="description" class="form-control" placeholder="è§„åˆ™æè¿°ä¿¡æ¯"></textarea>
            </div>
            
            <div class="form-group">
                <label style="display: inline-flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="enabled" checked> å¯ç”¨è§„åˆ™
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn">æ·»åŠ è§„åˆ™</button>
            </div>
        </form>
    `;

                document.getElementById('add-cc-form').addEventListener('submit', function (e) {
                    e.preventDefault();
                    addCCRule(new FormData(this));
                });

                showModal();
            }

            // æ·»åŠ CCè§„åˆ™
            async function addCCRule(formData) {
                try {
                    const data = Object.fromEntries(formData);
                    data.enabled = data.enabled === 'on';
                    data.rate_limit = parseInt(data.rate_limit);
                    data.time_window = parseInt(data.time_window);

                    const response = await fetch('/api/cc/rules', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        closeModal();
                        showMessage('CCè§„åˆ™æ·»åŠ æˆåŠŸ', 'success');
                        loadCCRules();
                    } else {
                        const error = await response.text();
                        showMessage('æ·»åŠ å¤±è´¥: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('æ·»åŠ CCè§„åˆ™é”™è¯¯:', error);
                    showMessage('æ·»åŠ å¤±è´¥', 'error');
                }
            }

            // æ˜¾ç¤ºç¼–è¾‘CCè§„åˆ™æ¨¡æ€æ¡†
            async function showEditCCRuleModal(ruleId) {
                try {
                    const response = await fetch('/api/cc/rules', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const rule = data.rules.find(r => r.id === ruleId);

                        if (rule) {
                            document.getElementById('modal-title').textContent = 'ç¼–è¾‘CCè§„åˆ™';
                            document.getElementById('modal-body').innerHTML = `
                    <form id="edit-cc-form">
                        <input type="hidden" name="id" value="${rule.id}">
                        <div class="form-group">
                            <label class="form-label">è§„åˆ™åç§°</label>
                            <input type="text" name="name" class="form-control" value="${rule.name}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">åº”ç”¨åŸŸå</label>
                            <input type="text" name="domain" class="form-control" value="${rule.domain}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">è·¯å¾„æ¨¡å¼</label>
                            <input type="text" name="path" class="form-control" value="${rule.path || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">é¢‘ç‡é™åˆ¶</label>
                            <input type="number" name="rate_limit" class="form-control" value="${rule.rate_limit}" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">æ—¶é—´çª—å£ (ç§’)</label>
                            <input type="number" name="time_window" class="form-control" value="${rule.time_window}" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">é˜²æŠ¤åŠ¨ä½œ</label>
                            <select name="action" class="form-control" required>
                                <option value="block" ${rule.action === 'block' ? 'selected' : ''}>æ‹¦æˆªè¯·æ±‚</option>
                                <option value="challenge" ${rule.action === 'challenge' ? 'selected' : ''}>æŒ‘æˆ˜éªŒè¯</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">è§„åˆ™æè¿°</label>
                            <textarea name="description" class="form-control">${rule.description || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: inline-flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="enabled" ${rule.enabled ? 'checked' : ''}> å¯ç”¨è§„åˆ™
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                            <button type="submit" class="btn">æ›´æ–°è§„åˆ™</button>
                        </div>
                    </form>
                `;

                            document.getElementById('edit-cc-form').addEventListener('submit', function (e) {
                                e.preventDefault();
                                updateCCRule(new FormData(this));
                            });

                            showModal();
                        } else {
                            showMessage('è§„åˆ™ä¸å­˜åœ¨', 'error');
                        }
                    } else {
                        showMessage('åŠ è½½è§„åˆ™å¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('åŠ è½½è§„åˆ™é”™è¯¯:', error);
                    showMessage('åŠ è½½è§„åˆ™å¤±è´¥', 'error');
                }
            }

            // æ›´æ–°CCè§„åˆ™
            async function updateCCRule(formData) {
                try {
                    const data = Object.fromEntries(formData);
                    data.enabled = data.enabled === 'on';
                    data.rate_limit = parseInt(data.rate_limit);
                    data.time_window = parseInt(data.time_window);

                    const response = await fetch(`/api/cc/rules/${data.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        closeModal();
                        showMessage('CCè§„åˆ™æ›´æ–°æˆåŠŸ', 'success');
                        loadCCRules();
                    } else {
                        const error = await response.text();
                        showMessage('æ›´æ–°å¤±è´¥: ' + error, 'error');
                    }
                } catch (error) {
                    console.error('æ›´æ–°CCè§„åˆ™é”™è¯¯:', error);
                    showMessage('æ›´æ–°å¤±è´¥', 'error');
                }
            }

            // åˆ‡æ¢CCè§„åˆ™çŠ¶æ€
            async function toggleCCRuleStatus(ruleId, enabled) {
                const action = enabled ? 'å¯ç”¨' : 'ç¦ç”¨';

                if (!confirm(`ç¡®å®šè¦${action}è¿™æ¡CCè§„åˆ™å—ï¼Ÿ`)) return;

                try {
                    // è¿™é‡Œéœ€è¦å…ˆè·å–è§„åˆ™è¯¦æƒ…ï¼Œç„¶åæ›´æ–°çŠ¶æ€
                    const response = await fetch('/api/cc/rules', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const rule = data.rules.find(r => r.id === ruleId);

                        if (rule) {
                            const updateData = {
                                name: rule.name,
                                domain: rule.domain,
                                path: rule.path,
                                rate_limit: rule.rate_limit,
                                time_window: rule.time_window,
                                action: rule.action,
                                enabled: enabled,
                                description: rule.description
                            };

                            const updateResponse = await fetch(`/api/cc/rules/${ruleId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'include',
                                body: JSON.stringify(updateData)
                            });

                            if (updateResponse.ok) {
                                showMessage(`CCè§„åˆ™${action}æˆåŠŸ`, 'success');
                                loadCCRules();
                            } else {
                                showMessage(`${action}å¤±è´¥`, 'error');
                            }
                        }
                    }
                } catch (error) {
                    console.error(`${action}CCè§„åˆ™é”™è¯¯:`, error);
                    showMessage(`${action}å¤±è´¥`, 'error');
                }
            }

            // åˆ é™¤CCè§„åˆ™
            async function deleteCCRule(id) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡CCè§„åˆ™å—ï¼Ÿ')) return;

                try {
                    const response = await fetch(`/api/cc/rules/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        showMessage('CCè§„åˆ™åˆ é™¤æˆåŠŸ', 'success');
                        loadCCRules();
                    } else {
                        showMessage('åˆ é™¤å¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('åˆ é™¤CCè§„åˆ™é”™è¯¯:', error);
                    showMessage('åˆ é™¤å¤±è´¥', 'error');
                }
            }

            // åŠ è½½CCç»Ÿè®¡
            async function loadCCStats() {
                try {
                    const response = await fetch('/api/cc/stats', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const stats = await response.json();
                        displayCCStats(stats);
                    } else {
                        document.getElementById('cc-stats-container').innerHTML = '<div class="alert alert-error">åŠ è½½CCç»Ÿè®¡å¤±è´¥</div>';
                    }
                } catch (error) {
                    console.error('åŠ è½½CCç»Ÿè®¡é”™è¯¯:', error);
                    document.getElementById('cc-stats-container').innerHTML = '<div class="alert alert-error">åŠ è½½CCç»Ÿè®¡å¤±è´¥</div>';
                }
            }

            // æ˜¾ç¤ºCCç»Ÿè®¡
            function displayCCStats(stats) {
                const container = document.getElementById('cc-stats-container');

                container.innerHTML = `
        <div class="metric-row">
            <div class="metric-card">
                <div class="metric-icon">ğŸš«</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.total_blocked}</div>
                    <div class="metric-label">æ€»æ‹¦æˆªæ¬¡æ•°</div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">ğŸ“…</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.today_blocked}</div>
                    <div class="metric-label">ä»Šæ—¥æ‹¦æˆª</div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">âš¡</div>
                <div class="metric-content">
                    <div class="metric-value">${stats.active_attacks}</div>
                    <div class="metric-label">æ´»è·ƒæ”»å‡»</div>
                </div>
            </div>
        </div>
        
        ${stats.top_blocked_ips && stats.top_blocked_ips.length > 0 ? `
        <div style="margin-top: 20px;">
            <h4 style="color: #5210ed; margin-bottom: 15px;">æœ€å¸¸è¢«æ‹¦æˆªçš„IP</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>IPåœ°å€</th>
                            <th>æ‹¦æˆªæ¬¡æ•°</th>
                            <th>æœ€åå‡ºç°</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.top_blocked_ips.map(ip => `
                            <tr>
                                <td>${ip.ip}</td>
                                <td>${ip.count}</td>
                                <td>${ip.last_seen}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        ` : ''}
        
        ${stats.rule_stats && stats.rule_stats.length > 0 ? `
        <div style="margin-top: 20px;">
            <h4 style="color: #5210ed; margin-bottom: 15px;">è§„åˆ™æ‹¦æˆªç»Ÿè®¡</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>è§„åˆ™åç§°</th>
                            <th>è§„åˆ™ID</th>
                            <th>æ‹¦æˆªæ¬¡æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.rule_stats.map(rule => `
                            <tr>
                                <td>${rule.rule_name}</td>
                                <td>${rule.rule_id}</td>
                                <td>${rule.blocked}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        ` : ''}
    `;
            }

            // åŠ è½½CCæ”»å‡»æ—¥å¿—
            async function loadCCAttackLogs(page) {
                try {
                    currentCCLogsPage = page;

                    const params = new URLSearchParams({
                        page: page,
                        page_size: currentCCLogsPageSize
                    });

                    // æ·»åŠ ç­›é€‰æ¡ä»¶
                    const clientIP = document.getElementById('cc-client-ip-filter');
                    const domain = document.getElementById('cc-domain-filter');
                    const ruleId = document.getElementById('cc-rule-id-filter');
                    const startDate = document.getElementById('cc-start-date');
                    const endDate = document.getElementById('cc-end-date');

                    if (clientIP && clientIP.value) params.append('client_ip', clientIP.value);
                    if (domain && domain.value) params.append('domain', domain.value);
                    if (ruleId && ruleId.value) params.append('rule_id', ruleId.value);
                    if (startDate && startDate.value) params.append('start_time', startDate.value);
                    if (endDate && endDate.value) params.append('end_time', endDate.value);

                    const response = await fetch(`/api/cc/logs?${params}`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        displayCCAttackLogs(data);
                    } else {
                        document.getElementById('cc-logs-container').innerHTML = '<div class="alert alert-error">åŠ è½½CCæ”»å‡»æ—¥å¿—å¤±è´¥</div>';
                    }
                } catch (error) {
                    console.error('åŠ è½½CCæ”»å‡»æ—¥å¿—é”™è¯¯:', error);
                    document.getElementById('cc-logs-container').innerHTML = '<div class="alert alert-error">åŠ è½½CCæ”»å‡»æ—¥å¿—å¤±è´¥</div>';
                }
            }

            // æ˜¾ç¤ºCCæ”»å‡»æ—¥å¿—
            function displayCCAttackLogs(data) {
    const container = document.getElementById('cc-logs-container');
    currentCCLogsTotal = data.total;

    if (!data.logs || data.logs.length === 0) {
        container.innerHTML = '<div class="alert">æš‚æ— CCæ”»å‡»æ—¥å¿—</div>';
        document.getElementById('cc-logs-pagination').innerHTML = '';
        return;
    }

    let html = `
        <div class="table-scroll-container">
            <table>
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>å®¢æˆ·ç«¯IP</th>
                        <th>åŸŸå</th>
                        <th>è·¯å¾„</th>
                        <th>è§„åˆ™åç§°</th>
                        <th>è¯·æ±‚æ¬¡æ•°</th>
                        <th>æ‰§è¡ŒåŠ¨ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;

    data.logs.forEach(log => {
        html += `
            <tr>
                <td>${log.created_at}</td>
                <td>${log.client_ip}</td>
                <td title="${log.domain}">${log.domain.length > 15 ? log.domain.substring(0, 15) + '...' : log.domain}</td>
                <td title="${log.path || 'å…¨éƒ¨'}">${log.path ? (log.path.length > 15 ? log.path.substring(0, 15) + '...' : log.path) : 'å…¨éƒ¨'}</td>
                <td title="${log.rule_name}">${log.rule_name.length > 15 ? log.rule_name.substring(0, 15) + '...' : log.rule_name}</td>
                <td>${log.count}</td>
                <td>
                    <span class="status-indicator ${log.action === 'block' ? 'status-inactive' : 'status-active'}">
                        ${log.action === 'block' ? 'æ‹¦æˆª' : 'æŒ‘æˆ˜'}
                    </span>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;

    // æ˜¾ç¤ºåˆ†é¡µ
    displayCCPagination(data.total, data.page_size, data.page);
}

            // æ˜¾ç¤ºCCåˆ†é¡µ
            function displayCCPagination(total, pageSize, currentPage) {
                const totalPages = Math.ceil(total / pageSize);
                const pagination = document.getElementById('cc-logs-pagination');

                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let html = '';

                // ä¸Šä¸€é¡µ
                if (currentPage > 1) {
                    html += `<button class="page-btn" onclick="loadCCAttackLogs(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
                }

                // é¡µç 
                for (let i = 1; i <= totalPages; i++) {
                    if (i === currentPage) {
                        html += `<button class="page-btn active">${i}</button>`;
                    } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        html += `<button class="page-btn" onclick="loadCCAttackLogs(${i})">${i}</button>`;
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        html += `<span class="page-btn">...</span>`;
                    }
                }

                // ä¸‹ä¸€é¡µ
                if (currentPage < totalPages) {
                    html += `<button class="page-btn" onclick="loadCCAttackLogs(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
                }

                pagination.innerHTML = html;
            }

            // æ¸…ç©ºCCè®¡æ•°å™¨
            async function clearCCCounters() {
                if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰CCè®¡æ•°å™¨å—ï¼Ÿè¿™å°†é‡ç½®æ‰€æœ‰IPçš„è¯·æ±‚è®¡æ•°ã€‚')) return;

                try {
                    const response = await fetch('/api/cc/clear-counters', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        showMessage('CCè®¡æ•°å™¨å·²æ¸…ç©º', 'success');
                        loadCCStats();
                    } else {
                        showMessage('æ¸…ç©ºè®¡æ•°å™¨å¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('æ¸…ç©ºCCè®¡æ•°å™¨é”™è¯¯:', error);
                    showMessage('æ¸…ç©ºè®¡æ•°å™¨å¤±è´¥', 'error');
                }
            }

            // åˆ·æ–°CCç»Ÿè®¡
            function refreshCCStats() {
                loadCCStats();
                loadCCAttackLogs(1);
            }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // æ¶ˆæ¯æç¤º
        function showMessage(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            document.getElementById('content-container').insertBefore(alert, document.getElementById('content-container').firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (body.classList.contains('dark-theme')) {
                // åˆ‡æ¢åˆ°æ˜äº®ä¸»é¢˜
                body.classList.remove('dark-theme');
                themeIcon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
            } else {
                // åˆ‡æ¢åˆ°æš—é»‘ä¸»é¢˜
                body.classList.add('dark-theme');
                themeIcon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            }
        }

        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme === 'dark') {
                body.classList.add('dark-theme');
                if (themeIcon) {
                    themeIcon.textContent = 'â˜€ï¸';
                }
            } else {
                body.classList.remove('dark-theme');
                if (themeIcon) {
                    themeIcon.textContent = 'ğŸŒ™';
                }
            }
        }

        // åˆå§‹åŒ–
        // åœ¨åˆå§‹åŒ–éƒ¨åˆ†ä¿®æ”¹å®šæ—¶åˆ·æ–°
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½ä¸»é¢˜ï¼ˆåœ¨æ£€æŸ¥ç™»å½•ä¹‹å‰ï¼Œå› ä¸ºä¸»é¢˜åº”è¯¥åœ¨æ‰€æœ‰é¡µé¢éƒ½ç”Ÿæ•ˆï¼‰
    loadTheme();
    
    // æ£€æŸ¥æ˜¯å¦åœ¨ç™»å½•é¡µé¢ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡åˆå§‹åŒ–
    if (window.location.pathname.includes('login') || document.querySelector('.login-box')) {
        return;
    }
    
    // åˆå§‹åŒ–æ¨¡æ€æ¡†å…³é—­åŠŸèƒ½
    document.querySelector('.close-modal').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    // åŠ è½½ç¬¬ä¸€ä¸ªé¡µé¢
    loadPage('dashboard');

    // æ¯3ç§’è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®ï¼ˆæ•°æ®æ¦‚è§ˆé¡µé¢ï¼‰
    setInterval(() => {
        if (currentPage === 'dashboard') {
            loadStats();
        }
    }, 3000);

    // åˆå§‹åŠ è½½å¥åº·çŠ¶æ€
    console.log('åˆå§‹åŒ–ï¼šå¼€å§‹åŠ è½½å¥åº·çŠ¶æ€');
    loadSiteHealthStatus();
    console.log('åˆå§‹åŒ–ï¼šå¥åº·çŠ¶æ€åŠ è½½å‡½æ•°å·²è°ƒç”¨');
});

        // å…¨å±€å˜é‡å­˜å‚¨ä¸Šä¸€æ¬¡çš„æ•°æ®
            let previousStats = {
                    total_requests: 0,
                    blocked_requests: 0,
                    total_sites: 0,
                    alive_sites: 0
                };
            // CCè§„åˆ™ç®¡ç†å‡½æ•°
                let currentCCLogsPage = 1;
                let currentCCLogsPageSize = 20;
                let currentCCLogsTotal = 0;
            
            // å­˜å‚¨å±•å¼€çš„ä¸Šæ¸¸æœåŠ¡å™¨è¯¦æƒ…ç«™ç‚¹ID
            let expandedUpstreamSites = new Set();
    </script>
</body>

</html>